<!doctype html><html lang=en class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="AI-powered movie recommendation system - Complete learning reference"><meta name=author content="Movie Genie Team"><link href=https://your-username.github.io/movie-genie/machine-learning/evaluation/ rel=canonical><link href=../semantic-search/ rel=prev><link href=../../backend-frontend/backend-integration/ rel=next><link rel=icon href=../../assets/favicon.ico><meta name=generator content="mkdocs-1.6.1, mkdocs-material-9.6.20"><title>Model Evaluation - Movie Genie Documentation</title><link rel=stylesheet href=../../assets/stylesheets/main.e53b48f4.min.css><link rel=stylesheet href=../../assets/stylesheets/palette.06af60db.min.css><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback"><style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style><link rel=stylesheet href=../../stylesheets/extra.css><script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script><script id=__analytics>function __md_analytics(){function e(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],e("js",new Date),e("config",""),document.addEventListener("DOMContentLoaded",(function(){document.forms.search&&document.forms.search.query.addEventListener("blur",(function(){this.value&&e("event","search",{search_term:this.value})}));document$.subscribe((function(){var t=document.forms.feedback;if(void 0!==t)for(var a of t.querySelectorAll("[type=submit]"))a.addEventListener("click",(function(a){a.preventDefault();var n=document.location.pathname,d=this.getAttribute("data-md-value");e("event","feedback",{page:n,data:d}),t.firstElementChild.disabled=!0;var r=t.querySelector(".md-feedback__note [data-md-value='"+d+"']");r&&(r.hidden=!1)})),t.hidden=!1})),location$.subscribe((function(t){e("config","",{page_path:t.pathname})}))}));var t=document.createElement("script");t.async=!0,t.src="https://www.googletagmanager.com/gtag/js?id=",document.getElementById("__analytics").insertAdjacentElement("afterEnd",t)}</script><script>"undefined"!=typeof __md_analytics&&__md_analytics()</script></head> <body dir=ltr data-md-color-scheme=default data-md-color-primary=indigo data-md-color-accent=indigo> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#understanding-what-were-actually-trying-to-measure class=md-skip> Skip to content </a> </div> <div data-md-component=announce> </div> <header class="md-header md-header--shadow md-header--lifted" data-md-component=header> <nav class="md-header__inner md-grid" aria-label=Header> <a href=../.. title="Movie Genie Documentation" class="md-header__button md-logo" aria-label="Movie Genie Documentation" data-md-component=logo> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="m18 4 2 4h-3l-2-4h-2l2 4h-3l-2-4H8l2 4H7L5 4H4a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V4z"/></svg> </a> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> Movie Genie Documentation </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> Model Evaluation </span> </div> </div> </div> <form class=md-header__option data-md-component=palette> <input class=md-option data-md-color-media data-md-color-scheme=default data-md-color-primary=indigo data-md-color-accent=indigo aria-label="Switch to dark mode" type=radio name=__palette id=__palette_0> <label class="md-header__button md-icon" title="Switch to dark mode" for=__palette_1 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg> </label> <input class=md-option data-md-color-media data-md-color-scheme=slate data-md-color-primary=indigo data-md-color-accent=indigo aria-label="Switch to light mode" type=radio name=__palette id=__palette_1> <label class="md-header__button md-icon" title="Switch to light mode" for=__palette_0 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg> </label> </form> <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=Search placeholder=Search autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg> </label> <nav class=md-search__options aria-label=Search> <a href=javascript:void(0) class="md-search__icon md-icon" title=Share aria-label=Share data-clipboard data-clipboard-text data-md-component=search-share tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91s2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08"/></svg> </a> <button type=reset class="md-search__icon md-icon" title=Clear aria-label=Clear tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg> </button> </nav> <div class=md-search__suggest data-md-component=search-suggest></div> </form> <div class=md-search__output> <div class=md-search__scrollwrap tabindex=0 data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> Initializing search </div> <ol class=md-search-result__list role=presentation></ol> </div> </div> </div> </div> </div> <div class=md-header__source> <a href=https://github.com/your-username/movie-genie title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg> </div> <div class=md-source__repository> movie-genie </div> </a> </div> </nav> <nav class=md-tabs aria-label=Tabs data-md-component=tabs> <div class=md-grid> <ul class=md-tabs__list> <li class=md-tabs__item> <a href=../.. class=md-tabs__link> Home </a> </li> <li class=md-tabs__item> <a href=../../getting-started/ class=md-tabs__link> Getting Started </a> </li> <li class="md-tabs__item md-tabs__item--active"> <a href=../index.md class=md-tabs__link> Machine Learning </a> </li> <li class=md-tabs__item> <a href=../../data-pipeline/index.md class=md-tabs__link> Data Pipeline </a> </li> <li class=md-tabs__item> <a href=../../backend-frontend/index.md class=md-tabs__link> Backend & Frontend </a> </li> <li class=md-tabs__item> <a href=../../deployment/index.md class=md-tabs__link> Deployment </a> </li> <li class=md-tabs__item> <a href=../../configuration/index.md class=md-tabs__link> Configuration </a> </li> <li class=md-tabs__item> <a href=../../troubleshooting/index.md class=md-tabs__link> Troubleshooting </a> </li> <li class=md-tabs__item> <a href=../../reference/index.md class=md-tabs__link> Reference </a> </li> </ul> </div> </nav> </header> <div class=md-container data-md-component=container> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary md-nav--lifted" aria-label=Navigation data-md-level=0> <label class=md-nav__title for=__drawer> <a href=../.. title="Movie Genie Documentation" class="md-nav__button md-logo" aria-label="Movie Genie Documentation" data-md-component=logo> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="m18 4 2 4h-3l-2-4h-2l2 4h-3l-2-4H8l2 4H7L5 4H4a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V4z"/></svg> </a> Movie Genie Documentation </label> <div class=md-nav__source> <a href=https://github.com/your-username/movie-genie title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg> </div> <div class=md-source__repository> movie-genie </div> </a> </div> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../.. class=md-nav__link> <span class=md-ellipsis> Home </span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../getting-started/ class=md-nav__link> <span class=md-ellipsis> Getting Started </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_3 checked> <label class=md-nav__link for=__nav_3 id=__nav_3_label tabindex> <span class=md-ellipsis> Machine Learning </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_3_label aria-expanded=true> <label class=md-nav__title for=__nav_3> <span class="md-nav__icon md-icon"></span> Machine Learning </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../index.md class=md-nav__link> <span class=md-ellipsis> None </span> </a> </li> <li class=md-nav__item> <a href=../models-overview/ class=md-nav__link> <span class=md-ellipsis> Models Overview </span> </a> </li> <li class=md-nav__item> <a href=../bert4rec/ class=md-nav__link> <span class=md-ellipsis> BERT4Rec </span> </a> </li> <li class=md-nav__item> <a href=../two-tower.md class=md-nav__link> <span class=md-ellipsis> Two-Tower </span> </a> </li> <li class=md-nav__item> <a href=../semantic-search/ class=md-nav__link> <span class=md-ellipsis> Semantic Search </span> </a> </li> <li class="md-nav__item md-nav__item--active"> <input class="md-nav__toggle md-toggle" type=checkbox id=__toc> <label class="md-nav__link md-nav__link--active" for=__toc> <span class=md-ellipsis> Model Evaluation </span> <span class="md-nav__icon md-icon"></span> </label> <a href=./ class="md-nav__link md-nav__link--active"> <span class=md-ellipsis> Model Evaluation </span> </a> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#understanding-what-were-actually-trying-to-measure class=md-nav__link> <span class=md-ellipsis> Understanding What We're Actually Trying to Measure </span> </a> </li> <li class=md-nav__item> <a href=#the-cascade-effect-challenge class=md-nav__link> <span class=md-ellipsis> The Cascade Effect Challenge </span> </a> </li> <li class=md-nav__item> <a href=#designing-evaluation-that-captures-system-behavior class=md-nav__link> <span class=md-ellipsis> Designing Evaluation That Captures System Behavior </span> </a> </li> <li class=md-nav__item> <a href=#understanding-the-metrics-that-matter class=md-nav__link> <span class=md-ellipsis> Understanding the Metrics That Matter </span> </a> </li> <li class=md-nav__item> <a href=#analyzing-ranking-changes-to-understand-sequential-value class=md-nav__link> <span class=md-ellipsis> Analyzing Ranking Changes to Understand Sequential Value </span> </a> </li> <li class=md-nav__item> <a href=#interpreting-system-level-performance-patterns class=md-nav__link> <span class=md-ellipsis> Interpreting System-Level Performance Patterns </span> </a> </li> <li class=md-nav__item> <a href=#diagnostic-capabilities-for-system-improvement class=md-nav__link> <span class=md-ellipsis> Diagnostic Capabilities for System Improvement </span> </a> </li> <li class=md-nav__item> <a href=#integrated-recommendation-system-evaluation-mathematical-foundations-and-implementation class=md-nav__link> <span class=md-ellipsis> Integrated Recommendation System Evaluation: Mathematical Foundations and Implementation </span> </a> <nav class=md-nav aria-label="Integrated Recommendation System Evaluation: Mathematical Foundations and Implementation"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#mathematical-foundation-of-cascade-effects class=md-nav__link> <span class=md-ellipsis> Mathematical Foundation of Cascade Effects </span> </a> </li> <li class=md-nav__item> <a href=#mathematical-framework-for-multi-level-performance-measurement class=md-nav__link> <span class=md-ellipsis> Mathematical Framework for Multi-Level Performance Measurement </span> </a> </li> <li class=md-nav__item> <a href=#mathematical-analysis-of-ranking-changes class=md-nav__link> <span class=md-ellipsis> Mathematical Analysis of Ranking Changes </span> </a> </li> <li class=md-nav__item> <a href=#implementation-of-diagnostic-analysis-framework class=md-nav__link> <span class=md-ellipsis> Implementation of Diagnostic Analysis Framework </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../data-pipeline/index.md class=md-nav__link> <span class=md-ellipsis> Data Pipeline </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../backend-frontend/index.md class=md-nav__link> <span class=md-ellipsis> Backend & Frontend </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../deployment/index.md class=md-nav__link> <span class=md-ellipsis> Deployment </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../configuration/index.md class=md-nav__link> <span class=md-ellipsis> Configuration </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../troubleshooting/index.md class=md-nav__link> <span class=md-ellipsis> Troubleshooting </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../reference/index.md class=md-nav__link> <span class=md-ellipsis> Reference </span> <span class="md-nav__icon md-icon"></span> </a> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=sidebar data-md-type=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#understanding-what-were-actually-trying-to-measure class=md-nav__link> <span class=md-ellipsis> Understanding What We're Actually Trying to Measure </span> </a> </li> <li class=md-nav__item> <a href=#the-cascade-effect-challenge class=md-nav__link> <span class=md-ellipsis> The Cascade Effect Challenge </span> </a> </li> <li class=md-nav__item> <a href=#designing-evaluation-that-captures-system-behavior class=md-nav__link> <span class=md-ellipsis> Designing Evaluation That Captures System Behavior </span> </a> </li> <li class=md-nav__item> <a href=#understanding-the-metrics-that-matter class=md-nav__link> <span class=md-ellipsis> Understanding the Metrics That Matter </span> </a> </li> <li class=md-nav__item> <a href=#analyzing-ranking-changes-to-understand-sequential-value class=md-nav__link> <span class=md-ellipsis> Analyzing Ranking Changes to Understand Sequential Value </span> </a> </li> <li class=md-nav__item> <a href=#interpreting-system-level-performance-patterns class=md-nav__link> <span class=md-ellipsis> Interpreting System-Level Performance Patterns </span> </a> </li> <li class=md-nav__item> <a href=#diagnostic-capabilities-for-system-improvement class=md-nav__link> <span class=md-ellipsis> Diagnostic Capabilities for System Improvement </span> </a> </li> <li class=md-nav__item> <a href=#integrated-recommendation-system-evaluation-mathematical-foundations-and-implementation class=md-nav__link> <span class=md-ellipsis> Integrated Recommendation System Evaluation: Mathematical Foundations and Implementation </span> </a> <nav class=md-nav aria-label="Integrated Recommendation System Evaluation: Mathematical Foundations and Implementation"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#mathematical-foundation-of-cascade-effects class=md-nav__link> <span class=md-ellipsis> Mathematical Foundation of Cascade Effects </span> </a> </li> <li class=md-nav__item> <a href=#mathematical-framework-for-multi-level-performance-measurement class=md-nav__link> <span class=md-ellipsis> Mathematical Framework for Multi-Level Performance Measurement </span> </a> </li> <li class=md-nav__item> <a href=#mathematical-analysis-of-ranking-changes class=md-nav__link> <span class=md-ellipsis> Mathematical Analysis of Ranking Changes </span> </a> </li> <li class=md-nav__item> <a href=#implementation-of-diagnostic-analysis-framework class=md-nav__link> <span class=md-ellipsis> Implementation of Diagnostic Analysis Framework </span> </a> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <article class="md-content__inner md-typeset"> <a href=https://github.com/your-username/movie-genie/edit/main/docs/machine-learning/evaluation.md title="Edit this page" class="md-content__button md-icon" rel=edit> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M10 20H6V4h7v5h5v3.1l2-2V8l-6-6H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h4zm10.2-7c.1 0 .3.1.4.2l1.3 1.3c.2.2.2.6 0 .8l-1 1-2.1-2.1 1-1c.1-.1.2-.2.4-.2m0 3.9L14.1 23H12v-2.1l6.1-6.1z"/></svg> </a> <a href=https://github.com/your-username/movie-genie/raw/main/docs/machine-learning/evaluation.md title="View source of this page" class="md-content__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M17 18c.56 0 1 .44 1 1s-.44 1-1 1-1-.44-1-1 .44-1 1-1m0-3c-2.73 0-5.06 1.66-6 4 .94 2.34 3.27 4 6 4s5.06-1.66 6-4c-.94-2.34-3.27-4-6-4m0 6.5a2.5 2.5 0 0 1-2.5-2.5 2.5 2.5 0 0 1 2.5-2.5 2.5 2.5 0 0 1 2.5 2.5 2.5 2.5 0 0 1-2.5 2.5M9.27 20H6V4h7v5h5v4.07c.7.08 1.36.25 2 .49V8l-6-6H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h4.5a8.2 8.2 0 0 1-1.23-2"/></svg> </a> <p>You're absolutely right to call this out. Let me explain the integrated evaluation from a conceptual foundation upward, because evaluating a two-stage recommendation system presents fundamentally different challenges than evaluating a single model.</p> <h2 id=understanding-what-were-actually-trying-to-measure>Understanding What We're Actually Trying to Measure<a class=headerlink href=#understanding-what-were-actually-trying-to-measure title="Permanent link">&para;</a></h2> <p>When you evaluate a single machine learning model, you typically ask straightforward questions: How accurately does it predict labels? How well does it generalize to unseen data? But when you evaluate an integrated recommendation system, you're asking much more complex questions that don't have simple answers.</p> <p>The fundamental challenge lies in understanding that your integrated system isn't just performing one task - it's performing two different but interdependent tasks that must work together harmoniously. Your two-tower model performs candidate retrieval, asking "which movies from our entire catalog might this user find interesting?" Your BERT4Rec model performs candidate ranking, asking "given these potentially interesting movies, which specific ordering will maximize user satisfaction?"</p> <p>Think about what this means for evaluation. You could have a two-tower model that achieves excellent retrieval performance and a BERT4Rec model that demonstrates superior ranking capabilities, but if they don't complement each other effectively, your users will receive poor recommendations. Conversely, you might have individual models that seem mediocre in isolation but work together beautifully to create outstanding user experiences.</p> <p>This interdependency creates evaluation challenges that don't exist for single-model systems. How do you separate retrieval problems from ranking problems when analyzing poor recommendations? How do you measure whether the sophisticated sequential modeling in BERT4Rec actually improves recommendations enough to justify its computational complexity? How do you determine optimal candidate set sizes that balance retrieval coverage with ranking effectiveness?</p> <h2 id=the-cascade-effect-challenge>The Cascade Effect Challenge<a class=headerlink href=#the-cascade-effect-challenge title="Permanent link">&para;</a></h2> <p>Let me help you understand why integrated evaluation becomes so complex by walking through what I call the "cascade effect" in two-stage recommendation systems. Every decision made by your two-tower model directly constrains what your BERT4Rec model can accomplish.</p> <p>Imagine your two-tower model generates candidates for a user who loves Christopher Nolan films. If the two-tower model fails to include "Inception" in its top 100 candidates, then no amount of sophisticated sequential modeling by BERT4Rec can recommend "Inception" to that user. The ranking stage cannot fix fundamental retrieval failures.</p> <p>This cascade relationship means that evaluation metrics can be misleading if you examine them independently. Suppose your BERT4Rec model achieves impressive ranking performance when evaluated on artificial candidate sets that include relevant items. But if your two-tower model rarely generates candidate sets that contain those relevant items, the real-world performance of your integrated system will disappoint users despite the ranking model's apparent sophistication.</p> <p>The cascade effect also works in reverse. Your two-tower model might generate excellent candidate sets that include many movies the user would enjoy, but if BERT4Rec consistently ranks them poorly due to sequential modeling failures, users will see irrelevant recommendations at the top of their lists. The retrieval stage's success gets undermined by ranking stage failures.</p> <p>Understanding this cascade relationship becomes crucial for interpreting evaluation results. When your integrated system performs poorly, you need diagnostic approaches that help you identify whether the problem originates in candidate generation, candidate ranking, or the interaction between these stages.</p> <h2 id=designing-evaluation-that-captures-system-behavior>Designing Evaluation That Captures System Behavior<a class=headerlink href=#designing-evaluation-that-captures-system-behavior title="Permanent link">&para;</a></h2> <p>The integrated evaluation process must capture both individual component performance and emergent system behavior that arises from their interaction. This requires thinking carefully about what questions you want the evaluation to answer and designing metrics that provide actionable insights.</p> <p>The evaluation process begins by establishing ground truth about user preferences from your held-out test data. For each test user, you identify movies they actually rated positively in your temporal test split. These represent the "correct answers" that your integrated system should ideally recommend.</p> <p>The evaluation then simulates the complete recommendation pipeline for each test user. Your two-tower model generates candidate sets of varying sizes, and BERT4Rec ranks these candidates using the user's interaction history up to the temporal split point. This simulation mirrors exactly what happens during real recommendation serving.</p> <p>The key insight involves measuring performance at multiple levels of the system simultaneously. You measure retrieval performance by examining whether relevant items appear anywhere in the candidate sets generated by the two-tower model. You measure ranking performance by examining whether BERT4Rec places relevant items at the top of the reranked lists. You measure integrated performance by examining the final recommendations that users would actually see.</p> <p>Let me walk you through how this multi-level measurement works in practice. Consider a test user who loved "Interstellar" during the test period. The evaluation traces this example through your system:</p> <p>First, the two-tower model generates 100 candidates for this user. The evaluation records whether "Interstellar" appears anywhere in these 100 candidates. If it doesn't appear, you've identified a retrieval failure. If it appears at position 87, you know the two-tower model recognized some relevance but didn't prioritize it highly.</p> <p>Next, BERT4Rec ranks these 100 candidates using the user's sequence history. The evaluation records whether "Interstellar" moves up or down in the rankings. If BERT4Rec moves it from position 87 to position 3, this indicates that sequential modeling provided valuable signals that pure collaborative filtering missed.</p> <p>Finally, the evaluation examines the top 10 final recommendations that the user would see. Whether "Interstellar" appears in these top 10 positions determines whether your integrated system would successfully recommend this relevant movie to the user.</p> <h2 id=understanding-the-metrics-that-matter>Understanding the Metrics That Matter<a class=headerlink href=#understanding-the-metrics-that-matter title="Permanent link">&para;</a></h2> <p>The integrated evaluation produces several types of metrics that each illuminate different aspects of system performance. Understanding what each metric tells you helps you diagnose problems and guide improvements.</p> <p>Coverage metrics measure how much of your movie catalog the system actually recommends across all users. Low coverage suggests that your system focuses too heavily on popular mainstream content, potentially creating filter bubbles where users only see obvious choices. High coverage indicates that your system can surface diverse content, enabling discovery of niche films that might delight specific users.</p> <p>But coverage metrics must be interpreted carefully in the context of your two-stage architecture. If your two-tower model generates diverse candidate sets but BERT4Rec consistently ranks the same popular movies at the top, you might observe high candidate coverage but low final recommendation coverage. This pattern would suggest that your ranking stage needs improvement rather than your retrieval stage.</p> <p>Recall metrics measure what fraction of movies that users actually enjoyed appear somewhere in your recommendations. Recall at different cutoff points reveals how candidate set size affects system performance. You might discover that increasing candidate sets from 50 to 100 movies significantly improves recall, but expanding from 100 to 200 provides minimal benefits. This insight helps you optimize the computational trade-offs in your system.</p> <p>The evaluation also measures ranking correlation between your two-tower and BERT4Rec orderings. High correlation suggests that sequential modeling reinforces collaborative filtering patterns, potentially indicating redundancy. Low correlation suggests that BERT4Rec discovers different preference signals than your two-tower model, potentially indicating complementary value.</p> <h2 id=analyzing-ranking-changes-to-understand-sequential-value>Analyzing Ranking Changes to Understand Sequential Value<a class=headerlink href=#analyzing-ranking-changes-to-understand-sequential-value title="Permanent link">&para;</a></h2> <p>One of the most insightful aspects of integrated evaluation involves analyzing how BERT4Rec reorders the candidates from your two-tower model. This analysis reveals whether sequential modeling provides meaningful improvements over pure collaborative filtering or simply adds computational complexity without corresponding benefits.</p> <p>The evaluation tracks every movie that appears in both the two-tower ranking and the BERT4Rec ranking, computing how much each movie's position changes. Movies that move significantly upward in the BERT4Rec ranking represent cases where sequential context provided valuable signals that collaborative filtering missed.</p> <p>Consider a concrete example that illustrates this analysis. Your two-tower model might rank "Ghost in the Shell" at position 45 for a user based on general science fiction preferences. But BERT4Rec, seeing that the user recently watched "Blade Runner" and "Ex Machina," might move "Ghost in the Shell" to position 8 based on the clear sequential pattern of cyberpunk exploration.</p> <p>The evaluation quantifies these ranking changes across all users and movies, providing statistics like average rank improvement, percentage of movies that moved up versus down, and correlation between the original and reranked orderings. These statistics help you understand whether BERT4Rec consistently provides value or only helps in specific circumstances.</p> <p>The analysis becomes particularly revealing when you examine which types of movies benefit most from sequential reranking. You might discover that BERT4Rec significantly improves rankings for movies in niche genres where collaborative filtering provides weak signals, but provides minimal improvements for mainstream blockbusters where collaborative patterns are strong.</p> <h2 id=interpreting-system-level-performance-patterns>Interpreting System-Level Performance Patterns<a class=headerlink href=#interpreting-system-level-performance-patterns title="Permanent link">&para;</a></h2> <p>The integrated evaluation reveals system-level patterns that help you understand how your architecture performs across different types of users and scenarios. These patterns guide both immediate improvements and longer-term architectural decisions.</p> <p>User analysis reveals how system performance varies based on interaction history characteristics. Users with longer, more consistent viewing histories might benefit significantly from BERT4Rec's sequential modeling, while users with sparse or erratic viewing patterns might receive minimal improvements from the ranking stage. Understanding these patterns helps you identify when to apply sophisticated modeling versus when simpler approaches suffice.</p> <p>The evaluation also reveals temporal patterns in how ranking changes affect recommendation quality. You might discover that BERT4Rec provides substantial improvements for users who are currently in exploration phases, trying new genres or themes, but provides minimal improvements for users who are in exploitation phases, repeatedly watching similar content.</p> <p>Content analysis shows which types of movies benefit most from your integrated approach. New releases might see significant ranking improvements when BERT4Rec uses content features to identify thematic connections with user sequences. Niche art films might benefit from sequential understanding that recognizes sophisticated user taste development over time.</p> <h2 id=diagnostic-capabilities-for-system-improvement>Diagnostic Capabilities for System Improvement<a class=headerlink href=#diagnostic-capabilities-for-system-improvement title="Permanent link">&para;</a></h2> <p>The integrated evaluation provides diagnostic capabilities that help you identify specific areas for improvement rather than just overall performance scores. This diagnostic power becomes essential for iterative system development.</p> <p>When the evaluation reveals poor performance for specific users, you can trace through the recommendation pipeline to identify failure points. Maybe the two-tower model generates reasonable candidates, but BERT4Rec ranks them poorly due to insufficient sequence length. Maybe BERT4Rec would rank effectively, but the two-tower model fails to include relevant items in the candidate set.</p> <p>The evaluation can reveal systematic biases in your system performance. Perhaps your integrated approach works well for users who watch mainstream Hollywood films but fails for users who prefer international cinema. Perhaps the system excels at recommending within established genres but struggles with cross-genre recommendations.</p> <p>These diagnostic insights guide targeted improvements rather than general architecture changes. You might discover that improving your two-tower model's content feature integration would have larger impact than sophisticated BERT4Rec architecture modifications. Or you might find that BERT4Rec's attention mechanisms need refinement while your retrieval stage performs adequately.</p> <p>This comprehensive understanding of integrated evaluation helps you move beyond simple performance metrics toward deep insight into how your recommendation system behaves, why it succeeds or fails in specific circumstances, and where to focus development efforts for maximum impact on user satisfaction.</p> <h1 id=integrated-recommendation-system-evaluation-mathematical-foundations-and-implementation>Integrated Recommendation System Evaluation: Mathematical Foundations and Implementation<a class=headerlink href=#integrated-recommendation-system-evaluation-mathematical-foundations-and-implementation title="Permanent link">&para;</a></h1> <p>Understanding how to evaluate your two-stage recommendation system requires building mathematical frameworks that capture the complex interactions between retrieval and ranking. Let me walk you through the theoretical foundations alongside the concrete implementation details that make this evaluation both rigorous and actionable.</p> <h2 id=mathematical-foundation-of-cascade-effects>Mathematical Foundation of Cascade Effects<a class=headerlink href=#mathematical-foundation-of-cascade-effects title="Permanent link">&para;</a></h2> <p>The fundamental challenge in evaluating integrated systems stems from what we can formalize as the cascade dependency problem. Your system's final performance depends on a composition of functions that cannot be evaluated independently.</p> <p>Let's define this mathematically. Your two-tower model performs a retrieval function:</p> <div class=arithmatex>\[\mathcal{R}(u) = \text{TopK}(\{(i, s_{ui}^{(2T)}) \mid i \in \mathcal{I}\}, k)\]</div> <p>where <span class=arithmatex>\(s_{ui}^{(2T)}\)</span> represents the two-tower compatibility score between user <span class=arithmatex>\(u\)</span> and item <span class=arithmatex>\(i\)</span>, and <span class=arithmatex>\(\mathcal{I}\)</span> represents your complete item catalog. This function returns the top-k candidates based on two-tower scoring.</p> <p>Your BERT4Rec model then performs a ranking function over these candidates:</p> <div class=arithmatex>\[\mathcal{B}(u, \mathcal{C}_u) = \text{Rank}(\{(i, s_{ui}^{(B4R)}) \mid i \in \mathcal{C}_u\})\]</div> <p>where <span class=arithmatex>\(\mathcal{C}_u = \mathcal{R}(u)\)</span> represents the candidate set from the two-tower model, and <span class=arithmatex>\(s_{ui}^{(B4R)}\)</span> represents the BERT4Rec ranking score.</p> <p>The final recommendation function becomes:</p> <div class=arithmatex>\[\text{Recommend}(u, n) = \text{TopN}(\mathcal{B}(u, \mathcal{R}(u)), n)\]</div> <p>This mathematical composition creates the cascade dependency. The domain of function <span class=arithmatex>\(\mathcal{B}\)</span> is entirely determined by the output of function <span class=arithmatex>\(\mathcal{R}\)</span>. If <span class=arithmatex>\(\mathcal{R}(u)\)</span> fails to include relevant items in <span class=arithmatex>\(\mathcal{C}_u\)</span>, then <span class=arithmatex>\(\mathcal{B}\)</span> cannot recover from this failure regardless of its sophistication.</p> <p>Here's how we implement this cascade evaluation in code:</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-0-1><a id=__codelineno-0-1 name=__codelineno-0-1 href=#__codelineno-0-1></a><span class=k>def</span><span class=w> </span><span class=nf>evaluate_cascade_effect</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>user_idx</span><span class=p>:</span> <span class=nb>int</span><span class=p>,</span> <span class=n>ground_truth_items</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=nb>int</span><span class=p>],</span> 
</span><span id=__span-0-2><a id=__codelineno-0-2 name=__codelineno-0-2 href=#__codelineno-0-2></a>                           <span class=n>k_values</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=nb>int</span><span class=p>]</span> <span class=o>=</span> <span class=p>[</span><span class=mi>50</span><span class=p>,</span> <span class=mi>100</span><span class=p>,</span> <span class=mi>200</span><span class=p>])</span> <span class=o>-&gt;</span> <span class=n>Dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>Any</span><span class=p>]:</span>
</span><span id=__span-0-3><a id=__codelineno-0-3 name=__codelineno-0-3 href=#__codelineno-0-3></a><span class=w>    </span><span class=sd>&quot;&quot;&quot;</span>
</span><span id=__span-0-4><a id=__codelineno-0-4 name=__codelineno-0-4 href=#__codelineno-0-4></a><span class=sd>    Evaluate how cascade effects propagate through the two-stage system.</span>
</span><span id=__span-0-5><a id=__codelineno-0-5 name=__codelineno-0-5 href=#__codelineno-0-5></a>
</span><span id=__span-0-6><a id=__codelineno-0-6 name=__codelineno-0-6 href=#__codelineno-0-6></a><span class=sd>    This function traces a specific user&#39;s recommendations through both stages,</span>
</span><span id=__span-0-7><a id=__codelineno-0-7 name=__codelineno-0-7 href=#__codelineno-0-7></a><span class=sd>    measuring how retrieval failures affect ranking performance and vice versa.</span>
</span><span id=__span-0-8><a id=__codelineno-0-8 name=__codelineno-0-8 href=#__codelineno-0-8></a><span class=sd>    The mathematical analysis quantifies the cascade dependency between stages.</span>
</span><span id=__span-0-9><a id=__codelineno-0-9 name=__codelineno-0-9 href=#__codelineno-0-9></a>
</span><span id=__span-0-10><a id=__codelineno-0-10 name=__codelineno-0-10 href=#__codelineno-0-10></a><span class=sd>    Args:</span>
</span><span id=__span-0-11><a id=__codelineno-0-11 name=__codelineno-0-11 href=#__codelineno-0-11></a><span class=sd>        user_idx: Index of user for cascade analysis</span>
</span><span id=__span-0-12><a id=__codelineno-0-12 name=__codelineno-0-12 href=#__codelineno-0-12></a><span class=sd>        ground_truth_items: Movies the user actually liked in test data</span>
</span><span id=__span-0-13><a id=__codelineno-0-13 name=__codelineno-0-13 href=#__codelineno-0-13></a><span class=sd>        k_values: Different candidate set sizes to analyze</span>
</span><span id=__span-0-14><a id=__codelineno-0-14 name=__codelineno-0-14 href=#__codelineno-0-14></a>
</span><span id=__span-0-15><a id=__codelineno-0-15 name=__codelineno-0-15 href=#__codelineno-0-15></a><span class=sd>    Returns:</span>
</span><span id=__span-0-16><a id=__codelineno-0-16 name=__codelineno-0-16 href=#__codelineno-0-16></a><span class=sd>        Detailed analysis of cascade effects and stage interactions</span>
</span><span id=__span-0-17><a id=__codelineno-0-17 name=__codelineno-0-17 href=#__codelineno-0-17></a><span class=sd>    &quot;&quot;&quot;</span>
</span><span id=__span-0-18><a id=__codelineno-0-18 name=__codelineno-0-18 href=#__codelineno-0-18></a>    <span class=n>cascade_analysis</span> <span class=o>=</span> <span class=p>{</span>
</span><span id=__span-0-19><a id=__codelineno-0-19 name=__codelineno-0-19 href=#__codelineno-0-19></a>        <span class=s1>&#39;user_idx&#39;</span><span class=p>:</span> <span class=n>user_idx</span><span class=p>,</span>
</span><span id=__span-0-20><a id=__codelineno-0-20 name=__codelineno-0-20 href=#__codelineno-0-20></a>        <span class=s1>&#39;ground_truth_count&#39;</span><span class=p>:</span> <span class=nb>len</span><span class=p>(</span><span class=n>ground_truth_items</span><span class=p>),</span>
</span><span id=__span-0-21><a id=__codelineno-0-21 name=__codelineno-0-21 href=#__codelineno-0-21></a>        <span class=s1>&#39;cascade_metrics&#39;</span><span class=p>:</span> <span class=p>{}</span>
</span><span id=__span-0-22><a id=__codelineno-0-22 name=__codelineno-0-22 href=#__codelineno-0-22></a>    <span class=p>}</span>
</span><span id=__span-0-23><a id=__codelineno-0-23 name=__codelineno-0-23 href=#__codelineno-0-23></a>
</span><span id=__span-0-24><a id=__codelineno-0-24 name=__codelineno-0-24 href=#__codelineno-0-24></a>    <span class=k>for</span> <span class=n>k</span> <span class=ow>in</span> <span class=n>k_values</span><span class=p>:</span>
</span><span id=__span-0-25><a id=__codelineno-0-25 name=__codelineno-0-25 href=#__codelineno-0-25></a>        <span class=c1># Stage 1: Two-tower candidate generation</span>
</span><span id=__span-0-26><a id=__codelineno-0-26 name=__codelineno-0-26 href=#__codelineno-0-26></a>        <span class=c1># Measure retrieval effectiveness at different candidate set sizes</span>
</span><span id=__span-0-27><a id=__codelineno-0-27 name=__codelineno-0-27 href=#__codelineno-0-27></a>        <span class=n>candidates</span><span class=p>,</span> <span class=n>retrieval_scores</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>generate_two_tower_candidates</span><span class=p>(</span><span class=n>user_idx</span><span class=p>,</span> <span class=n>k</span><span class=p>)</span>
</span><span id=__span-0-28><a id=__codelineno-0-28 name=__codelineno-0-28 href=#__codelineno-0-28></a>
</span><span id=__span-0-29><a id=__codelineno-0-29 name=__codelineno-0-29 href=#__codelineno-0-29></a>        <span class=c1># Calculate retrieval metrics: how many relevant items reached ranking stage?</span>
</span><span id=__span-0-30><a id=__codelineno-0-30 name=__codelineno-0-30 href=#__codelineno-0-30></a>        <span class=n>retrieved_relevant</span> <span class=o>=</span> <span class=nb>set</span><span class=p>(</span><span class=n>candidates</span><span class=p>)</span><span class=o>.</span><span class=n>intersection</span><span class=p>(</span><span class=nb>set</span><span class=p>(</span><span class=n>ground_truth_items</span><span class=p>))</span>
</span><span id=__span-0-31><a id=__codelineno-0-31 name=__codelineno-0-31 href=#__codelineno-0-31></a>        <span class=n>retrieval_recall</span> <span class=o>=</span> <span class=nb>len</span><span class=p>(</span><span class=n>retrieved_relevant</span><span class=p>)</span> <span class=o>/</span> <span class=nb>len</span><span class=p>(</span><span class=n>ground_truth_items</span><span class=p>)</span> <span class=k>if</span> <span class=n>ground_truth_items</span> <span class=k>else</span> <span class=mi>0</span>
</span><span id=__span-0-32><a id=__codelineno-0-32 name=__codelineno-0-32 href=#__codelineno-0-32></a>
</span><span id=__span-0-33><a id=__codelineno-0-33 name=__codelineno-0-33 href=#__codelineno-0-33></a>        <span class=c1># Stage 2: BERT4Rec ranking of retrieved candidates</span>
</span><span id=__span-0-34><a id=__codelineno-0-34 name=__codelineno-0-34 href=#__codelineno-0-34></a>        <span class=c1># Only items that survived retrieval can be ranked effectively</span>
</span><span id=__span-0-35><a id=__codelineno-0-35 name=__codelineno-0-35 href=#__codelineno-0-35></a>        <span class=n>user_sequence</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>bert4rec_data_loader</span><span class=o>.</span><span class=n>user_sequences</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>user_idx</span><span class=p>,</span> <span class=p>[])</span>
</span><span id=__span-0-36><a id=__codelineno-0-36 name=__codelineno-0-36 href=#__codelineno-0-36></a>        <span class=n>ranked_candidates</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>rank_candidates_with_bert4rec</span><span class=p>(</span><span class=n>user_idx</span><span class=p>,</span> <span class=n>candidates</span><span class=p>,</span> <span class=n>user_sequence</span><span class=p>)</span>
</span><span id=__span-0-37><a id=__codelineno-0-37 name=__codelineno-0-37 href=#__codelineno-0-37></a>
</span><span id=__span-0-38><a id=__codelineno-0-38 name=__codelineno-0-38 href=#__codelineno-0-38></a>        <span class=c1># Calculate ranking metrics: how well did BERT4Rec order the retrieved candidates?</span>
</span><span id=__span-0-39><a id=__codelineno-0-39 name=__codelineno-0-39 href=#__codelineno-0-39></a>        <span class=n>top_10_recommendations</span> <span class=o>=</span> <span class=p>[</span><span class=n>idx</span> <span class=k>for</span> <span class=n>idx</span><span class=p>,</span> <span class=n>score</span> <span class=ow>in</span> <span class=n>ranked_candidates</span><span class=p>[:</span><span class=mi>10</span><span class=p>]]</span>
</span><span id=__span-0-40><a id=__codelineno-0-40 name=__codelineno-0-40 href=#__codelineno-0-40></a>        <span class=n>final_relevant</span> <span class=o>=</span> <span class=nb>set</span><span class=p>(</span><span class=n>top_10_recommendations</span><span class=p>)</span><span class=o>.</span><span class=n>intersection</span><span class=p>(</span><span class=nb>set</span><span class=p>(</span><span class=n>ground_truth_items</span><span class=p>))</span>
</span><span id=__span-0-41><a id=__codelineno-0-41 name=__codelineno-0-41 href=#__codelineno-0-41></a>        <span class=n>final_recall</span> <span class=o>=</span> <span class=nb>len</span><span class=p>(</span><span class=n>final_relevant</span><span class=p>)</span> <span class=o>/</span> <span class=nb>len</span><span class=p>(</span><span class=n>ground_truth_items</span><span class=p>)</span> <span class=k>if</span> <span class=n>ground_truth_items</span> <span class=k>else</span> <span class=mi>0</span>
</span><span id=__span-0-42><a id=__codelineno-0-42 name=__codelineno-0-42 href=#__codelineno-0-42></a>
</span><span id=__span-0-43><a id=__codelineno-0-43 name=__codelineno-0-43 href=#__codelineno-0-43></a>        <span class=c1># Cascade effect analysis: measure impact of retrieval on ranking</span>
</span><span id=__span-0-44><a id=__codelineno-0-44 name=__codelineno-0-44 href=#__codelineno-0-44></a>        <span class=c1># This is the key mathematical insight - ranking is bounded by retrieval</span>
</span><span id=__span-0-45><a id=__codelineno-0-45 name=__codelineno-0-45 href=#__codelineno-0-45></a>        <span class=n>max_possible_final_recall</span> <span class=o>=</span> <span class=nb>len</span><span class=p>(</span><span class=n>retrieved_relevant</span><span class=p>)</span> <span class=o>/</span> <span class=nb>len</span><span class=p>(</span><span class=n>ground_truth_items</span><span class=p>)</span> <span class=k>if</span> <span class=n>ground_truth_items</span> <span class=k>else</span> <span class=mi>0</span>
</span><span id=__span-0-46><a id=__codelineno-0-46 name=__codelineno-0-46 href=#__codelineno-0-46></a>        <span class=n>ranking_efficiency</span> <span class=o>=</span> <span class=n>final_recall</span> <span class=o>/</span> <span class=n>max_possible_final_recall</span> <span class=k>if</span> <span class=n>max_possible_final_recall</span> <span class=o>&gt;</span> <span class=mi>0</span> <span class=k>else</span> <span class=mi>0</span>
</span><span id=__span-0-47><a id=__codelineno-0-47 name=__codelineno-0-47 href=#__codelineno-0-47></a>
</span><span id=__span-0-48><a id=__codelineno-0-48 name=__codelineno-0-48 href=#__codelineno-0-48></a>        <span class=c1># Compute stage-specific performance bounds</span>
</span><span id=__span-0-49><a id=__codelineno-0-49 name=__codelineno-0-49 href=#__codelineno-0-49></a>        <span class=n>cascade_metrics</span> <span class=o>=</span> <span class=p>{</span>
</span><span id=__span-0-50><a id=__codelineno-0-50 name=__codelineno-0-50 href=#__codelineno-0-50></a>            <span class=s1>&#39;candidate_set_size&#39;</span><span class=p>:</span> <span class=n>k</span><span class=p>,</span>
</span><span id=__span-0-51><a id=__codelineno-0-51 name=__codelineno-0-51 href=#__codelineno-0-51></a>            <span class=s1>&#39;retrieval_recall&#39;</span><span class=p>:</span> <span class=n>retrieval_recall</span><span class=p>,</span>          <span class=c1># P(relevant item in candidates)</span>
</span><span id=__span-0-52><a id=__codelineno-0-52 name=__codelineno-0-52 href=#__codelineno-0-52></a>            <span class=s1>&#39;max_possible_final_recall&#39;</span><span class=p>:</span> <span class=n>max_possible_final_recall</span><span class=p>,</span>  <span class=c1># Upper bound for ranking</span>
</span><span id=__span-0-53><a id=__codelineno-0-53 name=__codelineno-0-53 href=#__codelineno-0-53></a>            <span class=s1>&#39;final_recall&#39;</span><span class=p>:</span> <span class=n>final_recall</span><span class=p>,</span>                  <span class=c1># P(relevant item in top-10)</span>
</span><span id=__span-0-54><a id=__codelineno-0-54 name=__codelineno-0-54 href=#__codelineno-0-54></a>            <span class=s1>&#39;ranking_efficiency&#39;</span><span class=p>:</span> <span class=n>ranking_efficiency</span><span class=p>,</span>      <span class=c1># How well ranking used available candidates</span>
</span><span id=__span-0-55><a id=__codelineno-0-55 name=__codelineno-0-55 href=#__codelineno-0-55></a>            <span class=s1>&#39;cascade_loss&#39;</span><span class=p>:</span> <span class=n>max_possible_final_recall</span> <span class=o>-</span> <span class=n>final_recall</span><span class=p>,</span>  <span class=c1># Performance lost to ranking</span>
</span><span id=__span-0-56><a id=__codelineno-0-56 name=__codelineno-0-56 href=#__codelineno-0-56></a>            <span class=s1>&#39;retrieval_loss&#39;</span><span class=p>:</span> <span class=mf>1.0</span> <span class=o>-</span> <span class=n>max_possible_final_recall</span><span class=p>,</span>        <span class=c1># Performance lost to retrieval</span>
</span><span id=__span-0-57><a id=__codelineno-0-57 name=__codelineno-0-57 href=#__codelineno-0-57></a>        <span class=p>}</span>
</span><span id=__span-0-58><a id=__codelineno-0-58 name=__codelineno-0-58 href=#__codelineno-0-58></a>
</span><span id=__span-0-59><a id=__codelineno-0-59 name=__codelineno-0-59 href=#__codelineno-0-59></a>        <span class=n>cascade_analysis</span><span class=p>[</span><span class=s1>&#39;cascade_metrics&#39;</span><span class=p>][</span><span class=sa>f</span><span class=s1>&#39;k_</span><span class=si>{</span><span class=n>k</span><span class=si>}</span><span class=s1>&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>cascade_metrics</span>
</span><span id=__span-0-60><a id=__codelineno-0-60 name=__codelineno-0-60 href=#__codelineno-0-60></a>
</span><span id=__span-0-61><a id=__codelineno-0-61 name=__codelineno-0-61 href=#__codelineno-0-61></a>    <span class=k>return</span> <span class=n>cascade_analysis</span>
</span></code></pre></div> <p>This implementation demonstrates the mathematical relationship between stages. The <code>max_possible_final_recall</code> represents the theoretical upper bound on ranking performance given the retrieval results. The <code>cascade_loss</code> quantifies how much performance the ranking stage sacrificed, while <code>retrieval_loss</code> quantifies the fundamental constraints imposed by the retrieval stage.</p> <h2 id=mathematical-framework-for-multi-level-performance-measurement>Mathematical Framework for Multi-Level Performance Measurement<a class=headerlink href=#mathematical-framework-for-multi-level-performance-measurement title="Permanent link">&para;</a></h2> <p>To understand system behavior comprehensively, we need mathematical frameworks that measure performance at multiple levels simultaneously. Let's formalize the key metrics that capture different aspects of system effectiveness.</p> <p>The fundamental insight involves recognizing that traditional single-model metrics like accuracy or F1-score don't capture the multi-objective nature of recommendation systems. We need metrics that measure both individual component performance and emergent system behavior.</p> <p>Define the set of relevant items for user <span class=arithmatex>\(u\)</span> as:</p> <div class=arithmatex>\[\mathcal{G}_u = \{i \in \mathcal{I} \mid r_{ui} \geq \tau\}\]</div> <p>where <span class=arithmatex>\(\tau\)</span> represents our relevance threshold (e.g., thumbs up rating of 1.0).</p> <p>Our retrieval recall at candidate set size <span class=arithmatex>\(k\)</span> becomes:</p> <div class=arithmatex>\[\text{Recall}_{\text{retrieval}}@k = \frac{|\mathcal{R}(u) \cap \mathcal{G}_u|}{|\mathcal{G}_u|}\]</div> <p>Our final recommendation recall at cutoff <span class=arithmatex>\(n\)</span> becomes:</p> <div class=arithmatex>\[\text{Recall}_{\text{final}}@n = \frac{|\text{TopN}(\mathcal{B}(u, \mathcal{R}(u)), n) \cap \mathcal{G}_u|}{|\mathcal{G}_u|}\]</div> <p>The ranking effectiveness can be measured through the gain ratio:</p> <div class=arithmatex>\[\text{Ranking Gain} = \frac{\text{Recall}_{\text{final}}@n}{\text{Recall}_{\text{retrieval}}@k}\]</div> <p>This ratio indicates how effectively the ranking stage utilizes the candidates provided by retrieval. A ratio close to 1.0 suggests that BERT4Rec successfully places relevant items at the top of candidate lists.</p> <p>Here's the implementation of this multi-level measurement framework:</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-1-1><a id=__codelineno-1-1 name=__codelineno-1-1 href=#__codelineno-1-1></a><span class=k>def</span><span class=w> </span><span class=nf>compute_multi_level_metrics</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>test_users</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=nb>int</span><span class=p>],</span> 
</span><span id=__span-1-2><a id=__codelineno-1-2 name=__codelineno-1-2 href=#__codelineno-1-2></a>                               <span class=n>candidate_k</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>100</span><span class=p>,</span> <span class=n>final_n</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>10</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=nb>float</span><span class=p>]:</span>
</span><span id=__span-1-3><a id=__codelineno-1-3 name=__codelineno-1-3 href=#__codelineno-1-3></a><span class=w>    </span><span class=sd>&quot;&quot;&quot;</span>
</span><span id=__span-1-4><a id=__codelineno-1-4 name=__codelineno-1-4 href=#__codelineno-1-4></a><span class=sd>    Compute performance metrics at multiple levels of the integrated system.</span>
</span><span id=__span-1-5><a id=__codelineno-1-5 name=__codelineno-1-5 href=#__codelineno-1-5></a>
</span><span id=__span-1-6><a id=__codelineno-1-6 name=__codelineno-1-6 href=#__codelineno-1-6></a><span class=sd>    This implementation measures retrieval effectiveness, ranking effectiveness,</span>
</span><span id=__span-1-7><a id=__codelineno-1-7 name=__codelineno-1-7 href=#__codelineno-1-7></a><span class=sd>    and integrated system performance using the mathematical frameworks defined above.</span>
</span><span id=__span-1-8><a id=__codelineno-1-8 name=__codelineno-1-8 href=#__codelineno-1-8></a><span class=sd>    The metrics provide actionable insights into where improvements would be most valuable.</span>
</span><span id=__span-1-9><a id=__codelineno-1-9 name=__codelineno-1-9 href=#__codelineno-1-9></a>
</span><span id=__span-1-10><a id=__codelineno-1-10 name=__codelineno-1-10 href=#__codelineno-1-10></a><span class=sd>    Args:</span>
</span><span id=__span-1-11><a id=__codelineno-1-11 name=__codelineno-1-11 href=#__codelineno-1-11></a><span class=sd>        test_users: List of user indices for evaluation</span>
</span><span id=__span-1-12><a id=__codelineno-1-12 name=__codelineno-1-12 href=#__codelineno-1-12></a><span class=sd>        candidate_k: Candidate set size for two-tower retrieval</span>
</span><span id=__span-1-13><a id=__codelineno-1-13 name=__codelineno-1-13 href=#__codelineno-1-13></a><span class=sd>        final_n: Final recommendation list size</span>
</span><span id=__span-1-14><a id=__codelineno-1-14 name=__codelineno-1-14 href=#__codelineno-1-14></a>
</span><span id=__span-1-15><a id=__codelineno-1-15 name=__codelineno-1-15 href=#__codelineno-1-15></a><span class=sd>    Returns:</span>
</span><span id=__span-1-16><a id=__codelineno-1-16 name=__codelineno-1-16 href=#__codelineno-1-16></a><span class=sd>        Dictionary containing multi-level performance metrics</span>
</span><span id=__span-1-17><a id=__codelineno-1-17 name=__codelineno-1-17 href=#__codelineno-1-17></a><span class=sd>    &quot;&quot;&quot;</span>
</span><span id=__span-1-18><a id=__codelineno-1-18 name=__codelineno-1-18 href=#__codelineno-1-18></a>    <span class=c1># Initialize metric accumulators for mathematical aggregation</span>
</span><span id=__span-1-19><a id=__codelineno-1-19 name=__codelineno-1-19 href=#__codelineno-1-19></a>    <span class=n>retrieval_recalls</span> <span class=o>=</span> <span class=p>[]</span>
</span><span id=__span-1-20><a id=__codelineno-1-20 name=__codelineno-1-20 href=#__codelineno-1-20></a>    <span class=n>final_recalls</span> <span class=o>=</span> <span class=p>[]</span>
</span><span id=__span-1-21><a id=__codelineno-1-21 name=__codelineno-1-21 href=#__codelineno-1-21></a>    <span class=n>ranking_gains</span> <span class=o>=</span> <span class=p>[]</span>
</span><span id=__span-1-22><a id=__codelineno-1-22 name=__codelineno-1-22 href=#__codelineno-1-22></a>    <span class=n>coverage_items</span> <span class=o>=</span> <span class=nb>set</span><span class=p>()</span>
</span><span id=__span-1-23><a id=__codelineno-1-23 name=__codelineno-1-23 href=#__codelineno-1-23></a>
</span><span id=__span-1-24><a id=__codelineno-1-24 name=__codelineno-1-24 href=#__codelineno-1-24></a>    <span class=k>for</span> <span class=n>user_idx</span> <span class=ow>in</span> <span class=n>test_users</span><span class=p>:</span>
</span><span id=__span-1-25><a id=__codelineno-1-25 name=__codelineno-1-25 href=#__codelineno-1-25></a>        <span class=c1># Get ground truth for this user from temporal test split</span>
</span><span id=__span-1-26><a id=__codelineno-1-26 name=__codelineno-1-26 href=#__codelineno-1-26></a>        <span class=n>ground_truth</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_get_user_ground_truth</span><span class=p>(</span><span class=n>user_idx</span><span class=p>)</span>
</span><span id=__span-1-27><a id=__codelineno-1-27 name=__codelineno-1-27 href=#__codelineno-1-27></a>
</span><span id=__span-1-28><a id=__codelineno-1-28 name=__codelineno-1-28 href=#__codelineno-1-28></a>        <span class=k>if</span> <span class=ow>not</span> <span class=n>ground_truth</span><span class=p>:</span>
</span><span id=__span-1-29><a id=__codelineno-1-29 name=__codelineno-1-29 href=#__codelineno-1-29></a>            <span class=k>continue</span>  <span class=c1># Skip users without test interactions</span>
</span><span id=__span-1-30><a id=__codelineno-1-30 name=__codelineno-1-30 href=#__codelineno-1-30></a>
</span><span id=__span-1-31><a id=__codelineno-1-31 name=__codelineno-1-31 href=#__codelineno-1-31></a>        <span class=c1># Stage 1: Two-tower candidate generation and retrieval metrics</span>
</span><span id=__span-1-32><a id=__codelineno-1-32 name=__codelineno-1-32 href=#__codelineno-1-32></a>        <span class=n>candidates</span><span class=p>,</span> <span class=n>_</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>generate_two_tower_candidates</span><span class=p>(</span><span class=n>user_idx</span><span class=p>,</span> <span class=n>candidate_k</span><span class=p>)</span>
</span><span id=__span-1-33><a id=__codelineno-1-33 name=__codelineno-1-33 href=#__codelineno-1-33></a>        <span class=n>retrieved_relevant</span> <span class=o>=</span> <span class=nb>set</span><span class=p>(</span><span class=n>candidates</span><span class=p>)</span><span class=o>.</span><span class=n>intersection</span><span class=p>(</span><span class=nb>set</span><span class=p>(</span><span class=n>ground_truth</span><span class=p>))</span>
</span><span id=__span-1-34><a id=__codelineno-1-34 name=__codelineno-1-34 href=#__codelineno-1-34></a>
</span><span id=__span-1-35><a id=__codelineno-1-35 name=__codelineno-1-35 href=#__codelineno-1-35></a>        <span class=c1># Retrieval recall: R_retrieval@k = |C_u ∩ G_u| / |G_u|</span>
</span><span id=__span-1-36><a id=__codelineno-1-36 name=__codelineno-1-36 href=#__codelineno-1-36></a>        <span class=n>retrieval_recall</span> <span class=o>=</span> <span class=nb>len</span><span class=p>(</span><span class=n>retrieved_relevant</span><span class=p>)</span> <span class=o>/</span> <span class=nb>len</span><span class=p>(</span><span class=n>ground_truth</span><span class=p>)</span>
</span><span id=__span-1-37><a id=__codelineno-1-37 name=__codelineno-1-37 href=#__codelineno-1-37></a>        <span class=n>retrieval_recalls</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>retrieval_recall</span><span class=p>)</span>
</span><span id=__span-1-38><a id=__codelineno-1-38 name=__codelineno-1-38 href=#__codelineno-1-38></a>
</span><span id=__span-1-39><a id=__codelineno-1-39 name=__codelineno-1-39 href=#__codelineno-1-39></a>        <span class=c1># Stage 2: BERT4Rec ranking and final metrics</span>
</span><span id=__span-1-40><a id=__codelineno-1-40 name=__codelineno-1-40 href=#__codelineno-1-40></a>        <span class=n>user_sequence</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>bert4rec_data_loader</span><span class=o>.</span><span class=n>user_sequences</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>user_idx</span><span class=p>,</span> <span class=p>[])</span>
</span><span id=__span-1-41><a id=__codelineno-1-41 name=__codelineno-1-41 href=#__codelineno-1-41></a>        <span class=n>ranked_results</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>rank_candidates_with_bert4rec</span><span class=p>(</span><span class=n>user_idx</span><span class=p>,</span> <span class=n>candidates</span><span class=p>,</span> <span class=n>user_sequence</span><span class=p>)</span>
</span><span id=__span-1-42><a id=__codelineno-1-42 name=__codelineno-1-42 href=#__codelineno-1-42></a>
</span><span id=__span-1-43><a id=__codelineno-1-43 name=__codelineno-1-43 href=#__codelineno-1-43></a>        <span class=n>final_recommendations</span> <span class=o>=</span> <span class=p>[</span><span class=n>idx</span> <span class=k>for</span> <span class=n>idx</span><span class=p>,</span> <span class=n>score</span> <span class=ow>in</span> <span class=n>ranked_results</span><span class=p>[:</span><span class=n>final_n</span><span class=p>]]</span>
</span><span id=__span-1-44><a id=__codelineno-1-44 name=__codelineno-1-44 href=#__codelineno-1-44></a>        <span class=n>final_relevant</span> <span class=o>=</span> <span class=nb>set</span><span class=p>(</span><span class=n>final_recommendations</span><span class=p>)</span><span class=o>.</span><span class=n>intersection</span><span class=p>(</span><span class=nb>set</span><span class=p>(</span><span class=n>ground_truth</span><span class=p>))</span>
</span><span id=__span-1-45><a id=__codelineno-1-45 name=__codelineno-1-45 href=#__codelineno-1-45></a>
</span><span id=__span-1-46><a id=__codelineno-1-46 name=__codelineno-1-46 href=#__codelineno-1-46></a>        <span class=c1># Final recall: R_final@n = |Top-N ∩ G_u| / |G_u|</span>
</span><span id=__span-1-47><a id=__codelineno-1-47 name=__codelineno-1-47 href=#__codelineno-1-47></a>        <span class=n>final_recall</span> <span class=o>=</span> <span class=nb>len</span><span class=p>(</span><span class=n>final_relevant</span><span class=p>)</span> <span class=o>/</span> <span class=nb>len</span><span class=p>(</span><span class=n>ground_truth</span><span class=p>)</span>
</span><span id=__span-1-48><a id=__codelineno-1-48 name=__codelineno-1-48 href=#__codelineno-1-48></a>        <span class=n>final_recalls</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>final_recall</span><span class=p>)</span>
</span><span id=__span-1-49><a id=__codelineno-1-49 name=__codelineno-1-49 href=#__codelineno-1-49></a>
</span><span id=__span-1-50><a id=__codelineno-1-50 name=__codelineno-1-50 href=#__codelineno-1-50></a>        <span class=c1># Ranking effectiveness: how well did BERT4Rec utilize available candidates?</span>
</span><span id=__span-1-51><a id=__codelineno-1-51 name=__codelineno-1-51 href=#__codelineno-1-51></a>        <span class=c1># Ranking gain = (R_final@n) / (R_retrieval@k) when R_retrieval@k &gt; 0</span>
</span><span id=__span-1-52><a id=__codelineno-1-52 name=__codelineno-1-52 href=#__codelineno-1-52></a>        <span class=k>if</span> <span class=n>retrieval_recall</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>:</span>
</span><span id=__span-1-53><a id=__codelineno-1-53 name=__codelineno-1-53 href=#__codelineno-1-53></a>            <span class=n>ranking_gain</span> <span class=o>=</span> <span class=n>final_recall</span> <span class=o>/</span> <span class=n>retrieval_recall</span>
</span><span id=__span-1-54><a id=__codelineno-1-54 name=__codelineno-1-54 href=#__codelineno-1-54></a>            <span class=n>ranking_gains</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>ranking_gain</span><span class=p>)</span>
</span><span id=__span-1-55><a id=__codelineno-1-55 name=__codelineno-1-55 href=#__codelineno-1-55></a>
</span><span id=__span-1-56><a id=__codelineno-1-56 name=__codelineno-1-56 href=#__codelineno-1-56></a>        <span class=c1># Coverage analysis: track diversity of recommended items</span>
</span><span id=__span-1-57><a id=__codelineno-1-57 name=__codelineno-1-57 href=#__codelineno-1-57></a>        <span class=n>coverage_items</span><span class=o>.</span><span class=n>update</span><span class=p>(</span><span class=n>final_recommendations</span><span class=p>)</span>
</span><span id=__span-1-58><a id=__codelineno-1-58 name=__codelineno-1-58 href=#__codelineno-1-58></a>
</span><span id=__span-1-59><a id=__codelineno-1-59 name=__codelineno-1-59 href=#__codelineno-1-59></a>    <span class=c1># Aggregate metrics across all test users using mathematical averages</span>
</span><span id=__span-1-60><a id=__codelineno-1-60 name=__codelineno-1-60 href=#__codelineno-1-60></a>    <span class=n>metrics</span> <span class=o>=</span> <span class=p>{</span>
</span><span id=__span-1-61><a id=__codelineno-1-61 name=__codelineno-1-61 href=#__codelineno-1-61></a>        <span class=s1>&#39;avg_retrieval_recall&#39;</span><span class=p>:</span> <span class=n>np</span><span class=o>.</span><span class=n>mean</span><span class=p>(</span><span class=n>retrieval_recalls</span><span class=p>),</span>
</span><span id=__span-1-62><a id=__codelineno-1-62 name=__codelineno-1-62 href=#__codelineno-1-62></a>        <span class=s1>&#39;avg_final_recall&#39;</span><span class=p>:</span> <span class=n>np</span><span class=o>.</span><span class=n>mean</span><span class=p>(</span><span class=n>final_recalls</span><span class=p>),</span> 
</span><span id=__span-1-63><a id=__codelineno-1-63 name=__codelineno-1-63 href=#__codelineno-1-63></a>        <span class=s1>&#39;avg_ranking_gain&#39;</span><span class=p>:</span> <span class=n>np</span><span class=o>.</span><span class=n>mean</span><span class=p>(</span><span class=n>ranking_gains</span><span class=p>)</span> <span class=k>if</span> <span class=n>ranking_gains</span> <span class=k>else</span> <span class=mf>0.0</span><span class=p>,</span>
</span><span id=__span-1-64><a id=__codelineno-1-64 name=__codelineno-1-64 href=#__codelineno-1-64></a>        <span class=s1>&#39;catalog_coverage&#39;</span><span class=p>:</span> <span class=nb>len</span><span class=p>(</span><span class=n>coverage_items</span><span class=p>)</span> <span class=o>/</span> <span class=bp>self</span><span class=o>.</span><span class=n>two_tower_data_loader</span><span class=o>.</span><span class=n>num_movies</span><span class=p>,</span>
</span><span id=__span-1-65><a id=__codelineno-1-65 name=__codelineno-1-65 href=#__codelineno-1-65></a>        <span class=s1>&#39;num_evaluated_users&#39;</span><span class=p>:</span> <span class=nb>len</span><span class=p>(</span><span class=n>test_users</span><span class=p>)</span>
</span><span id=__span-1-66><a id=__codelineno-1-66 name=__codelineno-1-66 href=#__codelineno-1-66></a>    <span class=p>}</span>
</span><span id=__span-1-67><a id=__codelineno-1-67 name=__codelineno-1-67 href=#__codelineno-1-67></a>
</span><span id=__span-1-68><a id=__codelineno-1-68 name=__codelineno-1-68 href=#__codelineno-1-68></a>    <span class=c1># Compute statistical significance measures for metric reliability</span>
</span><span id=__span-1-69><a id=__codelineno-1-69 name=__codelineno-1-69 href=#__codelineno-1-69></a>    <span class=n>metrics</span><span class=p>[</span><span class=s1>&#39;retrieval_recall_std&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>std</span><span class=p>(</span><span class=n>retrieval_recalls</span><span class=p>)</span>
</span><span id=__span-1-70><a id=__codelineno-1-70 name=__codelineno-1-70 href=#__codelineno-1-70></a>    <span class=n>metrics</span><span class=p>[</span><span class=s1>&#39;final_recall_std&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>std</span><span class=p>(</span><span class=n>final_recalls</span><span class=p>)</span>
</span><span id=__span-1-71><a id=__codelineno-1-71 name=__codelineno-1-71 href=#__codelineno-1-71></a>
</span><span id=__span-1-72><a id=__codelineno-1-72 name=__codelineno-1-72 href=#__codelineno-1-72></a>    <span class=c1># Mathematical bounds analysis: what&#39;s theoretically possible?</span>
</span><span id=__span-1-73><a id=__codelineno-1-73 name=__codelineno-1-73 href=#__codelineno-1-73></a>    <span class=c1># The integrated system recall is bounded above by retrieval recall</span>
</span><span id=__span-1-74><a id=__codelineno-1-74 name=__codelineno-1-74 href=#__codelineno-1-74></a>    <span class=n>metrics</span><span class=p>[</span><span class=s1>&#39;theoretical_upper_bound&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>metrics</span><span class=p>[</span><span class=s1>&#39;avg_retrieval_recall&#39;</span><span class=p>]</span>
</span><span id=__span-1-75><a id=__codelineno-1-75 name=__codelineno-1-75 href=#__codelineno-1-75></a>    <span class=n>metrics</span><span class=p>[</span><span class=s1>&#39;ranking_efficiency&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>metrics</span><span class=p>[</span><span class=s1>&#39;avg_final_recall&#39;</span><span class=p>]</span> <span class=o>/</span> <span class=n>metrics</span><span class=p>[</span><span class=s1>&#39;avg_retrieval_recall&#39;</span><span class=p>]</span> <span class=k>if</span> <span class=n>metrics</span><span class=p>[</span><span class=s1>&#39;avg_retrieval_recall&#39;</span><span class=p>]</span> <span class=o>&gt;</span> <span class=mi>0</span> <span class=k>else</span> <span class=mi>0</span>
</span><span id=__span-1-76><a id=__codelineno-1-76 name=__codelineno-1-76 href=#__codelineno-1-76></a>
</span><span id=__span-1-77><a id=__codelineno-1-77 name=__codelineno-1-77 href=#__codelineno-1-77></a>    <span class=k>return</span> <span class=n>metrics</span>
</span><span id=__span-1-78><a id=__codelineno-1-78 name=__codelineno-1-78 href=#__codelineno-1-78></a>
</span><span id=__span-1-79><a id=__codelineno-1-79 name=__codelineno-1-79 href=#__codelineno-1-79></a><span class=k>def</span><span class=w> </span><span class=nf>_get_user_ground_truth</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>user_idx</span><span class=p>:</span> <span class=nb>int</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>List</span><span class=p>[</span><span class=nb>int</span><span class=p>]:</span>
</span><span id=__span-1-80><a id=__codelineno-1-80 name=__codelineno-1-80 href=#__codelineno-1-80></a><span class=w>    </span><span class=sd>&quot;&quot;&quot;Extract ground truth relevant items for user from temporal test split.&quot;&quot;&quot;</span>
</span><span id=__span-1-81><a id=__codelineno-1-81 name=__codelineno-1-81 href=#__codelineno-1-81></a>    <span class=c1># This would implement temporal splitting logic to get items the user</span>
</span><span id=__span-1-82><a id=__codelineno-1-82 name=__codelineno-1-82 href=#__codelineno-1-82></a>    <span class=c1># actually rated positively in the test period</span>
</span><span id=__span-1-83><a id=__codelineno-1-83 name=__codelineno-1-83 href=#__codelineno-1-83></a>    <span class=c1># Implementation depends on your specific temporal splitting strategy</span>
</span><span id=__span-1-84><a id=__codelineno-1-84 name=__codelineno-1-84 href=#__codelineno-1-84></a>    <span class=k>pass</span>
</span></code></pre></div> <p>This implementation captures the mathematical relationships between different performance levels. The <code>theoretical_upper_bound</code> demonstrates how retrieval performance constrains final system performance, while <code>ranking_efficiency</code> measures how well BERT4Rec utilizes the opportunities provided by the two-tower stage.</p> <h2 id=mathematical-analysis-of-ranking-changes>Mathematical Analysis of Ranking Changes<a class=headerlink href=#mathematical-analysis-of-ranking-changes title="Permanent link">&para;</a></h2> <p>Understanding how BERT4Rec reorders candidates requires sophisticated mathematical analysis that goes beyond simple before-and-after comparisons. We need metrics that capture the magnitude, direction, and significance of ranking changes across different types of content and users.</p> <p>Let's define the ranking change analysis mathematically. For user <span class=arithmatex>\(u\)</span> and item <span class=arithmatex>\(i\)</span>, let <span class=arithmatex>\(r_i^{(2T)}\)</span> represent the rank of item <span class=arithmatex>\(i\)</span> in the two-tower ordering, and <span class=arithmatex>\(r_i^{(B4R)}\)</span> represent its rank in the BERT4Rec ordering. The rank change becomes:</p> <div class=arithmatex>\[\Delta r_i = r_i^{(2T)} - r_i^{(B4R)}\]</div> <p>Positive values indicate that BERT4Rec moved the item up in rankings, while negative values indicate downward movement. We can aggregate these changes across users and items to understand system-wide patterns.</p> <p>The rank correlation between the two orderings can be measured using Spearman's correlation coefficient:</p> <div class=arithmatex>\[\rho = 1 - \frac{6 \sum_{i=1}^n (r_i^{(2T)} - r_i^{(B4R)})^2}{n(n^2 - 1)}\]</div> <p>where <span class=arithmatex>\(n\)</span> represents the number of items in the candidate set. Low correlation indicates that BERT4Rec discovers different preference signals than collaborative filtering, potentially adding value through sequential understanding.</p> <p>Here's the mathematical implementation of ranking change analysis:</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-2-1><a id=__codelineno-2-1 name=__codelineno-2-1 href=#__codelineno-2-1></a><span class=k>def</span><span class=w> </span><span class=nf>analyze_ranking_changes</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>user_idx</span><span class=p>:</span> <span class=nb>int</span><span class=p>,</span> <span class=n>candidate_k</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>100</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>Any</span><span class=p>]:</span>
</span><span id=__span-2-2><a id=__codelineno-2-2 name=__codelineno-2-2 href=#__codelineno-2-2></a><span class=w>    </span><span class=sd>&quot;&quot;&quot;</span>
</span><span id=__span-2-3><a id=__codelineno-2-3 name=__codelineno-2-3 href=#__codelineno-2-3></a><span class=sd>    Perform comprehensive mathematical analysis of how BERT4Rec reorders candidates.</span>
</span><span id=__span-2-4><a id=__codelineno-2-4 name=__codelineno-2-4 href=#__codelineno-2-4></a>
</span><span id=__span-2-5><a id=__codelineno-2-5 name=__codelineno-2-5 href=#__codelineno-2-5></a><span class=sd>    This analysis quantifies the magnitude and direction of ranking changes,</span>
</span><span id=__span-2-6><a id=__codelineno-2-6 name=__codelineno-2-6 href=#__codelineno-2-6></a><span class=sd>    providing insights into when and why sequential modeling improves recommendations.</span>
</span><span id=__span-2-7><a id=__codelineno-2-7 name=__codelineno-2-7 href=#__codelineno-2-7></a><span class=sd>    The mathematical framework enables systematic understanding of model interactions.</span>
</span><span id=__span-2-8><a id=__codelineno-2-8 name=__codelineno-2-8 href=#__codelineno-2-8></a>
</span><span id=__span-2-9><a id=__codelineno-2-9 name=__codelineno-2-9 href=#__codelineno-2-9></a><span class=sd>    Args:</span>
</span><span id=__span-2-10><a id=__codelineno-2-10 name=__codelineno-2-10 href=#__codelineno-2-10></a><span class=sd>        user_idx: User for ranking change analysis</span>
</span><span id=__span-2-11><a id=__codelineno-2-11 name=__codelineno-2-11 href=#__codelineno-2-11></a><span class=sd>        candidate_k: Size of candidate set to analyze</span>
</span><span id=__span-2-12><a id=__codelineno-2-12 name=__codelineno-2-12 href=#__codelineno-2-12></a>
</span><span id=__span-2-13><a id=__codelineno-2-13 name=__codelineno-2-13 href=#__codelineno-2-13></a><span class=sd>    Returns:</span>
</span><span id=__span-2-14><a id=__codelineno-2-14 name=__codelineno-2-14 href=#__codelineno-2-14></a><span class=sd>        Detailed mathematical analysis of ranking changes and their implications</span>
</span><span id=__span-2-15><a id=__codelineno-2-15 name=__codelineno-2-15 href=#__codelineno-2-15></a><span class=sd>    &quot;&quot;&quot;</span>
</span><span id=__span-2-16><a id=__codelineno-2-16 name=__codelineno-2-16 href=#__codelineno-2-16></a>    <span class=c1># Generate two-tower candidate ordering</span>
</span><span id=__span-2-17><a id=__codelineno-2-17 name=__codelineno-2-17 href=#__codelineno-2-17></a>    <span class=n>candidates</span><span class=p>,</span> <span class=n>two_tower_scores</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>generate_two_tower_candidates</span><span class=p>(</span><span class=n>user_idx</span><span class=p>,</span> <span class=n>candidate_k</span><span class=p>)</span>
</span><span id=__span-2-18><a id=__codelineno-2-18 name=__codelineno-2-18 href=#__codelineno-2-18></a>
</span><span id=__span-2-19><a id=__codelineno-2-19 name=__codelineno-2-19 href=#__codelineno-2-19></a>    <span class=c1># Generate BERT4Rec reordering of the same candidates</span>
</span><span id=__span-2-20><a id=__codelineno-2-20 name=__codelineno-2-20 href=#__codelineno-2-20></a>    <span class=n>user_sequence</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>bert4rec_data_loader</span><span class=o>.</span><span class=n>user_sequences</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>user_idx</span><span class=p>,</span> <span class=p>[])</span>
</span><span id=__span-2-21><a id=__codelineno-2-21 name=__codelineno-2-21 href=#__codelineno-2-21></a>    <span class=n>bert4rec_results</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>rank_candidates_with_bert4rec</span><span class=p>(</span><span class=n>user_idx</span><span class=p>,</span> <span class=n>candidates</span><span class=p>,</span> <span class=n>user_sequence</span><span class=p>)</span>
</span><span id=__span-2-22><a id=__codelineno-2-22 name=__codelineno-2-22 href=#__codelineno-2-22></a>    <span class=n>bert4rec_ordering</span> <span class=o>=</span> <span class=p>[</span><span class=n>idx</span> <span class=k>for</span> <span class=n>idx</span><span class=p>,</span> <span class=n>score</span> <span class=ow>in</span> <span class=n>bert4rec_results</span><span class=p>]</span>
</span><span id=__span-2-23><a id=__codelineno-2-23 name=__codelineno-2-23 href=#__codelineno-2-23></a>
</span><span id=__span-2-24><a id=__codelineno-2-24 name=__codelineno-2-24 href=#__codelineno-2-24></a>    <span class=c1># Mathematical analysis of ranking changes</span>
</span><span id=__span-2-25><a id=__codelineno-2-25 name=__codelineno-2-25 href=#__codelineno-2-25></a>    <span class=n>ranking_changes</span> <span class=o>=</span> <span class=p>[]</span>
</span><span id=__span-2-26><a id=__codelineno-2-26 name=__codelineno-2-26 href=#__codelineno-2-26></a>    <span class=n>position_improvements</span> <span class=o>=</span> <span class=mi>0</span>
</span><span id=__span-2-27><a id=__codelineno-2-27 name=__codelineno-2-27 href=#__codelineno-2-27></a>    <span class=n>position_declines</span> <span class=o>=</span> <span class=mi>0</span>
</span><span id=__span-2-28><a id=__codelineno-2-28 name=__codelineno-2-28 href=#__codelineno-2-28></a>
</span><span id=__span-2-29><a id=__codelineno-2-29 name=__codelineno-2-29 href=#__codelineno-2-29></a>    <span class=k>for</span> <span class=n>bert4rec_rank</span><span class=p>,</span> <span class=n>movie_idx</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>bert4rec_ordering</span><span class=p>):</span>
</span><span id=__span-2-30><a id=__codelineno-2-30 name=__codelineno-2-30 href=#__codelineno-2-30></a>        <span class=c1># Find this movie&#39;s position in the original two-tower ordering</span>
</span><span id=__span-2-31><a id=__codelineno-2-31 name=__codelineno-2-31 href=#__codelineno-2-31></a>        <span class=k>if</span> <span class=n>movie_idx</span> <span class=ow>in</span> <span class=n>candidates</span><span class=p>:</span>
</span><span id=__span-2-32><a id=__codelineno-2-32 name=__codelineno-2-32 href=#__codelineno-2-32></a>            <span class=n>two_tower_rank</span> <span class=o>=</span> <span class=n>candidates</span><span class=o>.</span><span class=n>index</span><span class=p>(</span><span class=n>movie_idx</span><span class=p>)</span>
</span><span id=__span-2-33><a id=__codelineno-2-33 name=__codelineno-2-33 href=#__codelineno-2-33></a>
</span><span id=__span-2-34><a id=__codelineno-2-34 name=__codelineno-2-34 href=#__codelineno-2-34></a>            <span class=c1># Calculate rank change: Δr_i = r_i^(2T) - r_i^(B4R)</span>
</span><span id=__span-2-35><a id=__codelineno-2-35 name=__codelineno-2-35 href=#__codelineno-2-35></a>            <span class=c1># Positive values mean BERT4Rec moved item up (better ranking)</span>
</span><span id=__span-2-36><a id=__codelineno-2-36 name=__codelineno-2-36 href=#__codelineno-2-36></a>            <span class=n>rank_change</span> <span class=o>=</span> <span class=n>two_tower_rank</span> <span class=o>-</span> <span class=n>bert4rec_rank</span>
</span><span id=__span-2-37><a id=__codelineno-2-37 name=__codelineno-2-37 href=#__codelineno-2-37></a>
</span><span id=__span-2-38><a id=__codelineno-2-38 name=__codelineno-2-38 href=#__codelineno-2-38></a>            <span class=n>ranking_changes</span><span class=o>.</span><span class=n>append</span><span class=p>({</span>
</span><span id=__span-2-39><a id=__codelineno-2-39 name=__codelineno-2-39 href=#__codelineno-2-39></a>                <span class=s1>&#39;movie_idx&#39;</span><span class=p>:</span> <span class=n>movie_idx</span><span class=p>,</span>
</span><span id=__span-2-40><a id=__codelineno-2-40 name=__codelineno-2-40 href=#__codelineno-2-40></a>                <span class=s1>&#39;two_tower_rank&#39;</span><span class=p>:</span> <span class=n>two_tower_rank</span><span class=p>,</span>
</span><span id=__span-2-41><a id=__codelineno-2-41 name=__codelineno-2-41 href=#__codelineno-2-41></a>                <span class=s1>&#39;bert4rec_rank&#39;</span><span class=p>:</span> <span class=n>bert4rec_rank</span><span class=p>,</span>
</span><span id=__span-2-42><a id=__codelineno-2-42 name=__codelineno-2-42 href=#__codelineno-2-42></a>                <span class=s1>&#39;rank_change&#39;</span><span class=p>:</span> <span class=n>rank_change</span><span class=p>,</span>
</span><span id=__span-2-43><a id=__codelineno-2-43 name=__codelineno-2-43 href=#__codelineno-2-43></a>                <span class=s1>&#39;improvement&#39;</span><span class=p>:</span> <span class=n>rank_change</span> <span class=o>&gt;</span> <span class=mi>0</span>
</span><span id=__span-2-44><a id=__codelineno-2-44 name=__codelineno-2-44 href=#__codelineno-2-44></a>            <span class=p>})</span>
</span><span id=__span-2-45><a id=__codelineno-2-45 name=__codelineno-2-45 href=#__codelineno-2-45></a>
</span><span id=__span-2-46><a id=__codelineno-2-46 name=__codelineno-2-46 href=#__codelineno-2-46></a>            <span class=k>if</span> <span class=n>rank_change</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>:</span>
</span><span id=__span-2-47><a id=__codelineno-2-47 name=__codelineno-2-47 href=#__codelineno-2-47></a>                <span class=n>position_improvements</span> <span class=o>+=</span> <span class=mi>1</span>
</span><span id=__span-2-48><a id=__codelineno-2-48 name=__codelineno-2-48 href=#__codelineno-2-48></a>            <span class=k>elif</span> <span class=n>rank_change</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>:</span>
</span><span id=__span-2-49><a id=__codelineno-2-49 name=__codelineno-2-49 href=#__codelineno-2-49></a>                <span class=n>position_declines</span> <span class=o>+=</span> <span class=mi>1</span>
</span><span id=__span-2-50><a id=__codelineno-2-50 name=__codelineno-2-50 href=#__codelineno-2-50></a>
</span><span id=__span-2-51><a id=__codelineno-2-51 name=__codelineno-2-51 href=#__codelineno-2-51></a>    <span class=c1># Compute aggregate mathematical statistics</span>
</span><span id=__span-2-52><a id=__codelineno-2-52 name=__codelineno-2-52 href=#__codelineno-2-52></a>    <span class=n>rank_change_values</span> <span class=o>=</span> <span class=p>[</span><span class=n>change</span><span class=p>[</span><span class=s1>&#39;rank_change&#39;</span><span class=p>]</span> <span class=k>for</span> <span class=n>change</span> <span class=ow>in</span> <span class=n>ranking_changes</span><span class=p>]</span>
</span><span id=__span-2-53><a id=__codelineno-2-53 name=__codelineno-2-53 href=#__codelineno-2-53></a>
</span><span id=__span-2-54><a id=__codelineno-2-54 name=__codelineno-2-54 href=#__codelineno-2-54></a>    <span class=n>analysis</span> <span class=o>=</span> <span class=p>{</span>
</span><span id=__span-2-55><a id=__codelineno-2-55 name=__codelineno-2-55 href=#__codelineno-2-55></a>        <span class=s1>&#39;total_analyzed_items&#39;</span><span class=p>:</span> <span class=nb>len</span><span class=p>(</span><span class=n>ranking_changes</span><span class=p>),</span>
</span><span id=__span-2-56><a id=__codelineno-2-56 name=__codelineno-2-56 href=#__codelineno-2-56></a>        <span class=s1>&#39;mean_rank_change&#39;</span><span class=p>:</span> <span class=n>np</span><span class=o>.</span><span class=n>mean</span><span class=p>(</span><span class=n>rank_change_values</span><span class=p>)</span> <span class=k>if</span> <span class=n>rank_change_values</span> <span class=k>else</span> <span class=mi>0</span><span class=p>,</span>
</span><span id=__span-2-57><a id=__codelineno-2-57 name=__codelineno-2-57 href=#__codelineno-2-57></a>        <span class=s1>&#39;std_rank_change&#39;</span><span class=p>:</span> <span class=n>np</span><span class=o>.</span><span class=n>std</span><span class=p>(</span><span class=n>rank_change_values</span><span class=p>)</span> <span class=k>if</span> <span class=n>rank_change_values</span> <span class=k>else</span> <span class=mi>0</span><span class=p>,</span>
</span><span id=__span-2-58><a id=__codelineno-2-58 name=__codelineno-2-58 href=#__codelineno-2-58></a>        <span class=s1>&#39;median_rank_change&#39;</span><span class=p>:</span> <span class=n>np</span><span class=o>.</span><span class=n>median</span><span class=p>(</span><span class=n>rank_change_values</span><span class=p>)</span> <span class=k>if</span> <span class=n>rank_change_values</span> <span class=k>else</span> <span class=mi>0</span><span class=p>,</span>
</span><span id=__span-2-59><a id=__codelineno-2-59 name=__codelineno-2-59 href=#__codelineno-2-59></a>        <span class=s1>&#39;max_improvement&#39;</span><span class=p>:</span> <span class=nb>max</span><span class=p>(</span><span class=n>rank_change_values</span><span class=p>)</span> <span class=k>if</span> <span class=n>rank_change_values</span> <span class=k>else</span> <span class=mi>0</span><span class=p>,</span>
</span><span id=__span-2-60><a id=__codelineno-2-60 name=__codelineno-2-60 href=#__codelineno-2-60></a>        <span class=s1>&#39;max_decline&#39;</span><span class=p>:</span> <span class=nb>min</span><span class=p>(</span><span class=n>rank_change_values</span><span class=p>)</span> <span class=k>if</span> <span class=n>rank_change_values</span> <span class=k>else</span> <span class=mi>0</span><span class=p>,</span>
</span><span id=__span-2-61><a id=__codelineno-2-61 name=__codelineno-2-61 href=#__codelineno-2-61></a>        <span class=s1>&#39;items_improved&#39;</span><span class=p>:</span> <span class=n>position_improvements</span><span class=p>,</span>
</span><span id=__span-2-62><a id=__codelineno-2-62 name=__codelineno-2-62 href=#__codelineno-2-62></a>        <span class=s1>&#39;items_declined&#39;</span><span class=p>:</span> <span class=n>position_declines</span><span class=p>,</span>
</span><span id=__span-2-63><a id=__codelineno-2-63 name=__codelineno-2-63 href=#__codelineno-2-63></a>        <span class=s1>&#39;improvement_rate&#39;</span><span class=p>:</span> <span class=n>position_improvements</span> <span class=o>/</span> <span class=nb>len</span><span class=p>(</span><span class=n>ranking_changes</span><span class=p>)</span> <span class=k>if</span> <span class=n>ranking_changes</span> <span class=k>else</span> <span class=mi>0</span>
</span><span id=__span-2-64><a id=__codelineno-2-64 name=__codelineno-2-64 href=#__codelineno-2-64></a>    <span class=p>}</span>
</span><span id=__span-2-65><a id=__codelineno-2-65 name=__codelineno-2-65 href=#__codelineno-2-65></a>
</span><span id=__span-2-66><a id=__codelineno-2-66 name=__codelineno-2-66 href=#__codelineno-2-66></a>    <span class=c1># Spearman rank correlation: ρ = 1 - (6Σd²)/(n(n²-1))</span>
</span><span id=__span-2-67><a id=__codelineno-2-67 name=__codelineno-2-67 href=#__codelineno-2-67></a>    <span class=c1># This measures how much the two orderings agree</span>
</span><span id=__span-2-68><a id=__codelineno-2-68 name=__codelineno-2-68 href=#__codelineno-2-68></a>    <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>ranking_changes</span><span class=p>)</span> <span class=o>&gt;</span> <span class=mi>1</span><span class=p>:</span>
</span><span id=__span-2-69><a id=__codelineno-2-69 name=__codelineno-2-69 href=#__codelineno-2-69></a>        <span class=n>analysis</span><span class=p>[</span><span class=s1>&#39;spearman_correlation&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_compute_spearman_correlation</span><span class=p>(</span>
</span><span id=__span-2-70><a id=__codelineno-2-70 name=__codelineno-2-70 href=#__codelineno-2-70></a>            <span class=n>candidates</span><span class=p>,</span> <span class=n>bert4rec_ordering</span>
</span><span id=__span-2-71><a id=__codelineno-2-71 name=__codelineno-2-71 href=#__codelineno-2-71></a>        <span class=p>)</span>
</span><span id=__span-2-72><a id=__codelineno-2-72 name=__codelineno-2-72 href=#__codelineno-2-72></a>
</span><span id=__span-2-73><a id=__codelineno-2-73 name=__codelineno-2-73 href=#__codelineno-2-73></a>    <span class=c1># Statistical significance testing for ranking changes</span>
</span><span id=__span-2-74><a id=__codelineno-2-74 name=__codelineno-2-74 href=#__codelineno-2-74></a>    <span class=c1># Use Wilcoxon signed-rank test to determine if changes are significant</span>
</span><span id=__span-2-75><a id=__codelineno-2-75 name=__codelineno-2-75 href=#__codelineno-2-75></a>    <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>rank_change_values</span><span class=p>)</span> <span class=o>&gt;</span> <span class=mi>10</span><span class=p>:</span>
</span><span id=__span-2-76><a id=__codelineno-2-76 name=__codelineno-2-76 href=#__codelineno-2-76></a>        <span class=kn>from</span><span class=w> </span><span class=nn>scipy</span><span class=w> </span><span class=kn>import</span> <span class=n>stats</span>
</span><span id=__span-2-77><a id=__codelineno-2-77 name=__codelineno-2-77 href=#__codelineno-2-77></a>        <span class=n>statistic</span><span class=p>,</span> <span class=n>p_value</span> <span class=o>=</span> <span class=n>stats</span><span class=o>.</span><span class=n>wilcoxon</span><span class=p>(</span><span class=n>rank_change_values</span><span class=p>)</span>
</span><span id=__span-2-78><a id=__codelineno-2-78 name=__codelineno-2-78 href=#__codelineno-2-78></a>        <span class=n>analysis</span><span class=p>[</span><span class=s1>&#39;wilcoxon_statistic&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>statistic</span>
</span><span id=__span-2-79><a id=__codelineno-2-79 name=__codelineno-2-79 href=#__codelineno-2-79></a>        <span class=n>analysis</span><span class=p>[</span><span class=s1>&#39;wilcoxon_p_value&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>p_value</span>
</span><span id=__span-2-80><a id=__codelineno-2-80 name=__codelineno-2-80 href=#__codelineno-2-80></a>        <span class=n>analysis</span><span class=p>[</span><span class=s1>&#39;changes_significant&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>p_value</span> <span class=o>&lt;</span> <span class=mf>0.05</span>
</span><span id=__span-2-81><a id=__codelineno-2-81 name=__codelineno-2-81 href=#__codelineno-2-81></a>
</span><span id=__span-2-82><a id=__codelineno-2-82 name=__codelineno-2-82 href=#__codelineno-2-82></a>    <span class=k>return</span> <span class=n>analysis</span>
</span><span id=__span-2-83><a id=__codelineno-2-83 name=__codelineno-2-83 href=#__codelineno-2-83></a>
</span><span id=__span-2-84><a id=__codelineno-2-84 name=__codelineno-2-84 href=#__codelineno-2-84></a><span class=k>def</span><span class=w> </span><span class=nf>_compute_spearman_correlation</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>original_order</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=nb>int</span><span class=p>],</span> 
</span><span id=__span-2-85><a id=__codelineno-2-85 name=__codelineno-2-85 href=#__codelineno-2-85></a>                                <span class=n>reranked_order</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=nb>int</span><span class=p>])</span> <span class=o>-&gt;</span> <span class=nb>float</span><span class=p>:</span>
</span><span id=__span-2-86><a id=__codelineno-2-86 name=__codelineno-2-86 href=#__codelineno-2-86></a><span class=w>    </span><span class=sd>&quot;&quot;&quot;</span>
</span><span id=__span-2-87><a id=__codelineno-2-87 name=__codelineno-2-87 href=#__codelineno-2-87></a><span class=sd>    Compute Spearman rank correlation coefficient between two orderings.</span>
</span><span id=__span-2-88><a id=__codelineno-2-88 name=__codelineno-2-88 href=#__codelineno-2-88></a>
</span><span id=__span-2-89><a id=__codelineno-2-89 name=__codelineno-2-89 href=#__codelineno-2-89></a><span class=sd>    The mathematical formula: ρ = 1 - (6Σd²)/(n(n²-1))</span>
</span><span id=__span-2-90><a id=__codelineno-2-90 name=__codelineno-2-90 href=#__codelineno-2-90></a><span class=sd>    where d represents rank differences for each item.</span>
</span><span id=__span-2-91><a id=__codelineno-2-91 name=__codelineno-2-91 href=#__codelineno-2-91></a><span class=sd>    &quot;&quot;&quot;</span>
</span><span id=__span-2-92><a id=__codelineno-2-92 name=__codelineno-2-92 href=#__codelineno-2-92></a>    <span class=n>common_items</span> <span class=o>=</span> <span class=nb>set</span><span class=p>(</span><span class=n>original_order</span><span class=p>)</span><span class=o>.</span><span class=n>intersection</span><span class=p>(</span><span class=nb>set</span><span class=p>(</span><span class=n>reranked_order</span><span class=p>))</span>
</span><span id=__span-2-93><a id=__codelineno-2-93 name=__codelineno-2-93 href=#__codelineno-2-93></a>
</span><span id=__span-2-94><a id=__codelineno-2-94 name=__codelineno-2-94 href=#__codelineno-2-94></a>    <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>common_items</span><span class=p>)</span> <span class=o>&lt;</span> <span class=mi>2</span><span class=p>:</span>
</span><span id=__span-2-95><a id=__codelineno-2-95 name=__codelineno-2-95 href=#__codelineno-2-95></a>        <span class=k>return</span> <span class=mf>0.0</span>
</span><span id=__span-2-96><a id=__codelineno-2-96 name=__codelineno-2-96 href=#__codelineno-2-96></a>
</span><span id=__span-2-97><a id=__codelineno-2-97 name=__codelineno-2-97 href=#__codelineno-2-97></a>    <span class=c1># Get ranks for common items in both orderings</span>
</span><span id=__span-2-98><a id=__codelineno-2-98 name=__codelineno-2-98 href=#__codelineno-2-98></a>    <span class=n>rank_diffs_squared</span> <span class=o>=</span> <span class=p>[]</span>
</span><span id=__span-2-99><a id=__codelineno-2-99 name=__codelineno-2-99 href=#__codelineno-2-99></a>
</span><span id=__span-2-100><a id=__codelineno-2-100 name=__codelineno-2-100 href=#__codelineno-2-100></a>    <span class=k>for</span> <span class=n>item</span> <span class=ow>in</span> <span class=n>common_items</span><span class=p>:</span>
</span><span id=__span-2-101><a id=__codelineno-2-101 name=__codelineno-2-101 href=#__codelineno-2-101></a>        <span class=n>original_rank</span> <span class=o>=</span> <span class=n>original_order</span><span class=o>.</span><span class=n>index</span><span class=p>(</span><span class=n>item</span><span class=p>)</span>
</span><span id=__span-2-102><a id=__codelineno-2-102 name=__codelineno-2-102 href=#__codelineno-2-102></a>        <span class=n>reranked_rank</span> <span class=o>=</span> <span class=n>reranked_order</span><span class=o>.</span><span class=n>index</span><span class=p>(</span><span class=n>item</span><span class=p>)</span> 
</span><span id=__span-2-103><a id=__codelineno-2-103 name=__codelineno-2-103 href=#__codelineno-2-103></a>        <span class=n>rank_diff</span> <span class=o>=</span> <span class=n>original_rank</span> <span class=o>-</span> <span class=n>reranked_rank</span>
</span><span id=__span-2-104><a id=__codelineno-2-104 name=__codelineno-2-104 href=#__codelineno-2-104></a>        <span class=n>rank_diffs_squared</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>rank_diff</span> <span class=o>**</span> <span class=mi>2</span><span class=p>)</span>
</span><span id=__span-2-105><a id=__codelineno-2-105 name=__codelineno-2-105 href=#__codelineno-2-105></a>
</span><span id=__span-2-106><a id=__codelineno-2-106 name=__codelineno-2-106 href=#__codelineno-2-106></a>    <span class=n>n</span> <span class=o>=</span> <span class=nb>len</span><span class=p>(</span><span class=n>common_items</span><span class=p>)</span>
</span><span id=__span-2-107><a id=__codelineno-2-107 name=__codelineno-2-107 href=#__codelineno-2-107></a>    <span class=n>sum_diff_squared</span> <span class=o>=</span> <span class=nb>sum</span><span class=p>(</span><span class=n>rank_diffs_squared</span><span class=p>)</span>
</span><span id=__span-2-108><a id=__codelineno-2-108 name=__codelineno-2-108 href=#__codelineno-2-108></a>
</span><span id=__span-2-109><a id=__codelineno-2-109 name=__codelineno-2-109 href=#__codelineno-2-109></a>    <span class=c1># Spearman correlation formula: ρ = 1 - (6Σd²)/(n(n²-1))</span>
</span><span id=__span-2-110><a id=__codelineno-2-110 name=__codelineno-2-110 href=#__codelineno-2-110></a>    <span class=n>correlation</span> <span class=o>=</span> <span class=mi>1</span> <span class=o>-</span> <span class=p>(</span><span class=mi>6</span> <span class=o>*</span> <span class=n>sum_diff_squared</span><span class=p>)</span> <span class=o>/</span> <span class=p>(</span><span class=n>n</span> <span class=o>*</span> <span class=p>(</span><span class=n>n</span><span class=o>**</span><span class=mi>2</span> <span class=o>-</span> <span class=mi>1</span><span class=p>))</span>
</span><span id=__span-2-111><a id=__codelineno-2-111 name=__codelineno-2-111 href=#__codelineno-2-111></a>
</span><span id=__span-2-112><a id=__codelineno-2-112 name=__codelineno-2-112 href=#__codelineno-2-112></a>    <span class=k>return</span> <span class=n>correlation</span>
</span></code></pre></div> <p>This mathematical analysis provides quantitative insights into how sequential modeling affects recommendation ordering. The Spearman correlation reveals whether BERT4Rec discovers genuinely different preference signals, while the statistical significance testing determines whether observed changes are meaningful rather than random.</p> <h2 id=implementation-of-diagnostic-analysis-framework>Implementation of Diagnostic Analysis Framework<a class=headerlink href=#implementation-of-diagnostic-analysis-framework title="Permanent link">&para;</a></h2> <p>The diagnostic framework provides the mathematical tools needed to identify specific failure modes and improvement opportunities in your integrated system. This analysis goes beyond aggregate performance metrics to understand why your system succeeds or fails in particular circumstances.</p> <p>The diagnostic approach involves segmenting your evaluation results along multiple dimensions and computing performance statistics for each segment. This segmentation reveals patterns that guide targeted improvements rather than general architectural changes.</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-3-1><a id=__codelineno-3-1 name=__codelineno-3-1 href=#__codelineno-3-1></a><span class=k>def</span><span class=w> </span><span class=nf>perform_diagnostic_analysis</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>evaluation_results</span><span class=p>:</span> <span class=n>Dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>Any</span><span class=p>])</span> <span class=o>-&gt;</span> <span class=n>Dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>Any</span><span class=p>]:</span>
</span><span id=__span-3-2><a id=__codelineno-3-2 name=__codelineno-3-2 href=#__codelineno-3-2></a><span class=w>    </span><span class=sd>&quot;&quot;&quot;</span>
</span><span id=__span-3-3><a id=__codelineno-3-3 name=__codelineno-3-3 href=#__codelineno-3-3></a><span class=sd>    Comprehensive diagnostic analysis of integrated system performance patterns.</span>
</span><span id=__span-3-4><a id=__codelineno-3-4 name=__codelineno-3-4 href=#__codelineno-3-4></a>
</span><span id=__span-3-5><a id=__codelineno-3-5 name=__codelineno-3-5 href=#__codelineno-3-5></a><span class=sd>    This framework segments performance results along multiple dimensions to identify</span>
</span><span id=__span-3-6><a id=__codelineno-3-6 name=__codelineno-3-6 href=#__codelineno-3-6></a><span class=sd>    specific failure modes, success patterns, and improvement opportunities.</span>
</span><span id=__span-3-7><a id=__codelineno-3-7 name=__codelineno-3-7 href=#__codelineno-3-7></a><span class=sd>    The mathematical analysis provides actionable insights for system optimization.</span>
</span><span id=__span-3-8><a id=__codelineno-3-8 name=__codelineno-3-8 href=#__codelineno-3-8></a>
</span><span id=__span-3-9><a id=__codelineno-3-9 name=__codelineno-3-9 href=#__codelineno-3-9></a><span class=sd>    Args:</span>
</span><span id=__span-3-10><a id=__codelineno-3-10 name=__codelineno-3-10 href=#__codelineno-3-10></a><span class=sd>        evaluation_results: Complete evaluation results from system testing</span>
</span><span id=__span-3-11><a id=__codelineno-3-11 name=__codelineno-3-11 href=#__codelineno-3-11></a>
</span><span id=__span-3-12><a id=__codelineno-3-12 name=__codelineno-3-12 href=#__codelineno-3-12></a><span class=sd>    Returns:</span>
</span><span id=__span-3-13><a id=__codelineno-3-13 name=__codelineno-3-13 href=#__codelineno-3-13></a><span class=sd>        Detailed diagnostic analysis with improvement recommendations</span>
</span><span id=__span-3-14><a id=__codelineno-3-14 name=__codelineno-3-14 href=#__codelineno-3-14></a><span class=sd>    &quot;&quot;&quot;</span>
</span><span id=__span-3-15><a id=__codelineno-3-15 name=__codelineno-3-15 href=#__codelineno-3-15></a>    <span class=n>diagnostics</span> <span class=o>=</span> <span class=p>{</span>
</span><span id=__span-3-16><a id=__codelineno-3-16 name=__codelineno-3-16 href=#__codelineno-3-16></a>        <span class=s1>&#39;user_segment_analysis&#39;</span><span class=p>:</span> <span class=p>{},</span>
</span><span id=__span-3-17><a id=__codelineno-3-17 name=__codelineno-3-17 href=#__codelineno-3-17></a>        <span class=s1>&#39;content_segment_analysis&#39;</span><span class=p>:</span> <span class=p>{},</span>
</span><span id=__span-3-18><a id=__codelineno-3-18 name=__codelineno-3-18 href=#__codelineno-3-18></a>        <span class=s1>&#39;failure_mode_analysis&#39;</span><span class=p>:</span> <span class=p>{},</span>
</span><span id=__span-3-19><a id=__codelineno-3-19 name=__codelineno-3-19 href=#__codelineno-3-19></a>        <span class=s1>&#39;improvement_opportunities&#39;</span><span class=p>:</span> <span class=p>{}</span>
</span><span id=__span-3-20><a id=__codelineno-3-20 name=__codelineno-3-20 href=#__codelineno-3-20></a>    <span class=p>}</span>
</span><span id=__span-3-21><a id=__codelineno-3-21 name=__codelineno-3-21 href=#__codelineno-3-21></a>
</span><span id=__span-3-22><a id=__codelineno-3-22 name=__codelineno-3-22 href=#__codelineno-3-22></a>    <span class=c1># User segmentation analysis: how does performance vary by user characteristics?</span>
</span><span id=__span-3-23><a id=__codelineno-3-23 name=__codelineno-3-23 href=#__codelineno-3-23></a>    <span class=n>diagnostics</span><span class=p>[</span><span class=s1>&#39;user_segment_analysis&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_analyze_user_segments</span><span class=p>(</span><span class=n>evaluation_results</span><span class=p>)</span>
</span><span id=__span-3-24><a id=__codelineno-3-24 name=__codelineno-3-24 href=#__codelineno-3-24></a>
</span><span id=__span-3-25><a id=__codelineno-3-25 name=__codelineno-3-25 href=#__codelineno-3-25></a>    <span class=c1># Content segmentation analysis: which types of movies benefit from integration?</span>
</span><span id=__span-3-26><a id=__codelineno-3-26 name=__codelineno-3-26 href=#__codelineno-3-26></a>    <span class=n>diagnostics</span><span class=p>[</span><span class=s1>&#39;content_segment_analysis&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_analyze_content_segments</span><span class=p>(</span><span class=n>evaluation_results</span><span class=p>)</span>
</span><span id=__span-3-27><a id=__codelineno-3-27 name=__codelineno-3-27 href=#__codelineno-3-27></a>
</span><span id=__span-3-28><a id=__codelineno-3-28 name=__codelineno-3-28 href=#__codelineno-3-28></a>    <span class=c1># Failure mode identification: systematic analysis of poor performance cases</span>
</span><span id=__span-3-29><a id=__codelineno-3-29 name=__codelineno-3-29 href=#__codelineno-3-29></a>    <span class=n>diagnostics</span><span class=p>[</span><span class=s1>&#39;failure_mode_analysis&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_identify_failure_modes</span><span class=p>(</span><span class=n>evaluation_results</span><span class=p>)</span>
</span><span id=__span-3-30><a id=__codelineno-3-30 name=__codelineno-3-30 href=#__codelineno-3-30></a>
</span><span id=__span-3-31><a id=__codelineno-3-31 name=__codelineno-3-31 href=#__codelineno-3-31></a>    <span class=c1># Improvement opportunity quantification: where would changes have most impact?</span>
</span><span id=__span-3-32><a id=__codelineno-3-32 name=__codelineno-3-32 href=#__codelineno-3-32></a>    <span class=n>diagnostics</span><span class=p>[</span><span class=s1>&#39;improvement_opportunities&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_quantify_improvement_opportunities</span><span class=p>(</span><span class=n>evaluation_results</span><span class=p>)</span>
</span><span id=__span-3-33><a id=__codelineno-3-33 name=__codelineno-3-33 href=#__codelineno-3-33></a>
</span><span id=__span-3-34><a id=__codelineno-3-34 name=__codelineno-3-34 href=#__codelineno-3-34></a>    <span class=k>return</span> <span class=n>diagnostics</span>
</span><span id=__span-3-35><a id=__codelineno-3-35 name=__codelineno-3-35 href=#__codelineno-3-35></a>
</span><span id=__span-3-36><a id=__codelineno-3-36 name=__codelineno-3-36 href=#__codelineno-3-36></a><span class=k>def</span><span class=w> </span><span class=nf>_analyze_user_segments</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>evaluation_results</span><span class=p>:</span> <span class=n>Dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>Any</span><span class=p>])</span> <span class=o>-&gt;</span> <span class=n>Dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>Any</span><span class=p>]:</span>
</span><span id=__span-3-37><a id=__codelineno-3-37 name=__codelineno-3-37 href=#__codelineno-3-37></a><span class=w>    </span><span class=sd>&quot;&quot;&quot;</span>
</span><span id=__span-3-38><a id=__codelineno-3-38 name=__codelineno-3-38 href=#__codelineno-3-38></a><span class=sd>    Segment users by interaction history characteristics and analyze performance.</span>
</span><span id=__span-3-39><a id=__codelineno-3-39 name=__codelineno-3-39 href=#__codelineno-3-39></a>
</span><span id=__span-3-40><a id=__codelineno-3-40 name=__codelineno-3-40 href=#__codelineno-3-40></a><span class=sd>    Mathematical segmentation based on sequence length, rating patterns, and</span>
</span><span id=__span-3-41><a id=__codelineno-3-41 name=__codelineno-3-41 href=#__codelineno-3-41></a><span class=sd>    temporal activity to understand how system performance varies across user types.</span>
</span><span id=__span-3-42><a id=__codelineno-3-42 name=__codelineno-3-42 href=#__codelineno-3-42></a><span class=sd>    &quot;&quot;&quot;</span>
</span><span id=__span-3-43><a id=__codelineno-3-43 name=__codelineno-3-43 href=#__codelineno-3-43></a>    <span class=n>user_segments</span> <span class=o>=</span> <span class=p>{</span>
</span><span id=__span-3-44><a id=__codelineno-3-44 name=__codelineno-3-44 href=#__codelineno-3-44></a>        <span class=s1>&#39;active_users&#39;</span><span class=p>:</span> <span class=p>[],</span>      <span class=c1># Users with long interaction histories  </span>
</span><span id=__span-3-45><a id=__codelineno-3-45 name=__codelineno-3-45 href=#__codelineno-3-45></a>        <span class=s1>&#39;casual_users&#39;</span><span class=p>:</span> <span class=p>[],</span>      <span class=c1># Users with sparse interaction histories</span>
</span><span id=__span-3-46><a id=__codelineno-3-46 name=__codelineno-3-46 href=#__codelineno-3-46></a>        <span class=s1>&#39;explorer_users&#39;</span><span class=p>:</span> <span class=p>[],</span>    <span class=c1># Users with diverse genre preferences</span>
</span><span id=__span-3-47><a id=__codelineno-3-47 name=__codelineno-3-47 href=#__codelineno-3-47></a>        <span class=s1>&#39;specialist_users&#39;</span><span class=p>:</span> <span class=p>[]</span>   <span class=c1># Users with narrow genre focus</span>
</span><span id=__span-3-48><a id=__codelineno-3-48 name=__codelineno-3-48 href=#__codelineno-3-48></a>    <span class=p>}</span>
</span><span id=__span-3-49><a id=__codelineno-3-49 name=__codelineno-3-49 href=#__codelineno-3-49></a>
</span><span id=__span-3-50><a id=__codelineno-3-50 name=__codelineno-3-50 href=#__codelineno-3-50></a>    <span class=n>segment_performance</span> <span class=o>=</span> <span class=p>{}</span>
</span><span id=__span-3-51><a id=__codelineno-3-51 name=__codelineno-3-51 href=#__codelineno-3-51></a>
</span><span id=__span-3-52><a id=__codelineno-3-52 name=__codelineno-3-52 href=#__codelineno-3-52></a>    <span class=k>for</span> <span class=n>user_result</span> <span class=ow>in</span> <span class=n>evaluation_results</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;individual_results&#39;</span><span class=p>,</span> <span class=p>[]):</span>
</span><span id=__span-3-53><a id=__codelineno-3-53 name=__codelineno-3-53 href=#__codelineno-3-53></a>        <span class=n>user_idx</span> <span class=o>=</span> <span class=n>user_result</span><span class=p>[</span><span class=s1>&#39;user_idx&#39;</span><span class=p>]</span>
</span><span id=__span-3-54><a id=__codelineno-3-54 name=__codelineno-3-54 href=#__codelineno-3-54></a>
</span><span id=__span-3-55><a id=__codelineno-3-55 name=__codelineno-3-55 href=#__codelineno-3-55></a>        <span class=c1># Get user characteristics for segmentation</span>
</span><span id=__span-3-56><a id=__codelineno-3-56 name=__codelineno-3-56 href=#__codelineno-3-56></a>        <span class=n>user_sequence</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>bert4rec_data_loader</span><span class=o>.</span><span class=n>user_sequences</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>user_idx</span><span class=p>,</span> <span class=p>[])</span>
</span><span id=__span-3-57><a id=__codelineno-3-57 name=__codelineno-3-57 href=#__codelineno-3-57></a>        <span class=n>sequence_length</span> <span class=o>=</span> <span class=nb>len</span><span class=p>(</span><span class=n>user_sequence</span><span class=p>)</span>
</span><span id=__span-3-58><a id=__codelineno-3-58 name=__codelineno-3-58 href=#__codelineno-3-58></a>
</span><span id=__span-3-59><a id=__codelineno-3-59 name=__codelineno-3-59 href=#__codelineno-3-59></a>        <span class=c1># Mathematical segmentation criteria</span>
</span><span id=__span-3-60><a id=__codelineno-3-60 name=__codelineno-3-60 href=#__codelineno-3-60></a>        <span class=k>if</span> <span class=n>sequence_length</span> <span class=o>&gt;=</span> <span class=mi>50</span><span class=p>:</span>
</span><span id=__span-3-61><a id=__codelineno-3-61 name=__codelineno-3-61 href=#__codelineno-3-61></a>            <span class=n>segment</span> <span class=o>=</span> <span class=s1>&#39;active_users&#39;</span>
</span><span id=__span-3-62><a id=__codelineno-3-62 name=__codelineno-3-62 href=#__codelineno-3-62></a>        <span class=k>elif</span> <span class=n>sequence_length</span> <span class=o>&gt;=</span> <span class=mi>10</span><span class=p>:</span>
</span><span id=__span-3-63><a id=__codelineno-3-63 name=__codelineno-3-63 href=#__codelineno-3-63></a>            <span class=n>segment</span> <span class=o>=</span> <span class=s1>&#39;casual_users&#39;</span>  
</span><span id=__span-3-64><a id=__codelineno-3-64 name=__codelineno-3-64 href=#__codelineno-3-64></a>        <span class=k>elif</span> <span class=bp>self</span><span class=o>.</span><span class=n>_compute_genre_diversity</span><span class=p>(</span><span class=n>user_sequence</span><span class=p>)</span> <span class=o>&gt;</span> <span class=mf>0.7</span><span class=p>:</span>
</span><span id=__span-3-65><a id=__codelineno-3-65 name=__codelineno-3-65 href=#__codelineno-3-65></a>            <span class=n>segment</span> <span class=o>=</span> <span class=s1>&#39;explorer_users&#39;</span>
</span><span id=__span-3-66><a id=__codelineno-3-66 name=__codelineno-3-66 href=#__codelineno-3-66></a>        <span class=k>else</span><span class=p>:</span>
</span><span id=__span-3-67><a id=__codelineno-3-67 name=__codelineno-3-67 href=#__codelineno-3-67></a>            <span class=n>segment</span> <span class=o>=</span> <span class=s1>&#39;specialist_users&#39;</span>
</span><span id=__span-3-68><a id=__codelineno-3-68 name=__codelineno-3-68 href=#__codelineno-3-68></a>
</span><span id=__span-3-69><a id=__codelineno-3-69 name=__codelineno-3-69 href=#__codelineno-3-69></a>        <span class=n>user_segments</span><span class=p>[</span><span class=n>segment</span><span class=p>]</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>user_result</span><span class=p>)</span>
</span><span id=__span-3-70><a id=__codelineno-3-70 name=__codelineno-3-70 href=#__codelineno-3-70></a>
</span><span id=__span-3-71><a id=__codelineno-3-71 name=__codelineno-3-71 href=#__codelineno-3-71></a>    <span class=c1># Compute performance statistics for each segment</span>
</span><span id=__span-3-72><a id=__codelineno-3-72 name=__codelineno-3-72 href=#__codelineno-3-72></a>    <span class=k>for</span> <span class=n>segment_name</span><span class=p>,</span> <span class=n>segment_users</span> <span class=ow>in</span> <span class=n>user_segments</span><span class=o>.</span><span class=n>items</span><span class=p>():</span>
</span><span id=__span-3-73><a id=__codelineno-3-73 name=__codelineno-3-73 href=#__codelineno-3-73></a>        <span class=k>if</span> <span class=n>segment_users</span><span class=p>:</span>
</span><span id=__span-3-74><a id=__codelineno-3-74 name=__codelineno-3-74 href=#__codelineno-3-74></a>            <span class=n>segment_performance</span><span class=p>[</span><span class=n>segment_name</span><span class=p>]</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_compute_segment_metrics</span><span class=p>(</span><span class=n>segment_users</span><span class=p>)</span>
</span><span id=__span-3-75><a id=__codelineno-3-75 name=__codelineno-3-75 href=#__codelineno-3-75></a>
</span><span id=__span-3-76><a id=__codelineno-3-76 name=__codelineno-3-76 href=#__codelineno-3-76></a>    <span class=k>return</span> <span class=n>segment_performance</span>
</span><span id=__span-3-77><a id=__codelineno-3-77 name=__codelineno-3-77 href=#__codelineno-3-77></a>
</span><span id=__span-3-78><a id=__codelineno-3-78 name=__codelineno-3-78 href=#__codelineno-3-78></a><span class=k>def</span><span class=w> </span><span class=nf>_compute_genre_diversity</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>user_sequence</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=n>Dict</span><span class=p>])</span> <span class=o>-&gt;</span> <span class=nb>float</span><span class=p>:</span>
</span><span id=__span-3-79><a id=__codelineno-3-79 name=__codelineno-3-79 href=#__codelineno-3-79></a><span class=w>    </span><span class=sd>&quot;&quot;&quot;</span>
</span><span id=__span-3-80><a id=__codelineno-3-80 name=__codelineno-3-80 href=#__codelineno-3-80></a><span class=sd>    Calculate genre diversity score using Shannon entropy.</span>
</span><span id=__span-3-81><a id=__codelineno-3-81 name=__codelineno-3-81 href=#__codelineno-3-81></a>
</span><span id=__span-3-82><a id=__codelineno-3-82 name=__codelineno-3-82 href=#__codelineno-3-82></a><span class=sd>    Mathematical formula: H = -Σ(p_i * log(p_i))</span>
</span><span id=__span-3-83><a id=__codelineno-3-83 name=__codelineno-3-83 href=#__codelineno-3-83></a><span class=sd>    where p_i represents the proportion of interactions in genre i.</span>
</span><span id=__span-3-84><a id=__codelineno-3-84 name=__codelineno-3-84 href=#__codelineno-3-84></a><span class=sd>    &quot;&quot;&quot;</span>
</span><span id=__span-3-85><a id=__codelineno-3-85 name=__codelineno-3-85 href=#__codelineno-3-85></a>    <span class=k>if</span> <span class=ow>not</span> <span class=n>user_sequence</span><span class=p>:</span>
</span><span id=__span-3-86><a id=__codelineno-3-86 name=__codelineno-3-86 href=#__codelineno-3-86></a>        <span class=k>return</span> <span class=mf>0.0</span>
</span><span id=__span-3-87><a id=__codelineno-3-87 name=__codelineno-3-87 href=#__codelineno-3-87></a>
</span><span id=__span-3-88><a id=__codelineno-3-88 name=__codelineno-3-88 href=#__codelineno-3-88></a>    <span class=c1># Count interactions by genre (this would require genre metadata)</span>
</span><span id=__span-3-89><a id=__codelineno-3-89 name=__codelineno-3-89 href=#__codelineno-3-89></a>    <span class=n>genre_counts</span> <span class=o>=</span> <span class=p>{}</span>
</span><span id=__span-3-90><a id=__codelineno-3-90 name=__codelineno-3-90 href=#__codelineno-3-90></a>    <span class=n>total_interactions</span> <span class=o>=</span> <span class=nb>len</span><span class=p>(</span><span class=n>user_sequence</span><span class=p>)</span>
</span><span id=__span-3-91><a id=__codelineno-3-91 name=__codelineno-3-91 href=#__codelineno-3-91></a>
</span><span id=__span-3-92><a id=__codelineno-3-92 name=__codelineno-3-92 href=#__codelineno-3-92></a>    <span class=k>for</span> <span class=n>interaction</span> <span class=ow>in</span> <span class=n>user_sequence</span><span class=p>:</span>
</span><span id=__span-3-93><a id=__codelineno-3-93 name=__codelineno-3-93 href=#__codelineno-3-93></a>        <span class=n>movie_idx</span> <span class=o>=</span> <span class=n>interaction</span><span class=p>[</span><span class=s1>&#39;movie_idx&#39;</span><span class=p>]</span>
</span><span id=__span-3-94><a id=__codelineno-3-94 name=__codelineno-3-94 href=#__codelineno-3-94></a>        <span class=c1># Get genre information for this movie (implementation depends on data structure)</span>
</span><span id=__span-3-95><a id=__codelineno-3-95 name=__codelineno-3-95 href=#__codelineno-3-95></a>        <span class=n>genres</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_get_movie_genres</span><span class=p>(</span><span class=n>movie_idx</span><span class=p>)</span>
</span><span id=__span-3-96><a id=__codelineno-3-96 name=__codelineno-3-96 href=#__codelineno-3-96></a>
</span><span id=__span-3-97><a id=__codelineno-3-97 name=__codelineno-3-97 href=#__codelineno-3-97></a>        <span class=k>for</span> <span class=n>genre</span> <span class=ow>in</span> <span class=n>genres</span><span class=p>:</span>
</span><span id=__span-3-98><a id=__codelineno-3-98 name=__codelineno-3-98 href=#__codelineno-3-98></a>            <span class=n>genre_counts</span><span class=p>[</span><span class=n>genre</span><span class=p>]</span> <span class=o>=</span> <span class=n>genre_counts</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>genre</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span> <span class=o>+</span> <span class=mi>1</span>
</span><span id=__span-3-99><a id=__codelineno-3-99 name=__codelineno-3-99 href=#__codelineno-3-99></a>
</span><span id=__span-3-100><a id=__codelineno-3-100 name=__codelineno-3-100 href=#__codelineno-3-100></a>    <span class=c1># Compute Shannon entropy: H = -Σ(p_i * log(p_i))</span>
</span><span id=__span-3-101><a id=__codelineno-3-101 name=__codelineno-3-101 href=#__codelineno-3-101></a>    <span class=n>entropy</span> <span class=o>=</span> <span class=mf>0.0</span>
</span><span id=__span-3-102><a id=__codelineno-3-102 name=__codelineno-3-102 href=#__codelineno-3-102></a>    <span class=k>for</span> <span class=n>count</span> <span class=ow>in</span> <span class=n>genre_counts</span><span class=o>.</span><span class=n>values</span><span class=p>():</span>
</span><span id=__span-3-103><a id=__codelineno-3-103 name=__codelineno-3-103 href=#__codelineno-3-103></a>        <span class=n>p_i</span> <span class=o>=</span> <span class=n>count</span> <span class=o>/</span> <span class=n>total_interactions</span>
</span><span id=__span-3-104><a id=__codelineno-3-104 name=__codelineno-3-104 href=#__codelineno-3-104></a>        <span class=k>if</span> <span class=n>p_i</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>:</span>
</span><span id=__span-3-105><a id=__codelineno-3-105 name=__codelineno-3-105 href=#__codelineno-3-105></a>            <span class=n>entropy</span> <span class=o>-=</span> <span class=n>p_i</span> <span class=o>*</span> <span class=n>np</span><span class=o>.</span><span class=n>log2</span><span class=p>(</span><span class=n>p_i</span><span class=p>)</span>
</span><span id=__span-3-106><a id=__codelineno-3-106 name=__codelineno-3-106 href=#__codelineno-3-106></a>
</span><span id=__span-3-107><a id=__codelineno-3-107 name=__codelineno-3-107 href=#__codelineno-3-107></a>    <span class=c1># Normalize by maximum possible entropy (log of number of genres)</span>
</span><span id=__span-3-108><a id=__codelineno-3-108 name=__codelineno-3-108 href=#__codelineno-3-108></a>    <span class=n>max_entropy</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>log2</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>genre_counts</span><span class=p>))</span> <span class=k>if</span> <span class=n>genre_counts</span> <span class=k>else</span> <span class=mi>1</span>
</span><span id=__span-3-109><a id=__codelineno-3-109 name=__codelineno-3-109 href=#__codelineno-3-109></a>    <span class=n>normalized_entropy</span> <span class=o>=</span> <span class=n>entropy</span> <span class=o>/</span> <span class=n>max_entropy</span> <span class=k>if</span> <span class=n>max_entropy</span> <span class=o>&gt;</span> <span class=mi>0</span> <span class=k>else</span> <span class=mi>0</span>
</span><span id=__span-3-110><a id=__codelineno-3-110 name=__codelineno-3-110 href=#__codelineno-3-110></a>
</span><span id=__span-3-111><a id=__codelineno-3-111 name=__codelineno-3-111 href=#__codelineno-3-111></a>    <span class=k>return</span> <span class=n>normalized_entropy</span>
</span><span id=__span-3-112><a id=__codelineno-3-112 name=__codelineno-3-112 href=#__codelineno-3-112></a>
</span><span id=__span-3-113><a id=__codelineno-3-113 name=__codelineno-3-113 href=#__codelineno-3-113></a><span class=k>def</span><span class=w> </span><span class=nf>_identify_failure_modes</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>evaluation_results</span><span class=p>:</span> <span class=n>Dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>Any</span><span class=p>])</span> <span class=o>-&gt;</span> <span class=n>Dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>Any</span><span class=p>]:</span>
</span><span id=__span-3-114><a id=__codelineno-3-114 name=__codelineno-3-114 href=#__codelineno-3-114></a><span class=w>    </span><span class=sd>&quot;&quot;&quot;</span>
</span><span id=__span-3-115><a id=__codelineno-3-115 name=__codelineno-3-115 href=#__codelineno-3-115></a><span class=sd>    Systematic identification of failure patterns in the integrated system.</span>
</span><span id=__span-3-116><a id=__codelineno-3-116 name=__codelineno-3-116 href=#__codelineno-3-116></a>
</span><span id=__span-3-117><a id=__codelineno-3-117 name=__codelineno-3-117 href=#__codelineno-3-117></a><span class=sd>    Mathematical analysis of cases where performance falls below expectations,</span>
</span><span id=__span-3-118><a id=__codelineno-3-118 name=__codelineno-3-118 href=#__codelineno-3-118></a><span class=sd>    with statistical classification of failure types and their frequencies.</span>
</span><span id=__span-3-119><a id=__codelineno-3-119 name=__codelineno-3-119 href=#__codelineno-3-119></a><span class=sd>    &quot;&quot;&quot;</span>
</span><span id=__span-3-120><a id=__codelineno-3-120 name=__codelineno-3-120 href=#__codelineno-3-120></a>    <span class=n>failure_modes</span> <span class=o>=</span> <span class=p>{</span>
</span><span id=__span-3-121><a id=__codelineno-3-121 name=__codelineno-3-121 href=#__codelineno-3-121></a>        <span class=s1>&#39;retrieval_failures&#39;</span><span class=p>:</span> <span class=p>[],</span>    <span class=c1># Two-tower failed to find relevant items</span>
</span><span id=__span-3-122><a id=__codelineno-3-122 name=__codelineno-3-122 href=#__codelineno-3-122></a>        <span class=s1>&#39;ranking_failures&#39;</span><span class=p>:</span> <span class=p>[],</span>     <span class=c1># BERT4Rec failed to rank well despite good candidates</span>
</span><span id=__span-3-123><a id=__codelineno-3-123 name=__codelineno-3-123 href=#__codelineno-3-123></a>        <span class=s1>&#39;cascade_failures&#39;</span><span class=p>:</span> <span class=p>[],</span>     <span class=c1># Poor interaction between stages</span>
</span><span id=__span-3-124><a id=__codelineno-3-124 name=__codelineno-3-124 href=#__codelineno-3-124></a>        <span class=s1>&#39;cold_start_failures&#39;</span><span class=p>:</span> <span class=p>[]</span>   <span class=c1># New users or items with insufficient data</span>
</span><span id=__span-3-125><a id=__codelineno-3-125 name=__codelineno-3-125 href=#__codelineno-3-125></a>    <span class=p>}</span>
</span><span id=__span-3-126><a id=__codelineno-3-126 name=__codelineno-3-126 href=#__codelineno-3-126></a>
</span><span id=__span-3-127><a id=__codelineno-3-127 name=__codelineno-3-127 href=#__codelineno-3-127></a>    <span class=n>failure_threshold</span> <span class=o>=</span> <span class=mf>0.1</span>  <span class=c1># Define poor performance as recall &lt; 0.1</span>
</span><span id=__span-3-128><a id=__codelineno-3-128 name=__codelineno-3-128 href=#__codelineno-3-128></a>
</span><span id=__span-3-129><a id=__codelineno-3-129 name=__codelineno-3-129 href=#__codelineno-3-129></a>    <span class=k>for</span> <span class=n>user_result</span> <span class=ow>in</span> <span class=n>evaluation_results</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;individual_results&#39;</span><span class=p>,</span> <span class=p>[]):</span>
</span><span id=__span-3-130><a id=__codelineno-3-130 name=__codelineno-3-130 href=#__codelineno-3-130></a>        <span class=n>user_idx</span> <span class=o>=</span> <span class=n>user_result</span><span class=p>[</span><span class=s1>&#39;user_idx&#39;</span><span class=p>]</span>
</span><span id=__span-3-131><a id=__codelineno-3-131 name=__codelineno-3-131 href=#__codelineno-3-131></a>
</span><span id=__span-3-132><a id=__codelineno-3-132 name=__codelineno-3-132 href=#__codelineno-3-132></a>        <span class=c1># Analyze each configuration to identify failure patterns</span>
</span><span id=__span-3-133><a id=__codelineno-3-133 name=__codelineno-3-133 href=#__codelineno-3-133></a>        <span class=k>for</span> <span class=n>config_key</span><span class=p>,</span> <span class=n>config_result</span> <span class=ow>in</span> <span class=n>user_result</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;results_by_config&#39;</span><span class=p>,</span> <span class=p>{})</span><span class=o>.</span><span class=n>items</span><span class=p>():</span>
</span><span id=__span-3-134><a id=__codelineno-3-134 name=__codelineno-3-134 href=#__codelineno-3-134></a>            <span class=k>if</span> <span class=s1>&#39;error&#39;</span> <span class=ow>in</span> <span class=n>config_result</span><span class=p>:</span>
</span><span id=__span-3-135><a id=__codelineno-3-135 name=__codelineno-3-135 href=#__codelineno-3-135></a>                <span class=k>continue</span>
</span><span id=__span-3-136><a id=__codelineno-3-136 name=__codelineno-3-136 href=#__codelineno-3-136></a>
</span><span id=__span-3-137><a id=__codelineno-3-137 name=__codelineno-3-137 href=#__codelineno-3-137></a>            <span class=c1># Extract performance metrics for failure analysis</span>
</span><span id=__span-3-138><a id=__codelineno-3-138 name=__codelineno-3-138 href=#__codelineno-3-138></a>            <span class=n>final_recall</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_extract_recall_metric</span><span class=p>(</span><span class=n>config_result</span><span class=p>)</span>
</span><span id=__span-3-139><a id=__codelineno-3-139 name=__codelineno-3-139 href=#__codelineno-3-139></a>            <span class=n>retrieval_recall</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_extract_retrieval_recall</span><span class=p>(</span><span class=n>config_result</span><span class=p>)</span>
</span><span id=__span-3-140><a id=__codelineno-3-140 name=__codelineno-3-140 href=#__codelineno-3-140></a>
</span><span id=__span-3-141><a id=__codelineno-3-141 name=__codelineno-3-141 href=#__codelineno-3-141></a>            <span class=k>if</span> <span class=n>final_recall</span> <span class=o>&lt;</span> <span class=n>failure_threshold</span><span class=p>:</span>
</span><span id=__span-3-142><a id=__codelineno-3-142 name=__codelineno-3-142 href=#__codelineno-3-142></a>                <span class=c1># Classify the type of failure based on mathematical criteria</span>
</span><span id=__span-3-143><a id=__codelineno-3-143 name=__codelineno-3-143 href=#__codelineno-3-143></a>                <span class=k>if</span> <span class=n>retrieval_recall</span> <span class=o>&lt;</span> <span class=n>failure_threshold</span><span class=p>:</span>
</span><span id=__span-3-144><a id=__codelineno-3-144 name=__codelineno-3-144 href=#__codelineno-3-144></a>                    <span class=n>failure_type</span> <span class=o>=</span> <span class=s1>&#39;retrieval_failures&#39;</span>
</span><span id=__span-3-145><a id=__codelineno-3-145 name=__codelineno-3-145 href=#__codelineno-3-145></a>                <span class=k>elif</span> <span class=n>retrieval_recall</span> <span class=o>&gt;</span> <span class=mf>0.5</span> <span class=ow>and</span> <span class=n>final_recall</span> <span class=o>&lt;</span> <span class=n>retrieval_recall</span> <span class=o>*</span> <span class=mf>0.3</span><span class=p>:</span>
</span><span id=__span-3-146><a id=__codelineno-3-146 name=__codelineno-3-146 href=#__codelineno-3-146></a>                    <span class=n>failure_type</span> <span class=o>=</span> <span class=s1>&#39;ranking_failures&#39;</span>  
</span><span id=__span-3-147><a id=__codelineno-3-147 name=__codelineno-3-147 href=#__codelineno-3-147></a>                <span class=k>elif</span> <span class=n>retrieval_recall</span> <span class=o>&gt;</span> <span class=mf>0.3</span> <span class=ow>and</span> <span class=n>final_recall</span> <span class=o>&lt;</span> <span class=mf>0.1</span><span class=p>:</span>
</span><span id=__span-3-148><a id=__codelineno-3-148 name=__codelineno-3-148 href=#__codelineno-3-148></a>                    <span class=n>failure_type</span> <span class=o>=</span> <span class=s1>&#39;cascade_failures&#39;</span>
</span><span id=__span-3-149><a id=__codelineno-3-149 name=__codelineno-3-149 href=#__codelineno-3-149></a>                <span class=k>else</span><span class=p>:</span>
</span><span id=__span-3-150><a id=__codelineno-3-150 name=__codelineno-3-150 href=#__codelineno-3-150></a>                    <span class=n>failure_type</span> <span class=o>=</span> <span class=s1>&#39;cold_start_failures&#39;</span>
</span><span id=__span-3-151><a id=__codelineno-3-151 name=__codelineno-3-151 href=#__codelineno-3-151></a>
</span><span id=__span-3-152><a id=__codelineno-3-152 name=__codelineno-3-152 href=#__codelineno-3-152></a>                <span class=n>failure_modes</span><span class=p>[</span><span class=n>failure_type</span><span class=p>]</span><span class=o>.</span><span class=n>append</span><span class=p>({</span>
</span><span id=__span-3-153><a id=__codelineno-3-153 name=__codelineno-3-153 href=#__codelineno-3-153></a>                    <span class=s1>&#39;user_idx&#39;</span><span class=p>:</span> <span class=n>user_idx</span><span class=p>,</span>
</span><span id=__span-3-154><a id=__codelineno-3-154 name=__codelineno-3-154 href=#__codelineno-3-154></a>                    <span class=s1>&#39;config&#39;</span><span class=p>:</span> <span class=n>config_key</span><span class=p>,</span>
</span><span id=__span-3-155><a id=__codelineno-3-155 name=__codelineno-3-155 href=#__codelineno-3-155></a>                    <span class=s1>&#39;final_recall&#39;</span><span class=p>:</span> <span class=n>final_recall</span><span class=p>,</span>
</span><span id=__span-3-156><a id=__codelineno-3-156 name=__codelineno-3-156 href=#__codelineno-3-156></a>                    <span class=s1>&#39;retrieval_recall&#39;</span><span class=p>:</span> <span class=n>retrieval_recall</span><span class=p>,</span>
</span><span id=__span-3-157><a id=__codelineno-3-157 name=__codelineno-3-157 href=#__codelineno-3-157></a>                    <span class=s1>&#39;failure_severity&#39;</span><span class=p>:</span> <span class=n>failure_threshold</span> <span class=o>-</span> <span class=n>final_recall</span>
</span><span id=__span-3-158><a id=__codelineno-3-158 name=__codelineno-3-158 href=#__codelineno-3-158></a>                <span class=p>})</span>
</span><span id=__span-3-159><a id=__codelineno-3-159 name=__codelineno-3-159 href=#__codelineno-3-159></a>
</span><span id=__span-3-160><a id=__codelineno-3-160 name=__codelineno-3-160 href=#__codelineno-3-160></a>    <span class=c1># Statistical analysis of failure patterns</span>
</span><span id=__span-3-161><a id=__codelineno-3-161 name=__codelineno-3-161 href=#__codelineno-3-161></a>    <span class=n>failure_statistics</span> <span class=o>=</span> <span class=p>{}</span>
</span><span id=__span-3-162><a id=__codelineno-3-162 name=__codelineno-3-162 href=#__codelineno-3-162></a>    <span class=k>for</span> <span class=n>failure_type</span><span class=p>,</span> <span class=n>failures</span> <span class=ow>in</span> <span class=n>failure_modes</span><span class=o>.</span><span class=n>items</span><span class=p>():</span>
</span><span id=__span-3-163><a id=__codelineno-3-163 name=__codelineno-3-163 href=#__codelineno-3-163></a>        <span class=k>if</span> <span class=n>failures</span><span class=p>:</span>
</span><span id=__span-3-164><a id=__codelineno-3-164 name=__codelineno-3-164 href=#__codelineno-3-164></a>            <span class=n>failure_statistics</span><span class=p>[</span><span class=n>failure_type</span><span class=p>]</span> <span class=o>=</span> <span class=p>{</span>
</span><span id=__span-3-165><a id=__codelineno-3-165 name=__codelineno-3-165 href=#__codelineno-3-165></a>                <span class=s1>&#39;count&#39;</span><span class=p>:</span> <span class=nb>len</span><span class=p>(</span><span class=n>failures</span><span class=p>),</span>
</span><span id=__span-3-166><a id=__codelineno-3-166 name=__codelineno-3-166 href=#__codelineno-3-166></a>                <span class=s1>&#39;avg_severity&#39;</span><span class=p>:</span> <span class=n>np</span><span class=o>.</span><span class=n>mean</span><span class=p>([</span><span class=n>f</span><span class=p>[</span><span class=s1>&#39;failure_severity&#39;</span><span class=p>]</span> <span class=k>for</span> <span class=n>f</span> <span class=ow>in</span> <span class=n>failures</span><span class=p>]),</span>
</span><span id=__span-3-167><a id=__codelineno-3-167 name=__codelineno-3-167 href=#__codelineno-3-167></a>                <span class=s1>&#39;affected_user_rate&#39;</span><span class=p>:</span> <span class=nb>len</span><span class=p>(</span><span class=nb>set</span><span class=p>(</span><span class=n>f</span><span class=p>[</span><span class=s1>&#39;user_idx&#39;</span><span class=p>]</span> <span class=k>for</span> <span class=n>f</span> <span class=ow>in</span> <span class=n>failures</span><span class=p>))</span> <span class=o>/</span> <span class=nb>len</span><span class=p>(</span><span class=n>evaluation_results</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;individual_results&#39;</span><span class=p>,</span> <span class=p>[]))</span>
</span><span id=__span-3-168><a id=__codelineno-3-168 name=__codelineno-3-168 href=#__codelineno-3-168></a>            <span class=p>}</span>
</span><span id=__span-3-169><a id=__codelineno-3-169 name=__codelineno-3-169 href=#__codelineno-3-169></a>
</span><span id=__span-3-170><a id=__codelineno-3-170 name=__codelineno-3-170 href=#__codelineno-3-170></a>    <span class=k>return</span> <span class=p>{</span>
</span><span id=__span-3-171><a id=__codelineno-3-171 name=__codelineno-3-171 href=#__codelineno-3-171></a>        <span class=s1>&#39;failure_modes&#39;</span><span class=p>:</span> <span class=n>failure_modes</span><span class=p>,</span>
</span><span id=__span-3-172><a id=__codelineno-3-172 name=__codelineno-3-172 href=#__codelineno-3-172></a>        <span class=s1>&#39;failure_statistics&#39;</span><span class=p>:</span> <span class=n>failure_statistics</span>
</span><span id=__span-3-173><a id=__codelineno-3-173 name=__codelineno-3-173 href=#__codelineno-3-173></a>    <span class=p>}</span>
</span></code></pre></div> <p>This diagnostic framework provides mathematical tools for understanding system behavior at a granular level. The user segmentation analysis reveals how different types of users benefit from your integrated approach, while the failure mode analysis identifies specific patterns that need attention.</p> <p>The mathematical foundations underlying these diagnostic tools enable systematic optimization of your recommendation system. Instead of making general architectural changes, you can target specific improvements that address the most common failure modes or enhance performance for the most important user segments.</p> <p>This comprehensive evaluation framework transforms the complex task of assessing integrated recommendation systems into a systematic process that provides actionable insights for improving user experience and system performance.</p> <aside class=md-source-file> <span class=md-source-file__fact> <span class=md-icon title="Last update"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M21 13.1c-.1 0-.3.1-.4.2l-1 1 2.1 2.1 1-1c.2-.2.2-.6 0-.8l-1.3-1.3c-.1-.1-.2-.2-.4-.2m-1.9 1.8-6.1 6V23h2.1l6.1-6.1zM12.5 7v5.2l4 2.4-1 1L11 13V7zM11 21.9c-5.1-.5-9-4.8-9-9.9C2 6.5 6.5 2 12 2c5.3 0 9.6 4.1 10 9.3-.3-.1-.6-.2-1-.2s-.7.1-1 .2C19.6 7.2 16.2 4 12 4c-4.4 0-8 3.6-8 8 0 4.1 3.1 7.5 7.1 7.9l-.1.2z"/></svg> </span> <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-date" title="September 26, 2025 18:54:36 UTC">September 26, 2025</span> </span> <span class=md-source-file__fact> <span class=md-icon title=Created> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M14.47 15.08 11 13V7h1.5v5.25l3.08 1.83c-.41.28-.79.62-1.11 1m-1.39 4.84c-.36.05-.71.08-1.08.08-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8c0 .37-.03.72-.08 1.08.69.1 1.33.32 1.92.64.1-.56.16-1.13.16-1.72 0-5.5-4.5-10-10-10S2 6.5 2 12s4.47 10 10 10c.59 0 1.16-.06 1.72-.16-.32-.59-.54-1.23-.64-1.92M18 15v3h-3v2h3v3h2v-3h3v-2h-3v-3z"/></svg> </span> <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-date" title="September 26, 2025 18:54:36 UTC">September 26, 2025</span> </span> </aside> </article> </div> <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var labels=set.querySelector(".tabbed-labels");for(var tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script> <script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script> </div> <button type=button class="md-top md-icon" data-md-component=top hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg> Back to top </button> </main> <footer class=md-footer> <nav class="md-footer__inner md-grid" aria-label=Footer> <a href=../semantic-search/ class="md-footer__link md-footer__link--prev" aria-label="Previous: Semantic Search"> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg> </div> <div class=md-footer__title> <span class=md-footer__direction> Previous </span> <div class=md-ellipsis> Semantic Search </div> </div> </a> <a href=../../backend-frontend/backend-integration/ class="md-footer__link md-footer__link--next" aria-label="Next: Backend Integration"> <div class=md-footer__title> <span class=md-footer__direction> Next </span> <div class=md-ellipsis> Backend Integration </div> </div> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11z"/></svg> </div> </a> </nav> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-copyright> <div class=md-copyright__highlight> Copyright &copy; 2024 Movie Genie </div> Made with <a href=https://squidfunk.github.io/mkdocs-material/ target=_blank rel=noopener> Material for MkDocs </a> </div> <div class=md-social> <a href=https://github.com/your-username/movie-genie target=_blank rel=noopener title=github.com class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 512 512"><!-- Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg> </a> <a href=https://pypi.org/project/movie-genie/ target=_blank rel=noopener title=pypi.org class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.8 200.5c-7.7-30.9-22.3-54.2-53.4-54.2h-40.1v47.4c0 36.8-31.2 67.8-66.8 67.8H172.7c-29.2 0-53.4 25-53.4 54.3v101.8c0 29 25.2 46 53.4 54.3 33.8 9.9 66.3 11.7 106.8 0 26.9-7.8 53.4-23.5 53.4-54.3v-40.7H226.2v-13.6h160.2c31.1 0 42.6-21.7 53.4-54.2 11.2-33.5 10.7-65.7 0-108.6M286.2 444.7a20.4 20.4 0 1 1 0-40.7 20.4 20.4 0 1 1 0 40.7M167.8 248.1h106.8c29.7 0 53.4-24.5 53.4-54.3V91.9c0-29-24.4-50.7-53.4-55.6-35.8-5.9-74.7-5.6-106.8.1-45.2 8-53.4 24.7-53.4 55.6v40.7h106.9v13.6h-147c-31.1 0-58.3 18.7-66.8 54.2-9.8 40.7-10.2 66.1 0 108.6 7.6 31.6 25.7 54.2 56.8 54.2H101v-48.8c0-35.3 30.5-66.4 66.8-66.4m-6.6-183.4a20.4 20.4 0 1 1 0 40.8 20.4 20.4 0 1 1 0-40.8"/></svg> </a> <a href=https://twitter.com/your-username target=_blank rel=noopener title=twitter.com class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 512 512"><!-- Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M459.4 151.7c.3 4.5.3 9.1.3 13.6 0 138.7-105.6 298.6-298.6 298.6-59.5 0-114.7-17.2-161.1-47.1 8.4 1 16.6 1.3 25.3 1.3 49.1 0 94.2-16.6 130.3-44.8-46.1-1-84.8-31.2-98.1-72.8 6.5 1 13 1.6 19.8 1.6 9.4 0 18.8-1.3 27.6-3.6-48.1-9.7-84.1-52-84.1-103v-1.3c14 7.8 30.2 12.7 47.4 13.3-28.3-18.8-46.8-51-46.8-87.4 0-19.5 5.2-37.4 14.3-53C87.4 130.8 165 172.4 252.1 176.9c-1.6-7.8-2.6-15.9-2.6-24C249.5 95.1 296.3 48 354.4 48c30.2 0 57.5 12.7 76.7 33.1 23.7-4.5 46.5-13.3 66.6-25.3-7.8 24.4-24.4 44.8-46.1 57.8 21.1-2.3 41.6-8.1 60.4-16.2-14.3 20.8-32.2 39.3-52.6 54.3"/></svg> </a> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <div class=md-progress data-md-component=progress role=progressbar></div> <script id=__config type=application/json>{"base": "../..", "features": ["announce.dismiss", "content.action.edit", "content.action.view", "content.code.annotate", "content.code.copy", "content.code.select", "content.tabs.link", "content.tooltips", "header.autohide", "navigation.expand", "navigation.footer", "navigation.indexes", "navigation.instant", "navigation.instant.prefetch", "navigation.instant.progress", "navigation.prune", "navigation.sections", "navigation.tabs", "navigation.tabs.sticky", "navigation.top", "navigation.tracking", "search.highlight", "search.share", "search.suggest", "toc.follow"], "search": "../../assets/javascripts/workers/search.973d3a69.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script> <script src=../../assets/javascripts/bundle.f55a23d4.min.js></script> <script src=../../javascripts/mathjax.js></script> <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script> </body> </html>