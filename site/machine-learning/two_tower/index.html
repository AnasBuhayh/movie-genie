<!doctype html><html lang=en class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="AI-powered movie recommendation system - Complete learning reference"><meta name=author content="Movie Genie Team"><link href=https://your-username.github.io/movie-genie/machine-learning/two_tower/ rel=canonical><link rel=icon href=../../assets/favicon.ico><meta name=generator content="mkdocs-1.6.1, mkdocs-material-9.6.20"><title>Two-Tower Model Architecture: Mathematical Foundations and Implementation Guide - Movie Genie Documentation</title><link rel=stylesheet href=../../assets/stylesheets/main.e53b48f4.min.css><link rel=stylesheet href=../../assets/stylesheets/palette.06af60db.min.css><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback"><style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style><link rel=stylesheet href=../../stylesheets/extra.css><script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script><script id=__analytics>function __md_analytics(){function e(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],e("js",new Date),e("config",""),document.addEventListener("DOMContentLoaded",(function(){document.forms.search&&document.forms.search.query.addEventListener("blur",(function(){this.value&&e("event","search",{search_term:this.value})}));document$.subscribe((function(){var t=document.forms.feedback;if(void 0!==t)for(var a of t.querySelectorAll("[type=submit]"))a.addEventListener("click",(function(a){a.preventDefault();var n=document.location.pathname,d=this.getAttribute("data-md-value");e("event","feedback",{page:n,data:d}),t.firstElementChild.disabled=!0;var r=t.querySelector(".md-feedback__note [data-md-value='"+d+"']");r&&(r.hidden=!1)})),t.hidden=!1})),location$.subscribe((function(t){e("config","",{page_path:t.pathname})}))}));var t=document.createElement("script");t.async=!0,t.src="https://www.googletagmanager.com/gtag/js?id=",document.getElementById("__analytics").insertAdjacentElement("afterEnd",t)}</script><script>"undefined"!=typeof __md_analytics&&__md_analytics()</script></head> <body dir=ltr data-md-color-scheme=default data-md-color-primary=indigo data-md-color-accent=indigo> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#two-tower-model-architecture-mathematical-foundations-and-implementation-guide class=md-skip> Skip to content </a> </div> <div data-md-component=announce> </div> <header class="md-header md-header--shadow md-header--lifted" data-md-component=header> <nav class="md-header__inner md-grid" aria-label=Header> <a href=../.. title="Movie Genie Documentation" class="md-header__button md-logo" aria-label="Movie Genie Documentation" data-md-component=logo> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="m18 4 2 4h-3l-2-4h-2l2 4h-3l-2-4H8l2 4H7L5 4H4a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V4z"/></svg> </a> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> Movie Genie Documentation </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> Two-Tower Model Architecture: Mathematical Foundations and Implementation Guide </span> </div> </div> </div> <form class=md-header__option data-md-component=palette> <input class=md-option data-md-color-media data-md-color-scheme=default data-md-color-primary=indigo data-md-color-accent=indigo aria-label="Switch to dark mode" type=radio name=__palette id=__palette_0> <label class="md-header__button md-icon" title="Switch to dark mode" for=__palette_1 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg> </label> <input class=md-option data-md-color-media data-md-color-scheme=slate data-md-color-primary=indigo data-md-color-accent=indigo aria-label="Switch to light mode" type=radio name=__palette id=__palette_1> <label class="md-header__button md-icon" title="Switch to light mode" for=__palette_0 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg> </label> </form> <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=Search placeholder=Search autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg> </label> <nav class=md-search__options aria-label=Search> <a href=javascript:void(0) class="md-search__icon md-icon" title=Share aria-label=Share data-clipboard data-clipboard-text data-md-component=search-share tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91s2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08"/></svg> </a> <button type=reset class="md-search__icon md-icon" title=Clear aria-label=Clear tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg> </button> </nav> <div class=md-search__suggest data-md-component=search-suggest></div> </form> <div class=md-search__output> <div class=md-search__scrollwrap tabindex=0 data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> Initializing search </div> <ol class=md-search-result__list role=presentation></ol> </div> </div> </div> </div> </div> <div class=md-header__source> <a href=https://github.com/your-username/movie-genie title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg> </div> <div class=md-source__repository> movie-genie </div> </a> </div> </nav> <nav class=md-tabs aria-label=Tabs data-md-component=tabs> <div class=md-grid> <ul class=md-tabs__list> <li class=md-tabs__item> <a href=../.. class=md-tabs__link> Home </a> </li> <li class=md-tabs__item> <a href=../../getting-started/ class=md-tabs__link> Getting Started </a> </li> <li class=md-tabs__item> <a href=../index.md class=md-tabs__link> Machine Learning </a> </li> <li class=md-tabs__item> <a href=../../data-pipeline/index.md class=md-tabs__link> Data Pipeline </a> </li> <li class=md-tabs__item> <a href=../../backend-frontend/index.md class=md-tabs__link> Backend & Frontend </a> </li> <li class=md-tabs__item> <a href=../../deployment/index.md class=md-tabs__link> Deployment </a> </li> <li class=md-tabs__item> <a href=../../configuration/index.md class=md-tabs__link> Configuration </a> </li> <li class=md-tabs__item> <a href=../../troubleshooting/index.md class=md-tabs__link> Troubleshooting </a> </li> <li class=md-tabs__item> <a href=../../reference/index.md class=md-tabs__link> Reference </a> </li> </ul> </div> </nav> </header> <div class=md-container data-md-component=container> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary md-nav--lifted" aria-label=Navigation data-md-level=0> <label class=md-nav__title for=__drawer> <a href=../.. title="Movie Genie Documentation" class="md-nav__button md-logo" aria-label="Movie Genie Documentation" data-md-component=logo> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="m18 4 2 4h-3l-2-4h-2l2 4h-3l-2-4H8l2 4H7L5 4H4a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V4z"/></svg> </a> Movie Genie Documentation </label> <div class=md-nav__source> <a href=https://github.com/your-username/movie-genie title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg> </div> <div class=md-source__repository> movie-genie </div> </a> </div> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../.. class=md-nav__link> <span class=md-ellipsis> Home </span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../getting-started/ class=md-nav__link> <span class=md-ellipsis> Getting Started </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../index.md class=md-nav__link> <span class=md-ellipsis> Machine Learning </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../data-pipeline/index.md class=md-nav__link> <span class=md-ellipsis> Data Pipeline </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../backend-frontend/index.md class=md-nav__link> <span class=md-ellipsis> Backend & Frontend </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../deployment/index.md class=md-nav__link> <span class=md-ellipsis> Deployment </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../configuration/index.md class=md-nav__link> <span class=md-ellipsis> Configuration </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../troubleshooting/index.md class=md-nav__link> <span class=md-ellipsis> Troubleshooting </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../reference/index.md class=md-nav__link> <span class=md-ellipsis> Reference </span> <span class="md-nav__icon md-icon"></span> </a> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=sidebar data-md-type=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#executive-summary class=md-nav__link> <span class=md-ellipsis> Executive Summary </span> </a> </li> <li class=md-nav__item> <a href=#problem-definition-and-mathematical-formulation class=md-nav__link> <span class=md-ellipsis> Problem Definition and Mathematical Formulation </span> </a> <nav class=md-nav aria-label="Problem Definition and Mathematical Formulation"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#the-recommendation-scalability-challenge class=md-nav__link> <span class=md-ellipsis> The Recommendation Scalability Challenge </span> </a> </li> <li class=md-nav__item> <a href=#two-tower-mathematical-framework class=md-nav__link> <span class=md-ellipsis> Two-Tower Mathematical Framework </span> </a> </li> <li class=md-nav__item> <a href=#collaborative-filtering-through-embedding-learning class=md-nav__link> <span class=md-ellipsis> Collaborative Filtering Through Embedding Learning </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#neural-network-architecture-design class=md-nav__link> <span class=md-ellipsis> Neural Network Architecture Design </span> </a> <nav class=md-nav aria-label="Neural Network Architecture Design"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#user-tower-architecture class=md-nav__link> <span class=md-ellipsis> User Tower Architecture </span> </a> </li> <li class=md-nav__item> <a href=#item-tower-architecture class=md-nav__link> <span class=md-ellipsis> Item Tower Architecture </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#training-objective-and-loss-function class=md-nav__link> <span class=md-ellipsis> Training Objective and Loss Function </span> </a> <nav class=md-nav aria-label="Training Objective and Loss Function"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#contrastive-learning-framework class=md-nav__link> <span class=md-ellipsis> Contrastive Learning Framework </span> </a> </li> <li class=md-nav__item> <a href=#ranking-loss-function class=md-nav__link> <span class=md-ellipsis> Ranking Loss Function </span> </a> </li> <li class=md-nav__item> <a href=#alternative-binary-cross-entropy-loss class=md-nav__link> <span class=md-ellipsis> Alternative: Binary Cross-Entropy Loss </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#implementation-architecture class=md-nav__link> <span class=md-ellipsis> Implementation Architecture </span> </a> <nav class=md-nav aria-label="Implementation Architecture"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#twotowermodel-class-structure class=md-nav__link> <span class=md-ellipsis> TwoTowerModel Class Structure </span> </a> </li> <li class=md-nav__item> <a href=#data-processing-pipeline class=md-nav__link> <span class=md-ellipsis> Data Processing Pipeline </span> </a> <nav class=md-nav aria-label="Data Processing Pipeline"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#feature-preparation class=md-nav__link> <span class=md-ellipsis> Feature Preparation </span> </a> </li> <li class=md-nav__item> <a href=#training-example-generation class=md-nav__link> <span class=md-ellipsis> Training Example Generation </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#mathematical-properties-and-theoretical-foundations class=md-nav__link> <span class=md-ellipsis> Mathematical Properties and Theoretical Foundations </span> </a> <nav class=md-nav aria-label="Mathematical Properties and Theoretical Foundations"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#embedding-space-geometry class=md-nav__link> <span class=md-ellipsis> Embedding Space Geometry </span> </a> </li> <li class=md-nav__item> <a href=#collaborative-filtering-through-matrix-factorization class=md-nav__link> <span class=md-ellipsis> Collaborative Filtering Through Matrix Factorization </span> </a> </li> <li class=md-nav__item> <a href=#content-collaborative-hybridization class=md-nav__link> <span class=md-ellipsis> Content-Collaborative Hybridization </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#computational-complexity-and-scalability-analysis class=md-nav__link> <span class=md-ellipsis> Computational Complexity and Scalability Analysis </span> </a> <nav class=md-nav aria-label="Computational Complexity and Scalability Analysis"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#training-complexity class=md-nav__link> <span class=md-ellipsis> Training Complexity </span> </a> </li> <li class=md-nav__item> <a href=#inference-complexity class=md-nav__link> <span class=md-ellipsis> Inference Complexity </span> </a> </li> <li class=md-nav__item> <a href=#memory-requirements class=md-nav__link> <span class=md-ellipsis> Memory Requirements </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#integration-with-existing-pipeline-architecture class=md-nav__link> <span class=md-ellipsis> Integration with Existing Pipeline Architecture </span> </a> <nav class=md-nav aria-label="Integration with Existing Pipeline Architecture"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#dvc-pipeline-extension class=md-nav__link> <span class=md-ellipsis> DVC Pipeline Extension </span> </a> </li> <li class=md-nav__item> <a href=#feature-engineering-integration class=md-nav__link> <span class=md-ellipsis> Feature Engineering Integration </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#evaluation-framework-and-success-metrics class=md-nav__link> <span class=md-ellipsis> Evaluation Framework and Success Metrics </span> </a> <nav class=md-nav aria-label="Evaluation Framework and Success Metrics"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#retrieval-quality-metrics class=md-nav__link> <span class=md-ellipsis> Retrieval Quality Metrics </span> </a> </li> <li class=md-nav__item> <a href=#computational-performance-metrics class=md-nav__link> <span class=md-ellipsis> Computational Performance Metrics </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#production-deployment-considerations class=md-nav__link> <span class=md-ellipsis> Production Deployment Considerations </span> </a> <nav class=md-nav aria-label="Production Deployment Considerations"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#embedding-caching-strategy class=md-nav__link> <span class=md-ellipsis> Embedding Caching Strategy </span> </a> </li> <li class=md-nav__item> <a href=#model-update-pipeline class=md-nav__link> <span class=md-ellipsis> Model Update Pipeline </span> </a> </li> <li class=md-nav__item> <a href=#scalability-architecture class=md-nav__link> <span class=md-ellipsis> Scalability Architecture </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#conclusion-and-future-directions class=md-nav__link> <span class=md-ellipsis> Conclusion and Future Directions </span> </a> </li> </ul> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <article class="md-content__inner md-typeset"> <a href=https://github.com/your-username/movie-genie/edit/main/docs/machine-learning/two_tower.md title="Edit this page" class="md-content__button md-icon" rel=edit> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M10 20H6V4h7v5h5v3.1l2-2V8l-6-6H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h4zm10.2-7c.1 0 .3.1.4.2l1.3 1.3c.2.2.2.6 0 .8l-1 1-2.1-2.1 1-1c.1-.1.2-.2.4-.2m0 3.9L14.1 23H12v-2.1l6.1-6.1z"/></svg> </a> <a href=https://github.com/your-username/movie-genie/raw/main/docs/machine-learning/two_tower.md title="View source of this page" class="md-content__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M17 18c.56 0 1 .44 1 1s-.44 1-1 1-1-.44-1-1 .44-1 1-1m0-3c-2.73 0-5.06 1.66-6 4 .94 2.34 3.27 4 6 4s5.06-1.66 6-4c-.94-2.34-3.27-4-6-4m0 6.5a2.5 2.5 0 0 1-2.5-2.5 2.5 2.5 0 0 1 2.5-2.5 2.5 2.5 0 0 1 2.5 2.5 2.5 2.5 0 0 1-2.5 2.5M9.27 20H6V4h7v5h5v4.07c.7.08 1.36.25 2 .49V8l-6-6H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h4.5a8.2 8.2 0 0 1-1.23-2"/></svg> </a> <h1 id=two-tower-model-architecture-mathematical-foundations-and-implementation-guide>Two-Tower Model Architecture: Mathematical Foundations and Implementation Guide<a class=headerlink href=#two-tower-model-architecture-mathematical-foundations-and-implementation-guide title="Permanent link">&para;</a></h1> <p><em>A comprehensive technical reference for neural collaborative filtering in movie recommendation systems</em></p> <h2 id=executive-summary>Executive Summary<a class=headerlink href=#executive-summary title="Permanent link">&para;</a></h2> <p>The two-tower model represents a scalable solution to the fundamental computational challenge in modern recommendation systems: how to serve personalized recommendations from massive catalogs within strict latency constraints. This document details the mathematical foundations, architectural decisions, and implementation strategies for a two-tower model designed for the Movie Genie recommendation system, integrating rich content features with collaborative filtering signals through neural network architectures.</p> <p>Our implementation addresses the specific characteristics of the Netflix thumbs rating system (-1.0, 1.0, 2.0) and leverages the sophisticated content features developed through TMDB metadata processing and EmbeddingGemma semantic analysis. The resulting architecture achieves the computational efficiency required for real-time recommendation serving while maintaining the recommendation quality benefits of hybrid collaborative and content-based approaches.</p> <h2 id=problem-definition-and-mathematical-formulation>Problem Definition and Mathematical Formulation<a class=headerlink href=#problem-definition-and-mathematical-formulation title="Permanent link">&para;</a></h2> <h3 id=the-recommendation-scalability-challenge>The Recommendation Scalability Challenge<a class=headerlink href=#the-recommendation-scalability-challenge title="Permanent link">&para;</a></h3> <p>Consider a recommendation system serving a catalog of <span class=arithmatex>\(|I|\)</span> items to <span class=arithmatex>\(|U|\)</span> users, where we wish to predict preference scores for all user-item pairs. The naive approach requires computing <span class=arithmatex>\(|U| \times |I|\)</span> compatibility scores per recommendation request. For realistic scales where <span class=arithmatex>\(|U| = 100,000\)</span> and <span class=arithmatex>\(|I| = 80,000\)</span>, this translates to <span class=arithmatex>\(8 \times 10^9\)</span> computations per request, creating an intractable computational burden.</p> <p>Let <span class=arithmatex>\(R \in \mathbb{R}^{|U| \times |I|}\)</span> represent the user-item interaction matrix, where <span class=arithmatex>\(R_{ui}\)</span> denotes user <span class=arithmatex>\(u\)</span>'s rating for item <span class=arithmatex>\(i\)</span>. Traditional collaborative filtering approaches learn a direct prediction function:</p> <div class=arithmatex>\[\hat{r}_{ui} = f(u, i, \Theta)\]</div> <p>where <span class=arithmatex>\(\Theta\)</span> represents model parameters. The computational complexity of this approach scales as <span class=arithmatex>\(O(|U| \times |I|)\)</span> for each recommendation request, making real-time serving impractical at scale.</p> <h3 id=two-tower-mathematical-framework>Two-Tower Mathematical Framework<a class=headerlink href=#two-tower-mathematical-framework title="Permanent link">&para;</a></h3> <p>The two-tower architecture reformulates the recommendation problem by learning separate embedding functions that map users and items into a shared <span class=arithmatex>\(d\)</span>-dimensional space:</p> <div class=arithmatex>\[\mathbf{e}_u = f_{\text{user}}(\mathbf{x}_u; \Theta_u) \in \mathbb{R}^d$$ $$\mathbf{e}_i = f_{\text{item}}(\mathbf{x}_i; \Theta_i) \in \mathbb{R}^d\]</div> <p>where <span class=arithmatex>\(\mathbf{x}_u\)</span> represents user features, <span class=arithmatex>\(\mathbf{x}_i\)</span> represents item features, and <span class=arithmatex>\(\Theta_u\)</span>, <span class=arithmatex>\(\Theta_i\)</span> are the respective tower parameters. The compatibility score becomes:</p> <div class=arithmatex>\[\hat{r}_{ui} = \mathbf{e}_u^T \mathbf{e}_i = \sum_{k=1}^{d} e_{uk} \cdot e_{ik}\]</div> <p>This formulation enables crucial computational optimizations. Since item features change infrequently, item embeddings <span class=arithmatex>\(\mathbf{e}_i\)</span> can be pre-computed and cached. Recommendation generation requires computing only the user embedding <span class=arithmatex>\(\mathbf{e}_u\)</span>, then performing <span class=arithmatex>\(O(|I|)\)</span> dot products against cached item embeddings, reducing the computational complexity from <span class=arithmatex>\(O(|U| \times |I|)\)</span> to <span class=arithmatex>\(O(|I|)\)</span> per request.</p> <h3 id=collaborative-filtering-through-embedding-learning>Collaborative Filtering Through Embedding Learning<a class=headerlink href=#collaborative-filtering-through-embedding-learning title="Permanent link">&para;</a></h3> <p>The learning process discovers embedding spaces where geometric relationships encode preference patterns. Users with similar preferences develop similar embedding vectors, while items that appeal to similar user segments cluster in the embedding space. This emergent structure enables collaborative filtering: the model can recommend items liked by users with similar embeddings, even without explicit content similarity.</p> <p>The mathematical foundation relies on the assumption that user preferences follow low-dimensional patterns that can be captured through embedding representations. The model learns these patterns by observing interaction data and adjusting embeddings to minimize prediction errors across the training dataset.</p> <h2 id=neural-network-architecture-design>Neural Network Architecture Design<a class=headerlink href=#neural-network-architecture-design title="Permanent link">&para;</a></h2> <h3 id=user-tower-architecture>User Tower Architecture<a class=headerlink href=#user-tower-architecture title="Permanent link">&para;</a></h3> <p>The user tower implements a neural network that transforms user characteristics into dense embeddings. For user <span class=arithmatex>\(u\)</span>, the forward pass follows:</p> <div class=arithmatex>\[\mathbf{h}_u^{(0)} = \mathbf{W}_{\text{emb}} \cdot \text{one\_hot}(u) \in \mathbb{R}^{d_{\text{emb}}}\]</div> <p>where <span class=arithmatex>\(\mathbf{W}_{\text{emb}} \in \mathbb{R}^{|U| \times d_{\text{emb}}}\)</span> represents learned user embeddings. The network then applies a series of fully connected transformations:</p> <div class=arithmatex>\[\mathbf{h}_u^{(l+1)} = \text{ReLU}(\mathbf{W}^{(l)} \mathbf{h}_u^{(l)} + \mathbf{b}^{(l)})\]</div> <p>for layers <span class=arithmatex>\(l = 0, 1, \ldots, L-1\)</span>. The final layer produces normalized embeddings:</p> <div class=arithmatex>\[\mathbf{e}_u = \frac{\mathbf{W}^{(L)} \mathbf{h}_u^{(L-1)} + \mathbf{b}^{(L)}}{\|\mathbf{W}^{(L)} \mathbf{h}_u^{(L-1)} + \mathbf{b}^{(L)}\|_2}\]</div> <p>The normalization ensures that <span class=arithmatex>\(\|\mathbf{e}_u\|_2 = 1\)</span>, making the dot product equivalent to cosine similarity and bounding similarity scores to the interval <span class=arithmatex>\([-1, 1]\)</span>.</p> <h3 id=item-tower-architecture>Item Tower Architecture<a class=headerlink href=#item-tower-architecture title="Permanent link">&para;</a></h3> <p>The item tower processes rich content features alongside learned item embeddings. For item <span class=arithmatex>\(i\)</span> with content features <span class=arithmatex>\(\mathbf{c}_i \in \mathbb{R}^{d_{\text{content}}}\)</span>, the input representation combines multiple feature types:</p> <div class=arithmatex>\[\mathbf{h}_i^{(0)} = [\mathbf{W}_{\text{item}} \cdot \text{one\_hot}(i); \mathbf{c}_i] \in \mathbb{R}^{d_{\text{item}} + d_{\text{content}}}\]</div> <p>where <span class=arithmatex>\([\cdot; \cdot]\)</span> denotes concatenation. The content features <span class=arithmatex>\(\mathbf{c}_i\)</span> include: - TMDB numerical features: <span class=arithmatex>\(\mathbf{c}_{\text{num}} \in \mathbb{R}^7\)</span> (budget, revenue, runtime, etc.) - One-hot language features: <span class=arithmatex>\(\mathbf{c}_{\text{lang}} \in \{0,1\}^{16}\)</span> - Categorical features: <span class=arithmatex>\(\mathbf{c}_{\text{cat}} \in \{0,1\}^5\)</span> - EmbeddingGemma text features: <span class=arithmatex>\(\mathbf{c}_{\text{text}} \in \mathbb{R}^{768}\)</span></p> <p>The combined feature vector <span class=arithmatex>\(\mathbf{c}_i = [\mathbf{c}_{\text{num}}; \mathbf{c}_{\text{lang}}; \mathbf{c}_{\text{cat}}; \mathbf{c}_{\text{text}}] \in \mathbb{R}^{796}\)</span> provides rich content representation that enables both content-based similarity and collaborative filtering within the same mathematical framework.</p> <p>The item tower applies the same multi-layer architecture as the user tower, producing normalized embeddings <span class=arithmatex>\(\mathbf{e}_i\)</span> that live in the same <span class=arithmatex>\(d\)</span>-dimensional space as user embeddings.</p> <h2 id=training-objective-and-loss-function>Training Objective and Loss Function<a class=headerlink href=#training-objective-and-loss-function title="Permanent link">&para;</a></h2> <h3 id=contrastive-learning-framework>Contrastive Learning Framework<a class=headerlink href=#contrastive-learning-framework title="Permanent link">&para;</a></h3> <p>The training process uses contrastive learning to teach the model to distinguish between positive and negative user-item interactions. Our Netflix thumbs rating system provides clear signals: - Thumbs down: <span class=arithmatex>\(r_{ui} = -1.0\)</span> (explicit negative) - Thumbs up: <span class=arithmatex>\(r_{ui} = 1.0\)</span> (positive) - Two thumbs up: <span class=arithmatex>\(r_{ui} = 2.0\)</span> (strong positive)</p> <p>For each training example, we sample positive pairs <span class=arithmatex>\((u, i^+)\)</span> where <span class=arithmatex>\(r_{ui^+} \geq 1.0\)</span> and negative pairs <span class=arithmatex>\((u, i^-)\)</span> where <span class=arithmatex>\(r_{ui^-} = -1.0\)</span> or through implicit negative sampling.</p> <h3 id=ranking-loss-function>Ranking Loss Function<a class=headerlink href=#ranking-loss-function title="Permanent link">&para;</a></h3> <p>The model learns through a ranking loss that encourages positive interactions to receive higher scores than negative interactions:</p> <div class=arithmatex>\[\mathcal{L} = \frac{1}{|\mathcal{B}|} \sum_{(u, i^+, i^-) \in \mathcal{B}} \max(0, \gamma - (\mathbf{e}_u^T \mathbf{e}_{i^+} - \mathbf{e}_u^T \mathbf{e}_{i^-}))\]</div> <p>where <span class=arithmatex>\(\mathcal{B}\)</span> represents a training batch, <span class=arithmatex>\(\gamma &gt; 0\)</span> is a margin parameter, and <span class=arithmatex>\((u, i^+, i^-)\)</span> are triplets consisting of a user, positive item, and negative item.</p> <p>This ranking loss implements the mathematical principle that drives collaborative filtering: users should have higher compatibility scores with items they prefer than with items they avoid. The margin <span class=arithmatex>\(\gamma\)</span> enforces a minimum separation between positive and negative scores, ensuring that the learned embeddings create clear preference boundaries.</p> <h3 id=alternative-binary-cross-entropy-loss>Alternative: Binary Cross-Entropy Loss<a class=headerlink href=#alternative-binary-cross-entropy-loss title="Permanent link">&para;</a></h3> <p>For scenarios with explicit ratings, we can formulate the problem as binary classification:</p> <div class=arithmatex>\[\mathcal{L}_{\text{BCE}} = -\frac{1}{|\mathcal{B}|} \sum_{(u,i,y) \in \mathcal{B}} [y \log(\sigma(\mathbf{e}_u^T \mathbf{e}_i)) + (1-y) \log(1-\sigma(\mathbf{e}_u^T \mathbf{e}_i))]\]</div> <p>where <span class=arithmatex>\(\sigma(\cdot)\)</span> is the sigmoid function and <span class=arithmatex>\(y \in \{0, 1\}\)</span> indicates positive or negative interaction. This formulation provides probabilistic interpretation of compatibility scores and often exhibits stable training characteristics.</p> <h2 id=implementation-architecture>Implementation Architecture<a class=headerlink href=#implementation-architecture title="Permanent link">&para;</a></h2> <h3 id=twotowermodel-class-structure>TwoTowerModel Class Structure<a class=headerlink href=#twotowermodel-class-structure title="Permanent link">&para;</a></h3> <p>Our implementation encapsulates the complete architecture in a PyTorch module that coordinates the user and item towers:</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-0-1><a id=__codelineno-0-1 name=__codelineno-0-1 href=#__codelineno-0-1></a><span class=k>class</span><span class=w> </span><span class=nc>TwoTowerModel</span><span class=p>(</span><span class=n>nn</span><span class=o>.</span><span class=n>Module</span><span class=p>):</span>
</span><span id=__span-0-2><a id=__codelineno-0-2 name=__codelineno-0-2 href=#__codelineno-0-2></a>    <span class=k>def</span><span class=w> </span><span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>num_users</span><span class=p>:</span> <span class=nb>int</span><span class=p>,</span> <span class=n>num_movies</span><span class=p>:</span> <span class=nb>int</span><span class=p>,</span> <span class=n>content_feature_dim</span><span class=p>:</span> <span class=nb>int</span><span class=p>,</span> 
</span><span id=__span-0-3><a id=__codelineno-0-3 name=__codelineno-0-3 href=#__codelineno-0-3></a>                 <span class=n>embedding_dim</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>128</span><span class=p>):</span>
</span><span id=__span-0-4><a id=__codelineno-0-4 name=__codelineno-0-4 href=#__codelineno-0-4></a><span class=w>        </span><span class=sd>&quot;&quot;&quot;</span>
</span><span id=__span-0-5><a id=__codelineno-0-5 name=__codelineno-0-5 href=#__codelineno-0-5></a><span class=sd>        Initialize the two-tower architecture with specified dimensions.</span>
</span><span id=__span-0-6><a id=__codelineno-0-6 name=__codelineno-0-6 href=#__codelineno-0-6></a>
</span><span id=__span-0-7><a id=__codelineno-0-7 name=__codelineno-0-7 href=#__codelineno-0-7></a><span class=sd>        The content_feature_dim parameter reflects our Stage 4 feature engineering:</span>
</span><span id=__span-0-8><a id=__codelineno-0-8 name=__codelineno-0-8 href=#__codelineno-0-8></a><span class=sd>        - 7 numerical features from TMDB metadata</span>
</span><span id=__span-0-9><a id=__codelineno-0-9 name=__codelineno-0-9 href=#__codelineno-0-9></a><span class=sd>        - 16 language one-hot features  </span>
</span><span id=__span-0-10><a id=__codelineno-0-10 name=__codelineno-0-10 href=#__codelineno-0-10></a><span class=sd>        - 5 categorical boolean features</span>
</span><span id=__span-0-11><a id=__codelineno-0-11 name=__codelineno-0-11 href=#__codelineno-0-11></a><span class=sd>        - 768 text embedding features from EmbeddingGemma</span>
</span><span id=__span-0-12><a id=__codelineno-0-12 name=__codelineno-0-12 href=#__codelineno-0-12></a><span class=sd>        Total: 796 content features per movie</span>
</span><span id=__span-0-13><a id=__codelineno-0-13 name=__codelineno-0-13 href=#__codelineno-0-13></a><span class=sd>        &quot;&quot;&quot;</span>
</span><span id=__span-0-14><a id=__codelineno-0-14 name=__codelineno-0-14 href=#__codelineno-0-14></a>        <span class=nb>super</span><span class=p>(</span><span class=n>TwoTowerModel</span><span class=p>,</span> <span class=bp>self</span><span class=p>)</span><span class=o>.</span><span class=fm>__init__</span><span class=p>()</span>
</span><span id=__span-0-15><a id=__codelineno-0-15 name=__codelineno-0-15 href=#__codelineno-0-15></a>
</span><span id=__span-0-16><a id=__codelineno-0-16 name=__codelineno-0-16 href=#__codelineno-0-16></a>        <span class=c1># User tower: processes user IDs into preference embeddings</span>
</span><span id=__span-0-17><a id=__codelineno-0-17 name=__codelineno-0-17 href=#__codelineno-0-17></a>        <span class=bp>self</span><span class=o>.</span><span class=n>user_tower</span> <span class=o>=</span> <span class=n>UserTower</span><span class=p>(</span>
</span><span id=__span-0-18><a id=__codelineno-0-18 name=__codelineno-0-18 href=#__codelineno-0-18></a>            <span class=n>num_users</span><span class=o>=</span><span class=n>num_users</span><span class=p>,</span>
</span><span id=__span-0-19><a id=__codelineno-0-19 name=__codelineno-0-19 href=#__codelineno-0-19></a>            <span class=n>output_dim</span><span class=o>=</span><span class=n>embedding_dim</span>
</span><span id=__span-0-20><a id=__codelineno-0-20 name=__codelineno-0-20 href=#__codelineno-0-20></a>        <span class=p>)</span>
</span><span id=__span-0-21><a id=__codelineno-0-21 name=__codelineno-0-21 href=#__codelineno-0-21></a>
</span><span id=__span-0-22><a id=__codelineno-0-22 name=__codelineno-0-22 href=#__codelineno-0-22></a>        <span class=c1># Item tower: processes movie content features into content embeddings</span>
</span><span id=__span-0-23><a id=__codelineno-0-23 name=__codelineno-0-23 href=#__codelineno-0-23></a>        <span class=bp>self</span><span class=o>.</span><span class=n>item_tower</span> <span class=o>=</span> <span class=n>ItemTower</span><span class=p>(</span>
</span><span id=__span-0-24><a id=__codelineno-0-24 name=__codelineno-0-24 href=#__codelineno-0-24></a>            <span class=n>num_movies</span><span class=o>=</span><span class=n>num_movies</span><span class=p>,</span>
</span><span id=__span-0-25><a id=__codelineno-0-25 name=__codelineno-0-25 href=#__codelineno-0-25></a>            <span class=n>content_feature_dim</span><span class=o>=</span><span class=n>content_feature_dim</span><span class=p>,</span>  <span class=c1># 796 in our case</span>
</span><span id=__span-0-26><a id=__codelineno-0-26 name=__codelineno-0-26 href=#__codelineno-0-26></a>            <span class=n>output_dim</span><span class=o>=</span><span class=n>embedding_dim</span>
</span><span id=__span-0-27><a id=__codelineno-0-27 name=__codelineno-0-27 href=#__codelineno-0-27></a>        <span class=p>)</span>
</span><span id=__span-0-28><a id=__codelineno-0-28 name=__codelineno-0-28 href=#__codelineno-0-28></a>
</span><span id=__span-0-29><a id=__codelineno-0-29 name=__codelineno-0-29 href=#__codelineno-0-29></a>    <span class=k>def</span><span class=w> </span><span class=nf>forward</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>user_ids</span><span class=p>:</span> <span class=n>torch</span><span class=o>.</span><span class=n>Tensor</span><span class=p>,</span> <span class=n>movie_ids</span><span class=p>:</span> <span class=n>torch</span><span class=o>.</span><span class=n>Tensor</span><span class=p>,</span> 
</span><span id=__span-0-30><a id=__codelineno-0-30 name=__codelineno-0-30 href=#__codelineno-0-30></a>                <span class=n>movie_features</span><span class=p>:</span> <span class=n>torch</span><span class=o>.</span><span class=n>Tensor</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>torch</span><span class=o>.</span><span class=n>Tensor</span><span class=p>:</span>
</span><span id=__span-0-31><a id=__codelineno-0-31 name=__codelineno-0-31 href=#__codelineno-0-31></a><span class=w>        </span><span class=sd>&quot;&quot;&quot;</span>
</span><span id=__span-0-32><a id=__codelineno-0-32 name=__codelineno-0-32 href=#__codelineno-0-32></a><span class=sd>        Compute compatibility scores between users and movies.</span>
</span><span id=__span-0-33><a id=__codelineno-0-33 name=__codelineno-0-33 href=#__codelineno-0-33></a>
</span><span id=__span-0-34><a id=__codelineno-0-34 name=__codelineno-0-34 href=#__codelineno-0-34></a><span class=sd>        Mathematical operation: ŕ_ui = e_u^T * e_i</span>
</span><span id=__span-0-35><a id=__codelineno-0-35 name=__codelineno-0-35 href=#__codelineno-0-35></a><span class=sd>        where both embeddings are L2-normalized for cosine similarity.</span>
</span><span id=__span-0-36><a id=__codelineno-0-36 name=__codelineno-0-36 href=#__codelineno-0-36></a><span class=sd>        &quot;&quot;&quot;</span>
</span><span id=__span-0-37><a id=__codelineno-0-37 name=__codelineno-0-37 href=#__codelineno-0-37></a>        <span class=c1># Generate normalized embeddings: ||e_u||_2 = 1, ||e_i||_2 = 1</span>
</span><span id=__span-0-38><a id=__codelineno-0-38 name=__codelineno-0-38 href=#__codelineno-0-38></a>        <span class=n>user_embeddings</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>user_tower</span><span class=p>(</span><span class=n>user_ids</span><span class=p>)</span>
</span><span id=__span-0-39><a id=__codelineno-0-39 name=__codelineno-0-39 href=#__codelineno-0-39></a>        <span class=n>movie_embeddings</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>item_tower</span><span class=p>(</span><span class=n>movie_ids</span><span class=p>,</span> <span class=n>movie_features</span><span class=p>)</span>
</span><span id=__span-0-40><a id=__codelineno-0-40 name=__codelineno-0-40 href=#__codelineno-0-40></a>
</span><span id=__span-0-41><a id=__codelineno-0-41 name=__codelineno-0-41 href=#__codelineno-0-41></a>        <span class=c1># Compute cosine similarity: e_u^T * e_i ∈ [-1, 1]</span>
</span><span id=__span-0-42><a id=__codelineno-0-42 name=__codelineno-0-42 href=#__codelineno-0-42></a>        <span class=n>scores</span> <span class=o>=</span> <span class=n>torch</span><span class=o>.</span><span class=n>sum</span><span class=p>(</span><span class=n>user_embeddings</span> <span class=o>*</span> <span class=n>movie_embeddings</span><span class=p>,</span> <span class=n>dim</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span>
</span><span id=__span-0-43><a id=__codelineno-0-43 name=__codelineno-0-43 href=#__codelineno-0-43></a>
</span><span id=__span-0-44><a id=__codelineno-0-44 name=__codelineno-0-44 href=#__codelineno-0-44></a>        <span class=k>return</span> <span class=n>scores</span>
</span></code></pre></div> <p>The forward pass implements the core mathematical operation <span class=arithmatex>\(\hat{r}_{ui} = \mathbf{e}_u^T \mathbf{e}_i\)</span> that transforms the user-item compatibility problem into geometric similarity calculations in the learned embedding space.</p> <h3 id=data-processing-pipeline>Data Processing Pipeline<a class=headerlink href=#data-processing-pipeline title="Permanent link">&para;</a></h3> <h4 id=feature-preparation>Feature Preparation<a class=headerlink href=#feature-preparation title="Permanent link">&para;</a></h4> <p>The data loader transforms our processed parquet files into tensor format suitable for neural network training. The movie content features undergo careful preprocessing to handle the multi-modal nature of our feature set:</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-1-1><a id=__codelineno-1-1 name=__codelineno-1-1 href=#__codelineno-1-1></a><span class=k>def</span><span class=w> </span><span class=nf>_prepare_movie_features</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span><span id=__span-1-2><a id=__codelineno-1-2 name=__codelineno-1-2 href=#__codelineno-1-2></a><span class=w>    </span><span class=sd>&quot;&quot;&quot;</span>
</span><span id=__span-1-3><a id=__codelineno-1-3 name=__codelineno-1-3 href=#__codelineno-1-3></a><span class=sd>    Convert Stage 4 content features into tensor format.</span>
</span><span id=__span-1-4><a id=__codelineno-1-4 name=__codelineno-1-4 href=#__codelineno-1-4></a>
</span><span id=__span-1-5><a id=__codelineno-1-5 name=__codelineno-1-5 href=#__codelineno-1-5></a><span class=sd>    Feature concatenation order:</span>
</span><span id=__span-1-6><a id=__codelineno-1-6 name=__codelineno-1-6 href=#__codelineno-1-6></a><span class=sd>    1. Numerical features (7 dimensions): budget, revenue, runtime, etc.</span>
</span><span id=__span-1-7><a id=__codelineno-1-7 name=__codelineno-1-7 href=#__codelineno-1-7></a><span class=sd>    2. Language features (16 dimensions): one-hot encoded language preferences  </span>
</span><span id=__span-1-8><a id=__codelineno-1-8 name=__codelineno-1-8 href=#__codelineno-1-8></a><span class=sd>    3. Categorical features (5 dimensions): boolean indicators</span>
</span><span id=__span-1-9><a id=__codelineno-1-9 name=__codelineno-1-9 href=#__codelineno-1-9></a><span class=sd>    4. Text embeddings (768 dimensions): EmbeddingGemma semantic representations</span>
</span><span id=__span-1-10><a id=__codelineno-1-10 name=__codelineno-1-10 href=#__codelineno-1-10></a>
</span><span id=__span-1-11><a id=__codelineno-1-11 name=__codelineno-1-11 href=#__codelineno-1-11></a><span class=sd>    Total dimensionality: 7 + 16 + 5 + 768 = 796</span>
</span><span id=__span-1-12><a id=__codelineno-1-12 name=__codelineno-1-12 href=#__codelineno-1-12></a><span class=sd>    &quot;&quot;&quot;</span>
</span><span id=__span-1-13><a id=__codelineno-1-13 name=__codelineno-1-13 href=#__codelineno-1-13></a>    <span class=c1># Extract and concatenate all feature types</span>
</span><span id=__span-1-14><a id=__codelineno-1-14 name=__codelineno-1-14 href=#__codelineno-1-14></a>    <span class=n>numerical_features</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>movies_df</span><span class=p>[</span><span class=n>numerical_cols</span><span class=p>]</span><span class=o>.</span><span class=n>fillna</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span><span class=o>.</span><span class=n>values</span>
</span><span id=__span-1-15><a id=__codelineno-1-15 name=__codelineno-1-15 href=#__codelineno-1-15></a>    <span class=n>language_features</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>movies_df</span><span class=p>[</span><span class=n>lang_cols</span><span class=p>]</span><span class=o>.</span><span class=n>fillna</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span><span class=o>.</span><span class=n>values</span>  
</span><span id=__span-1-16><a id=__codelineno-1-16 name=__codelineno-1-16 href=#__codelineno-1-16></a>    <span class=n>categorical_features</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>movies_df</span><span class=p>[</span><span class=n>categorical_cols</span><span class=p>]</span><span class=o>.</span><span class=n>fillna</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span><span class=o>.</span><span class=n>values</span>
</span><span id=__span-1-17><a id=__codelineno-1-17 name=__codelineno-1-17 href=#__codelineno-1-17></a>
</span><span id=__span-1-18><a id=__codelineno-1-18 name=__codelineno-1-18 href=#__codelineno-1-18></a>    <span class=c1># Handle text embeddings with fallback for missing values</span>
</span><span id=__span-1-19><a id=__codelineno-1-19 name=__codelineno-1-19 href=#__codelineno-1-19></a>    <span class=n>text_embeddings</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>stack</span><span class=p>([</span>
</span><span id=__span-1-20><a id=__codelineno-1-20 name=__codelineno-1-20 href=#__codelineno-1-20></a>        <span class=n>emb</span> <span class=k>if</span> <span class=n>emb</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span> <span class=k>else</span> <span class=n>np</span><span class=o>.</span><span class=n>zeros</span><span class=p>(</span><span class=mi>768</span><span class=p>)</span> 
</span><span id=__span-1-21><a id=__codelineno-1-21 name=__codelineno-1-21 href=#__codelineno-1-21></a>        <span class=k>for</span> <span class=n>emb</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>movies_df</span><span class=p>[</span><span class=s1>&#39;text_embedding&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>values</span>
</span><span id=__span-1-22><a id=__codelineno-1-22 name=__codelineno-1-22 href=#__codelineno-1-22></a>    <span class=p>])</span>
</span><span id=__span-1-23><a id=__codelineno-1-23 name=__codelineno-1-23 href=#__codelineno-1-23></a>
</span><span id=__span-1-24><a id=__codelineno-1-24 name=__codelineno-1-24 href=#__codelineno-1-24></a>    <span class=c1># Concatenate to create unified content representation</span>
</span><span id=__span-1-25><a id=__codelineno-1-25 name=__codelineno-1-25 href=#__codelineno-1-25></a>    <span class=bp>self</span><span class=o>.</span><span class=n>movie_features</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>concatenate</span><span class=p>([</span>
</span><span id=__span-1-26><a id=__codelineno-1-26 name=__codelineno-1-26 href=#__codelineno-1-26></a>        <span class=n>numerical_features</span><span class=p>,</span> <span class=n>language_features</span><span class=p>,</span> 
</span><span id=__span-1-27><a id=__codelineno-1-27 name=__codelineno-1-27 href=#__codelineno-1-27></a>        <span class=n>categorical_features</span><span class=p>,</span> <span class=n>text_embeddings</span>
</span><span id=__span-1-28><a id=__codelineno-1-28 name=__codelineno-1-28 href=#__codelineno-1-28></a>    <span class=p>],</span> <span class=n>axis</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span>
</span><span id=__span-1-29><a id=__codelineno-1-29 name=__codelineno-1-29 href=#__codelineno-1-29></a>
</span><span id=__span-1-30><a id=__codelineno-1-30 name=__codelineno-1-30 href=#__codelineno-1-30></a>    <span class=bp>self</span><span class=o>.</span><span class=n>movie_features</span> <span class=o>=</span> <span class=n>torch</span><span class=o>.</span><span class=n>FloatTensor</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>movie_features</span><span class=p>)</span>
</span></code></pre></div> <p>This preprocessing strategy preserves the semantic richness developed during our Stage 4 feature engineering while creating the numerical representations required for neural network training.</p> <h4 id=training-example-generation>Training Example Generation<a class=headerlink href=#training-example-generation title="Permanent link">&para;</a></h4> <p>The training data preparation process leverages the clear positive and negative signals in our Netflix thumbs rating system:</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-2-1><a id=__codelineno-2-1 name=__codelineno-2-1 href=#__codelineno-2-1></a><span class=k>def</span><span class=w> </span><span class=nf>_create_training_examples</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span><span id=__span-2-2><a id=__codelineno-2-2 name=__codelineno-2-2 href=#__codelineno-2-2></a><span class=w>    </span><span class=sd>&quot;&quot;&quot;</span>
</span><span id=__span-2-3><a id=__codelineno-2-3 name=__codelineno-2-3 href=#__codelineno-2-3></a><span class=sd>    Generate contrastive learning examples from thumbs ratings.</span>
</span><span id=__span-2-4><a id=__codelineno-2-4 name=__codelineno-2-4 href=#__codelineno-2-4></a>
</span><span id=__span-2-5><a id=__codelineno-2-5 name=__codelineno-2-5 href=#__codelineno-2-5></a><span class=sd>    Positive examples: r_ui ∈ {1.0, 2.0} (thumbs up, two thumbs up)</span>
</span><span id=__span-2-6><a id=__codelineno-2-6 name=__codelineno-2-6 href=#__codelineno-2-6></a><span class=sd>    Negative examples: r_ui = -1.0 (thumbs down) + implicit negatives</span>
</span><span id=__span-2-7><a id=__codelineno-2-7 name=__codelineno-2-7 href=#__codelineno-2-7></a>
</span><span id=__span-2-8><a id=__codelineno-2-8 name=__codelineno-2-8 href=#__codelineno-2-8></a><span class=sd>    The clear semantics eliminate ambiguity in determining preference labels.</span>
</span><span id=__span-2-9><a id=__codelineno-2-9 name=__codelineno-2-9 href=#__codelineno-2-9></a><span class=sd>    &quot;&quot;&quot;</span>
</span><span id=__span-2-10><a id=__codelineno-2-10 name=__codelineno-2-10 href=#__codelineno-2-10></a>    <span class=c1># Explicit positive examples with preference strength</span>
</span><span id=__span-2-11><a id=__codelineno-2-11 name=__codelineno-2-11 href=#__codelineno-2-11></a>    <span class=n>positive_ratings</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>sequences_df</span><span class=p>[</span><span class=bp>self</span><span class=o>.</span><span class=n>sequences_df</span><span class=p>[</span><span class=s1>&#39;thumbs_rating&#39;</span><span class=p>]</span> <span class=o>&gt;=</span> <span class=mf>1.0</span><span class=p>]</span>
</span><span id=__span-2-12><a id=__codelineno-2-12 name=__codelineno-2-12 href=#__codelineno-2-12></a>    <span class=n>positive_examples</span> <span class=o>=</span> <span class=p>[</span>
</span><span id=__span-2-13><a id=__codelineno-2-13 name=__codelineno-2-13 href=#__codelineno-2-13></a>        <span class=p>{</span><span class=s1>&#39;user_idx&#39;</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>user_to_idx</span><span class=p>[</span><span class=n>row</span><span class=p>[</span><span class=s1>&#39;userId&#39;</span><span class=p>]],</span> 
</span><span id=__span-2-14><a id=__codelineno-2-14 name=__codelineno-2-14 href=#__codelineno-2-14></a>         <span class=s1>&#39;movie_idx&#39;</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>movie_to_idx</span><span class=p>[</span><span class=n>row</span><span class=p>[</span><span class=s1>&#39;movieId&#39;</span><span class=p>]],</span> 
</span><span id=__span-2-15><a id=__codelineno-2-15 name=__codelineno-2-15 href=#__codelineno-2-15></a>         <span class=s1>&#39;rating&#39;</span><span class=p>:</span> <span class=n>row</span><span class=p>[</span><span class=s1>&#39;thumbs_rating&#39;</span><span class=p>]}</span>
</span><span id=__span-2-16><a id=__codelineno-2-16 name=__codelineno-2-16 href=#__codelineno-2-16></a>        <span class=k>for</span> <span class=n>_</span><span class=p>,</span> <span class=n>row</span> <span class=ow>in</span> <span class=n>positive_ratings</span><span class=o>.</span><span class=n>iterrows</span><span class=p>()</span>
</span><span id=__span-2-17><a id=__codelineno-2-17 name=__codelineno-2-17 href=#__codelineno-2-17></a>    <span class=p>]</span>
</span><span id=__span-2-18><a id=__codelineno-2-18 name=__codelineno-2-18 href=#__codelineno-2-18></a>
</span><span id=__span-2-19><a id=__codelineno-2-19 name=__codelineno-2-19 href=#__codelineno-2-19></a>    <span class=c1># Explicit negative examples  </span>
</span><span id=__span-2-20><a id=__codelineno-2-20 name=__codelineno-2-20 href=#__codelineno-2-20></a>    <span class=n>negative_ratings</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>sequences_df</span><span class=p>[</span><span class=bp>self</span><span class=o>.</span><span class=n>sequences_df</span><span class=p>[</span><span class=s1>&#39;thumbs_rating&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=o>-</span><span class=mf>1.0</span><span class=p>]</span>
</span><span id=__span-2-21><a id=__codelineno-2-21 name=__codelineno-2-21 href=#__codelineno-2-21></a>    <span class=n>negative_examples</span> <span class=o>=</span> <span class=p>[</span>
</span><span id=__span-2-22><a id=__codelineno-2-22 name=__codelineno-2-22 href=#__codelineno-2-22></a>        <span class=p>{</span><span class=s1>&#39;user_idx&#39;</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>user_to_idx</span><span class=p>[</span><span class=n>row</span><span class=p>[</span><span class=s1>&#39;userId&#39;</span><span class=p>]],</span> 
</span><span id=__span-2-23><a id=__codelineno-2-23 name=__codelineno-2-23 href=#__codelineno-2-23></a>         <span class=s1>&#39;movie_idx&#39;</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>movie_to_idx</span><span class=p>[</span><span class=n>row</span><span class=p>[</span><span class=s1>&#39;movieId&#39;</span><span class=p>]],</span> 
</span><span id=__span-2-24><a id=__codelineno-2-24 name=__codelineno-2-24 href=#__codelineno-2-24></a>         <span class=s1>&#39;rating&#39;</span><span class=p>:</span> <span class=o>-</span><span class=mf>1.0</span><span class=p>}</span>
</span><span id=__span-2-25><a id=__codelineno-2-25 name=__codelineno-2-25 href=#__codelineno-2-25></a>        <span class=k>for</span> <span class=n>_</span><span class=p>,</span> <span class=n>row</span> <span class=ow>in</span> <span class=n>negative_ratings</span><span class=o>.</span><span class=n>iterrows</span><span class=p>()</span>
</span><span id=__span-2-26><a id=__codelineno-2-26 name=__codelineno-2-26 href=#__codelineno-2-26></a>    <span class=p>]</span>
</span><span id=__span-2-27><a id=__codelineno-2-27 name=__codelineno-2-27 href=#__codelineno-2-27></a>
</span><span id=__span-2-28><a id=__codelineno-2-28 name=__codelineno-2-28 href=#__codelineno-2-28></a>    <span class=c1># Implicit negative sampling for balance</span>
</span><span id=__span-2-29><a id=__codelineno-2-29 name=__codelineno-2-29 href=#__codelineno-2-29></a>    <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>negative_examples</span><span class=p>)</span> <span class=o>&lt;</span> <span class=nb>len</span><span class=p>(</span><span class=n>positive_examples</span><span class=p>)</span> <span class=o>*</span> <span class=mf>0.3</span><span class=p>:</span>
</span><span id=__span-2-30><a id=__codelineno-2-30 name=__codelineno-2-30 href=#__codelineno-2-30></a>        <span class=bp>self</span><span class=o>.</span><span class=n>_generate_implicit_negatives</span><span class=p>(</span><span class=n>positive_examples</span><span class=p>,</span> <span class=n>negative_examples</span><span class=p>)</span>
</span></code></pre></div> <p>The Netflix thumbs rating system eliminates the threshold ambiguity that complicates traditional rating systems, providing clear training signals that improve model learning effectiveness.</p> <h2 id=mathematical-properties-and-theoretical-foundations>Mathematical Properties and Theoretical Foundations<a class=headerlink href=#mathematical-properties-and-theoretical-foundations title="Permanent link">&para;</a></h2> <h3 id=embedding-space-geometry>Embedding Space Geometry<a class=headerlink href=#embedding-space-geometry title="Permanent link">&para;</a></h3> <p>The learned embedding space exhibits geometric properties that reflect user preference patterns. Users with similar tastes cluster in regions of the embedding space, while items that appeal to similar user segments occupy nearby positions. The mathematical relationship between embedding similarity and preference compatibility enables collaborative filtering through geometric reasoning.</p> <p>The normalization constraint <span class=arithmatex>\(\|\mathbf{e}_u\|_2 = \|\mathbf{e}_i\|_2 = 1\)</span> creates embeddings on the unit hypersphere <span class=arithmatex>\(\mathbb{S}^{d-1}\)</span>. This geometric structure provides several theoretical advantages:</p> <ol> <li><strong>Bounded similarity scores</strong>: <span class=arithmatex>\(\mathbf{e}_u^T \mathbf{e}_i \in [-1, 1]\)</span> provides interpretable compatibility measures</li> <li><strong>Angular interpretation</strong>: The embedding angle <span class=arithmatex>\(\theta_{ui} = \arccos(\mathbf{e}_u^T \mathbf{e}_i)\)</span> represents preference distance</li> <li><strong>Stable optimization</strong>: The constrained parameter space reduces optimization instability</li> </ol> <h3 id=collaborative-filtering-through-matrix-factorization>Collaborative Filtering Through Matrix Factorization<a class=headerlink href=#collaborative-filtering-through-matrix-factorization title="Permanent link">&para;</a></h3> <p>The two-tower architecture generalizes traditional matrix factorization approaches. Consider the user-item interaction matrix <span class=arithmatex>\(\mathbf{R} \in \mathbb{R}^{|U| \times |I|}\)</span>. Matrix factorization seeks low-rank decomposition:</p> <div class=arithmatex>\[\mathbf{R} \approx \mathbf{U}\mathbf{V}^T\]</div> <p>where <span class=arithmatex>\(\mathbf{U} \in \mathbb{R}^{|U| \times d}\)</span> contains user factors and <span class=arithmatex>\(\mathbf{V} \in \mathbb{R}^{|I| \times d}\)</span> contains item factors.</p> <p>The two-tower model extends this framework by learning non-linear transformations:</p> <div class=arithmatex>\[\mathbf{U} = f_{\text{user}}(\mathbf{X}_{\text{user}}; \Theta_u)$$ $$\mathbf{V} = f_{\text{item}}(\mathbf{X}_{\text{item}}; \Theta_i)\]</div> <p>where <span class=arithmatex>\(\mathbf{X}_{\text{user}}\)</span> and <span class=arithmatex>\(\mathbf{X}_{\text{item}}\)</span> represent user and item features respectively. This generalization enables the incorporation of rich side information while maintaining the computational benefits of factorized representations.</p> <h3 id=content-collaborative-hybridization>Content-Collaborative Hybridization<a class=headerlink href=#content-collaborative-hybridization title="Permanent link">&para;</a></h3> <p>Our implementation achieves hybridization between collaborative filtering and content-based recommendation through the item tower architecture. The mathematical formulation:</p> <div class=arithmatex>\[\mathbf{e}_i = f_{\text{item}}([\mathbf{w}_i; \mathbf{c}_i]; \Theta_i)\]</div> <p>combines learned item embeddings <span class=arithmatex>\(\mathbf{w}_i\)</span> with explicit content features <span class=arithmatex>\(\mathbf{c}_i\)</span>. This approach enables the model to leverage both collaborative signals from user interaction patterns and content signals from item characteristics.</p> <p>The hybrid approach addresses key limitations of pure collaborative filtering approaches: - <strong>Cold start problem</strong>: New items can receive recommendations based on content similarity - <strong>Sparsity handling</strong>: Content features provide signals for items with few interactions - <strong>Explainability</strong>: Content features enable interpretation of recommendation rationales</p> <h2 id=computational-complexity-and-scalability-analysis>Computational Complexity and Scalability Analysis<a class=headerlink href=#computational-complexity-and-scalability-analysis title="Permanent link">&para;</a></h2> <h3 id=training-complexity>Training Complexity<a class=headerlink href=#training-complexity title="Permanent link">&para;</a></h3> <p>The training process exhibits computational complexity that scales with the dataset size and model architecture. For a training batch of size <span class=arithmatex>\(B\)</span> containing user-item pairs:</p> <ul> <li><strong>Forward pass</strong>: <span class=arithmatex>\(O(B \cdot d \cdot H)\)</span> where <span class=arithmatex>\(H\)</span> represents the total number of hidden units</li> <li><strong>Backward pass</strong>: <span class=arithmatex>\(O(B \cdot d \cdot H)\)</span> for gradient computation</li> <li><strong>Parameter updates</strong>: <span class=arithmatex>\(O(|\Theta|)\)</span> where <span class=arithmatex>\(|\Theta|\)</span> is the total parameter count</li> </ul> <p>The per-epoch complexity scales as <span class=arithmatex>\(O(N \cdot d \cdot H)\)</span> where <span class=arithmatex>\(N\)</span> represents the number of training examples. This linear scaling enables training on large datasets with appropriate computational resources.</p> <h3 id=inference-complexity>Inference Complexity<a class=headerlink href=#inference-complexity title="Permanent link">&para;</a></h3> <p>The two-tower architecture provides crucial advantages during inference:</p> <ol> <li><strong>Item embedding pre-computation</strong>: <span class=arithmatex>\(O(|I| \cdot d \cdot H_{\text{item}})\)</span> one-time cost</li> <li><strong>User embedding computation</strong>: <span class=arithmatex>\(O(d \cdot H_{\text{user}})\)</span> per recommendation request</li> <li><strong>Similarity calculation</strong>: <span class=arithmatex>\(O(|I| \cdot d)\)</span> dot products against cached embeddings</li> </ol> <p>The total inference complexity becomes <span class=arithmatex>\(O(d \cdot H_{\text{user}} + |I| \cdot d)\)</span>, which scales linearly with catalog size rather than quadratically as in naive approaches.</p> <h3 id=memory-requirements>Memory Requirements<a class=headerlink href=#memory-requirements title="Permanent link">&para;</a></h3> <p>The memory footprint includes several components:</p> <ul> <li><strong>User embeddings</strong>: <span class=arithmatex>\(O(|U| \cdot d)\)</span> parameters</li> <li><strong>Item embeddings</strong>: <span class=arithmatex>\(O(|I| \cdot d)\)</span> parameters </li> <li><strong>Network weights</strong>: <span class=arithmatex>\(O(H^2)\)</span> for fully connected layers</li> <li><strong>Cached item embeddings</strong>: <span class=arithmatex>\(O(|I| \cdot d)\)</span> for inference serving</li> </ul> <p>For our implementation with <span class=arithmatex>\(|U| = 75,000\)</span>, <span class=arithmatex>\(|I| = 80,000\)</span>, and <span class=arithmatex>\(d = 128\)</span>, the embedding parameters require approximately 25MB of memory, demonstrating the efficiency of the factorized representation.</p> <h2 id=integration-with-existing-pipeline-architecture>Integration with Existing Pipeline Architecture<a class=headerlink href=#integration-with-existing-pipeline-architecture title="Permanent link">&para;</a></h2> <h3 id=dvc-pipeline-extension>DVC Pipeline Extension<a class=headerlink href=#dvc-pipeline-extension title="Permanent link">&para;</a></h3> <p>The two-tower model integrates seamlessly with our existing DVC pipeline by consuming the processed datasets from Stage 4 and producing trained model artifacts for subsequent stages:</p> <div class="language-yaml highlight"><pre><span></span><code><span id=__span-3-1><a id=__codelineno-3-1 name=__codelineno-3-1 href=#__codelineno-3-1></a><span class=nt>stages</span><span class=p>:</span>
</span><span id=__span-3-2><a id=__codelineno-3-2 name=__codelineno-3-2 href=#__codelineno-3-2></a><span class=w>  </span><span class=c1># Existing stages</span>
</span><span id=__span-3-3><a id=__codelineno-3-3 name=__codelineno-3-3 href=#__codelineno-3-3></a><span class=w>  </span><span class=nt>content_features</span><span class=p>:</span>
</span><span id=__span-3-4><a id=__codelineno-3-4 name=__codelineno-3-4 href=#__codelineno-3-4></a><span class=w>    </span><span class=nt>cmd</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">python scripts/extract_tmdb_features.py</span>
</span><span id=__span-3-5><a id=__codelineno-3-5 name=__codelineno-3-5 href=#__codelineno-3-5></a><span class=w>    </span><span class=nt>outs</span><span class=p>:</span>
</span><span id=__span-3-6><a id=__codelineno-3-6 name=__codelineno-3-6 href=#__codelineno-3-6></a><span class=w>      </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">data/processed/movies_with_content_features.parquet</span>
</span><span id=__span-3-7><a id=__codelineno-3-7 name=__codelineno-3-7 href=#__codelineno-3-7></a>
</span><span id=__span-3-8><a id=__codelineno-3-8 name=__codelineno-3-8 href=#__codelineno-3-8></a><span class=w>  </span><span class=c1># New two-tower training stage</span>
</span><span id=__span-3-9><a id=__codelineno-3-9 name=__codelineno-3-9 href=#__codelineno-3-9></a><span class=w>  </span><span class=nt>two_tower_training</span><span class=p>:</span>
</span><span id=__span-3-10><a id=__codelineno-3-10 name=__codelineno-3-10 href=#__codelineno-3-10></a><span class=w>    </span><span class=nt>cmd</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">python scripts/train_two_tower.py</span>
</span><span id=__span-3-11><a id=__codelineno-3-11 name=__codelineno-3-11 href=#__codelineno-3-11></a><span class=w>    </span><span class=nt>deps</span><span class=p>:</span>
</span><span id=__span-3-12><a id=__codelineno-3-12 name=__codelineno-3-12 href=#__codelineno-3-12></a><span class=w>      </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">data/processed/sequences_with_metadata.parquet</span>
</span><span id=__span-3-13><a id=__codelineno-3-13 name=__codelineno-3-13 href=#__codelineno-3-13></a><span class=w>      </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">data/processed/movies_with_content_features.parquet</span>
</span><span id=__span-3-14><a id=__codelineno-3-14 name=__codelineno-3-14 href=#__codelineno-3-14></a><span class=w>      </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">configs/two_tower_config.yaml</span>
</span><span id=__span-3-15><a id=__codelineno-3-15 name=__codelineno-3-15 href=#__codelineno-3-15></a><span class=w>    </span><span class=nt>outs</span><span class=p>:</span>
</span><span id=__span-3-16><a id=__codelineno-3-16 name=__codelineno-3-16 href=#__codelineno-3-16></a><span class=w>      </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">models/two_tower_model.pth</span>
</span><span id=__span-3-17><a id=__codelineno-3-17 name=__codelineno-3-17 href=#__codelineno-3-17></a><span class=w>      </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">data/processed/movie_embeddings.parquet</span>
</span><span id=__span-3-18><a id=__codelineno-3-18 name=__codelineno-3-18 href=#__codelineno-3-18></a><span class=w>    </span><span class=nt>metrics</span><span class=p>:</span>
</span><span id=__span-3-19><a id=__codelineno-3-19 name=__codelineno-3-19 href=#__codelineno-3-19></a><span class=w>      </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">metrics/two_tower_metrics.json</span>
</span></code></pre></div> <p>This pipeline structure maintains reproducibility while enabling iterative model development and hyperparameter experimentation.</p> <h3 id=feature-engineering-integration>Feature Engineering Integration<a class=headerlink href=#feature-engineering-integration title="Permanent link">&para;</a></h3> <p>The two-tower model leverages the comprehensive feature engineering developed during Stage 4, demonstrating how careful data preparation pays dividends during model training. The rich content features enable the model to learn sophisticated item representations that combine explicit content characteristics with latent collaborative filtering factors.</p> <p>The integration strategy preserves the semantic richness of our multi-modal feature set: - TMDB numerical features provide explicit content characteristics - Language features capture cultural and linguistic preferences<br> - Text embeddings from EmbeddingGemma contribute semantic understanding - Categorical features indicate production characteristics</p> <p>This feature diversity enables the model to capture multiple dimensions of user preference that pure collaborative filtering approaches might miss.</p> <h2 id=evaluation-framework-and-success-metrics>Evaluation Framework and Success Metrics<a class=headerlink href=#evaluation-framework-and-success-metrics title="Permanent link">&para;</a></h2> <h3 id=retrieval-quality-metrics>Retrieval Quality Metrics<a class=headerlink href=#retrieval-quality-metrics title="Permanent link">&para;</a></h3> <p>The two-tower model serves as the first stage in a multi-stage recommendation pipeline, making retrieval quality the primary evaluation focus. Key metrics include:</p> <p><strong>Recall at K</strong>: Measures the proportion of relevant items included in the top-K retrieved candidates:</p> <div class=arithmatex>\[\text{Recall@K} = \frac{|\{i \in \text{Top-K}(u) : r_{ui} \geq \tau\}|}{|\{i : r_{ui} \geq \tau\}|}\]</div> <p>where <span class=arithmatex>\(\tau\)</span> represents the relevance threshold (e.g., <span class=arithmatex>\(\tau = 1.0\)</span> for thumbs up ratings).</p> <p><strong>Coverage</strong>: Evaluates the diversity of retrieved candidates across the item catalog:</p> <div class=arithmatex>\[\text{Coverage} = \frac{|\bigcup_{u} \text{Top-K}(u)|}{|I|}\]</div> <p>Higher coverage indicates that the model can recommend diverse content rather than focusing on popular items.</p> <h3 id=computational-performance-metrics>Computational Performance Metrics<a class=headerlink href=#computational-performance-metrics title="Permanent link">&para;</a></h3> <p>Production deployment requires monitoring computational characteristics:</p> <ul> <li><strong>Embedding generation latency</strong>: Time to compute user embeddings</li> <li><strong>Similarity calculation throughput</strong>: Candidates evaluated per second </li> <li><strong>Memory utilization</strong>: RAM requirements for cached embeddings</li> <li><strong>Model loading time</strong>: Initialization cost for serving systems</li> </ul> <p>These metrics ensure that the model meets the sub-200ms latency requirements for interactive recommendation serving.</p> <h2 id=production-deployment-considerations>Production Deployment Considerations<a class=headerlink href=#production-deployment-considerations title="Permanent link">&para;</a></h2> <h3 id=embedding-caching-strategy>Embedding Caching Strategy<a class=headerlink href=#embedding-caching-strategy title="Permanent link">&para;</a></h3> <p>The production architecture requires careful design of the embedding caching system to achieve target latency requirements. Movie embeddings can be pre-computed and stored in fast key-value stores, while user embeddings might be computed on demand or cached with appropriate expiration policies.</p> <h3 id=model-update-pipeline>Model Update Pipeline<a class=headerlink href=#model-update-pipeline title="Permanent link">&para;</a></h3> <p>The two-tower model enables flexible update strategies: - <strong>Full retraining</strong>: Periodic complete model updates using accumulated interaction data - <strong>Incremental updates</strong>: Online learning approaches for user embedding adaptation - <strong>A/B testing</strong>: Gradual rollout of model improvements with performance monitoring</p> <h3 id=scalability-architecture>Scalability Architecture<a class=headerlink href=#scalability-architecture title="Permanent link">&para;</a></h3> <p>The two-tower design naturally supports horizontal scaling through distributed serving architectures. User embedding computation can be distributed across multiple workers, while cached item embeddings can be replicated across serving nodes for redundancy and load distribution.</p> <h2 id=conclusion-and-future-directions>Conclusion and Future Directions<a class=headerlink href=#conclusion-and-future-directions title="Permanent link">&para;</a></h2> <p>The two-tower model provides a mathematically principled and computationally efficient foundation for scalable recommendation systems. Our implementation successfully integrates collaborative filtering principles with rich content features through neural network architectures that learn meaningful embedding representations of users and movies.</p> <p>The mathematical framework underlying the two-tower approach demonstrates how geometric reasoning in learned embedding spaces can encode complex preference patterns while maintaining the computational efficiency required for real-time serving. The clear semantics of our Netflix thumbs rating system eliminate many of the ambiguities that complicate traditional recommendation system development.</p> <p>Future enhancements might explore advanced architectures such as attention mechanisms for dynamic user preference modeling, multi-task learning objectives that optimize for multiple recommendation quality metrics simultaneously, or federated learning approaches that enable personalization while preserving user privacy.</p> <p>The solid foundation provided by this two-tower implementation positions the Movie Genie system for sophisticated extensions including sequential recommendation modeling, graph-based relationship reasoning, and natural language query understanding through the RAG system we have planned for later development stages.</p> <aside class=md-source-file> <span class=md-source-file__fact> <span class=md-icon title="Last update"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M21 13.1c-.1 0-.3.1-.4.2l-1 1 2.1 2.1 1-1c.2-.2.2-.6 0-.8l-1.3-1.3c-.1-.1-.2-.2-.4-.2m-1.9 1.8-6.1 6V23h2.1l6.1-6.1zM12.5 7v5.2l4 2.4-1 1L11 13V7zM11 21.9c-5.1-.5-9-4.8-9-9.9C2 6.5 6.5 2 12 2c5.3 0 9.6 4.1 10 9.3-.3-.1-.6-.2-1-.2s-.7.1-1 .2C19.6 7.2 16.2 4 12 4c-4.4 0-8 3.6-8 8 0 4.1 3.1 7.5 7.1 7.9l-.1.2z"/></svg> </span> <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-date" title="September 26, 2025 18:54:36 UTC">September 26, 2025</span> </span> <span class=md-source-file__fact> <span class=md-icon title=Created> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M14.47 15.08 11 13V7h1.5v5.25l3.08 1.83c-.41.28-.79.62-1.11 1m-1.39 4.84c-.36.05-.71.08-1.08.08-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8c0 .37-.03.72-.08 1.08.69.1 1.33.32 1.92.64.1-.56.16-1.13.16-1.72 0-5.5-4.5-10-10-10S2 6.5 2 12s4.47 10 10 10c.59 0 1.16-.06 1.72-.16-.32-.59-.54-1.23-.64-1.92M18 15v3h-3v2h3v3h2v-3h3v-2h-3v-3z"/></svg> </span> <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-date" title="September 26, 2025 18:54:36 UTC">September 26, 2025</span> </span> </aside> </article> </div> <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var labels=set.querySelector(".tabbed-labels");for(var tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script> <script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script> </div> <button type=button class="md-top md-icon" data-md-component=top hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg> Back to top </button> </main> <footer class=md-footer> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-copyright> <div class=md-copyright__highlight> Copyright &copy; 2024 Movie Genie </div> Made with <a href=https://squidfunk.github.io/mkdocs-material/ target=_blank rel=noopener> Material for MkDocs </a> </div> <div class=md-social> <a href=https://github.com/your-username/movie-genie target=_blank rel=noopener title=github.com class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 512 512"><!-- Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg> </a> <a href=https://pypi.org/project/movie-genie/ target=_blank rel=noopener title=pypi.org class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.8 200.5c-7.7-30.9-22.3-54.2-53.4-54.2h-40.1v47.4c0 36.8-31.2 67.8-66.8 67.8H172.7c-29.2 0-53.4 25-53.4 54.3v101.8c0 29 25.2 46 53.4 54.3 33.8 9.9 66.3 11.7 106.8 0 26.9-7.8 53.4-23.5 53.4-54.3v-40.7H226.2v-13.6h160.2c31.1 0 42.6-21.7 53.4-54.2 11.2-33.5 10.7-65.7 0-108.6M286.2 444.7a20.4 20.4 0 1 1 0-40.7 20.4 20.4 0 1 1 0 40.7M167.8 248.1h106.8c29.7 0 53.4-24.5 53.4-54.3V91.9c0-29-24.4-50.7-53.4-55.6-35.8-5.9-74.7-5.6-106.8.1-45.2 8-53.4 24.7-53.4 55.6v40.7h106.9v13.6h-147c-31.1 0-58.3 18.7-66.8 54.2-9.8 40.7-10.2 66.1 0 108.6 7.6 31.6 25.7 54.2 56.8 54.2H101v-48.8c0-35.3 30.5-66.4 66.8-66.4m-6.6-183.4a20.4 20.4 0 1 1 0 40.8 20.4 20.4 0 1 1 0-40.8"/></svg> </a> <a href=https://twitter.com/your-username target=_blank rel=noopener title=twitter.com class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 512 512"><!-- Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M459.4 151.7c.3 4.5.3 9.1.3 13.6 0 138.7-105.6 298.6-298.6 298.6-59.5 0-114.7-17.2-161.1-47.1 8.4 1 16.6 1.3 25.3 1.3 49.1 0 94.2-16.6 130.3-44.8-46.1-1-84.8-31.2-98.1-72.8 6.5 1 13 1.6 19.8 1.6 9.4 0 18.8-1.3 27.6-3.6-48.1-9.7-84.1-52-84.1-103v-1.3c14 7.8 30.2 12.7 47.4 13.3-28.3-18.8-46.8-51-46.8-87.4 0-19.5 5.2-37.4 14.3-53C87.4 130.8 165 172.4 252.1 176.9c-1.6-7.8-2.6-15.9-2.6-24C249.5 95.1 296.3 48 354.4 48c30.2 0 57.5 12.7 76.7 33.1 23.7-4.5 46.5-13.3 66.6-25.3-7.8 24.4-24.4 44.8-46.1 57.8 21.1-2.3 41.6-8.1 60.4-16.2-14.3 20.8-32.2 39.3-52.6 54.3"/></svg> </a> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <div class=md-progress data-md-component=progress role=progressbar></div> <script id=__config type=application/json>{"base": "../..", "features": ["announce.dismiss", "content.action.edit", "content.action.view", "content.code.annotate", "content.code.copy", "content.code.select", "content.tabs.link", "content.tooltips", "header.autohide", "navigation.expand", "navigation.footer", "navigation.indexes", "navigation.instant", "navigation.instant.prefetch", "navigation.instant.progress", "navigation.prune", "navigation.sections", "navigation.tabs", "navigation.tabs.sticky", "navigation.top", "navigation.tracking", "search.highlight", "search.share", "search.suggest", "toc.follow"], "search": "../../assets/javascripts/workers/search.973d3a69.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script> <script src=../../assets/javascripts/bundle.f55a23d4.min.js></script> <script src=../../javascripts/mathjax.js></script> <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script> </body> </html>