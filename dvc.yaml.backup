stages:
  ingest:
    cmd: python scripts/ingest_data.py
    deps:
    - data/raw/${data.data_sources.movielens.dataset_size}/ratings.csv
    - configs/data.yaml
    - movie_genie/data/loaders.py
    params:
    - data.data_sources.movielens.dataset_size
    outs:
    - data/interim/thumbs_ratings.parquet

  sequential_processing:
    cmd: python scripts/process_sequential_data.py
    deps:
    - data/interim/thumbs_ratings.parquet
    - movie_genie/data/loaders.py
    - configs/data.yaml
    params:
    - data.data_sources.movielens.dataset_size
    outs:
    - data/processed/sequences_with_metadata.parquet
    - data/processed/user_windows.parquet

  content_features:
    cmd: python scripts/extract_content_features.py
    deps:
    - data/raw/tmdb/TMDB_movie_dataset_v11.csv
    - data/raw/${data.data_sources.movielens.dataset_size}/links.csv
    - configs/data.yaml
    params:
    - data.data_sources.movielens.dataset_size
    outs:
    - data/processed/content_features.parquet

  two_tower_training:
    cmd: python scripts/train_two_tower.py --config configs/two_tower.yaml --mlflow-config configs/mlflow.yaml
    deps:
    - data/processed/sequences_with_metadata.parquet
    - data/processed/content_features.parquet
    - configs/two_tower.yaml
    - configs/mlflow.yaml
    - movie_genie/retrieval/two_tower_model.py
    - scripts/train_two_tower.py
    params:
    - two_tower.training.learning_rate
    - two_tower.training.num_epochs
    - two_tower.model.embedding_dim
    outs:
    - models/two_tower/
    - data/processed/movie_embeddings.parquet
    metrics:
    - metrics/two_tower_metrics.json

  bert4rec_training:
    cmd: python scripts/train_bert4rec.py --config configs/bert4rec.yaml --mlflow-config configs/mlflow.yaml
    deps:
    - data/processed/sequences_with_metadata.parquet
    - data/processed/content_features.parquet
    - configs/bert4rec.yaml
    - configs/mlflow.yaml
    - movie_genie/ranking/bert4rec_model.py
    - scripts/train_bert4rec.py
    params:
    - bert4rec.model.hidden_dim
    - bert4rec.model.num_layers
    - bert4rec.training.learning_rate
    - bert4rec.training.mask_prob
    outs:
    - models/bert4rec/
    metrics:
    - metrics/bert4rec_metrics.json

  integrated_evaluation:
    cmd: python scripts/evaluate_integrated_system.py
    deps:
    - models/two_tower/
    - models/bert4rec/
    - data/processed/sequences_with_metadata.parquet
    - data/processed/content_features.parquet
    - configs/evaluation.yaml
    - scripts/evaluate_integrated_system.py
    outs:
    - results/integrated_system_evaluation.json
    - results/key_metrics.json

  frontend_build:
    cmd: >
      cd movie_genie/frontend && npm run build &&
      cp ../backend/dist/index.html ../backend/templates/ &&
      mkdir -p ../backend/static &&
      cp -r ../backend/dist/css ../backend/static/ &&
      cp -r ../backend/dist/js ../backend/static/ &&
      [ -d ../backend/dist/img ] && cp -r ../backend/dist/img ../backend/static/ || true &&
      [ -d ../backend/dist/assets ] && cp -r ../backend/dist/assets ../backend/static/ || true
    deps:
    - movie_genie/frontend/src/
    - movie_genie/frontend/package.json
    - movie_genie/frontend/vite.config.ts
    - movie_genie/frontend/index.html
    - movie_genie/frontend/tailwind.config.ts
    outs:
    - movie_genie/backend/templates/index.html
    - movie_genie/backend/static/
    always_changed: true

  backend_server:
    cmd: FLASK_PORT=5001 python scripts/start_server.py
    deps:
    - movie_genie/backend/app.py
    - movie_genie/backend/config.py
    - movie_genie/backend/app/
    - movie_genie/backend/templates/index.html
    - movie_genie/backend/static/
    - models/two_tower/
    - models/bert4rec/
    - data/processed/content_features.parquet
    - data/processed/sequences_with_metadata.parquet
    - configs/semantic_search.yaml
    always_changed: true

  mlflow_ui:
    cmd: mlflow ui --host 127.0.0.1 --port 5002
    deps:
    - mlruns/
    - configs/mlflow.yaml
    always_changed: true

  docs_server:
    cmd: mkdocs serve
    deps:
    - mkdocs.yml
    - docs/
    always_changed: true
